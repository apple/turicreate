
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Deployment to Core ML Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="how-it-works.html" />
    
    
    <link rel="prev" href="advanced-usage.html" />
    

    <script src="../turi/js/jquery/jquery-2.1.3.min.js"></script>
    <script src="../turi/js/d3/d3.min.js"></script>
    <script src="../supervised-learning/images/random-utils.js"></script>
    <script src="../supervised-learning/images/plotting-utils.js"></script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../sframe/">
            
                <a href="../sframe/">
            
                    
                    Working with data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../sframe/tabular-data.html">
            
                <a href="../sframe/tabular-data.html">
            
                    
                    Tabular data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../sframe/sframe-intro.html">
            
                <a href="../sframe/sframe-intro.html">
            
                    
                    Loading and Saving
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../sframe/data-manipulation.html">
            
                <a href="../sframe/data-manipulation.html">
            
                    
                    Data Manipulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="../data_formats_and_sources/sql_integration.html">
            
                <a href="../data_formats_and_sources/sql_integration.html">
            
                    
                    SQL Databases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../sgraph/sgraph.html">
            
                <a href="../sgraph/sgraph.html">
            
                    
                    Graph data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../text/analysis.html">
            
                <a href="../text/analysis.html">
            
                    
                    Text data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../vis/">
            
                <a href="../vis/">
            
                    
                    Visualization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../vis/gallery.html">
            
                <a href="../vis/gallery.html">
            
                    
                    Example Gallery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../vis/use_cases.html">
            
                <a href="../vis/use_cases.html">
            
                    
                    Sample Use Cases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../applications/">
            
                <a href="../applications/">
            
                    
                    Task focused toolkits
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../recommender/">
            
                <a href="../recommender/">
            
                    
                    Recommender Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../recommender/using-trained-models.html">
            
                <a href="../recommender/using-trained-models.html">
            
                    
                    Using models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../recommender/choosing-a-model.html">
            
                <a href="../recommender/choosing-a-model.html">
            
                    
                    Choosing a model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../recommender/coreml-deployment.html">
            
                <a href="../recommender/coreml-deployment.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../image_classifier/">
            
                <a href="../image_classifier/">
            
                    
                    Image Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../image_classifier/advanced-usage.html">
            
                <a href="../image_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../image_classifier/how-it-works.html">
            
                <a href="../image_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="../image_classifier/export-coreml.html">
            
                <a href="../image_classifier/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../drawing_classifier/">
            
                <a href="../drawing_classifier/">
            
                    
                    Drawing Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="../drawing_classifier/how-it-works.html">
            
                <a href="../drawing_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="../drawing_classifier/data-preparation.html">
            
                <a href="../drawing_classifier/data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="../drawing_classifier/export-coreml.html">
            
                <a href="../drawing_classifier/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="../drawing_classifier/advanced-usage.html">
            
                <a href="../drawing_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../sound_classifier/">
            
                <a href="../sound_classifier/">
            
                    
                    Sound Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="../sound_classifier/how-it-works.html">
            
                <a href="../sound_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.2" data-path="../sound_classifier/advanced-usage.html">
            
                <a href="../sound_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.3" data-path="../sound_classifier/export-coreml.html">
            
                <a href="../sound_classifier/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../image_similarity/">
            
                <a href="../image_similarity/">
            
                    
                    Image Similarity
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../image_similarity/export-coreml.html">
            
                <a href="../image_similarity/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="./">
            
                <a href="./">
            
                    
                    Object Detection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.6.1" data-path="data-preparation.html">
            
                <a href="data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6.2" data-path="advanced-usage.html">
            
                <a href="advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.6.3" data-path="export-coreml.html">
            
                <a href="export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6.4" data-path="how-it-works.html">
            
                <a href="how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../one_shot_object_detection/">
            
                <a href="../one_shot_object_detection/">
            
                    
                    One-Shot Object Detection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../style_transfer/">
            
                <a href="../style_transfer/">
            
                    
                    Style Transfer
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.8.1" data-path="../style_transfer/how-it-works.html">
            
                <a href="../style_transfer/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8.2" data-path="../style_transfer/export-coreml.html">
            
                <a href="../style_transfer/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../activity_classifier/">
            
                <a href="../activity_classifier/">
            
                    
                    Activity Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.9.1" data-path="../activity_classifier/data-preparation.html">
            
                <a href="../activity_classifier/data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.2" data-path="../activity_classifier/advanced-usage.html">
            
                <a href="../activity_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.3" data-path="../activity_classifier/export_coreml.html">
            
                <a href="../activity_classifier/export_coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.4" data-path="../activity_classifier/how-it-works.html">
            
                <a href="../activity_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../text_classifier/">
            
                <a href="../text_classifier/">
            
                    
                    Text Classifier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../modeling-data/">
            
                <a href="../modeling-data/">
            
                    
                    Machine learning essentials
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../supervised-learning/classifier.html">
            
                <a href="../supervised-learning/classifier.html">
            
                    
                    Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../supervised-learning/boosted_trees_classifier.html">
            
                <a href="../supervised-learning/boosted_trees_classifier.html">
            
                    
                    Boosted Trees Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../supervised-learning/decision_tree_classifier.html">
            
                <a href="../supervised-learning/decision_tree_classifier.html">
            
                    
                    Decision Tree Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.3" data-path="../supervised-learning/logistic-regression.html">
            
                <a href="../supervised-learning/logistic-regression.html">
            
                    
                    Logistic Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.4" data-path="../supervised-learning/knn_classifier.html">
            
                <a href="../supervised-learning/knn_classifier.html">
            
                    
                    Nearest Neighbor Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.5" data-path="../supervised-learning/random_forest_classifier.html">
            
                <a href="../supervised-learning/random_forest_classifier.html">
            
                    
                    Random Forest Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.6" data-path="../supervised-learning/svm.html">
            
                <a href="../supervised-learning/svm.html">
            
                    
                    SVM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.7" data-path="../supervised-learning/export-coreml.html">
            
                <a href="../supervised-learning/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../clustering/">
            
                <a href="../clustering/">
            
                    
                    Clustering
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../clustering/kmeans.html">
            
                <a href="../clustering/kmeans.html">
            
                    
                    KMeans
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../clustering/dbscan.html">
            
                <a href="../clustering/dbscan.html">
            
                    
                    DBSCAN
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../graph_analytics/">
            
                <a href="../graph_analytics/">
            
                    
                    Graph analytics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../nearest_neighbors/nearest_neighbors.html">
            
                <a href="../nearest_neighbors/nearest_neighbors.html">
            
                    
                    Nearest neighbors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../supervised-learning/regression.html">
            
                <a href="../supervised-learning/regression.html">
            
                    
                    Regression
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.5.1" data-path="../supervised-learning/boosted_trees_regression.html">
            
                <a href="../supervised-learning/boosted_trees_regression.html">
            
                    
                    Boosted Trees Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.2" data-path="../supervised-learning/decision_tree_regression.html">
            
                <a href="../supervised-learning/decision_tree_regression.html">
            
                    
                    Decision Tree Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.3" data-path="../supervised-learning/linear-regression.html">
            
                <a href="../supervised-learning/linear-regression.html">
            
                    
                    Linear Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.4" data-path="../supervised-learning/random_forest_regression.html">
            
                <a href="../supervised-learning/random_forest_regression.html">
            
                    
                    Random Forest Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.5" data-path="../supervised-learning/export-coreml.html">
            
                <a href="../supervised-learning/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../text/">
            
                <a href="../text/">
            
                    
                    Text analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../evaluation/">
            
                <a href="../evaluation/">
            
                    
                    Evaluating models
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../evaluation/regression.html">
            
                <a href="../evaluation/regression.html">
            
                    
                    Regression metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../evaluation/classification.html">
            
                <a href="../evaluation/classification.html">
            
                    
                    Classification metrics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../conclusion.html">
            
                <a href="../conclusion.html">
            
                    
                    Additional Resources
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../cpp.html">
            
                <a href="../cpp.html">
            
                    
                    C++ API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../datasets.html">
            
                <a href="../datasets.html">
            
                    
                    Dataset Disclaimer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deployment to Core ML</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deploying-to-core-ml"><a name="deploying-to-core-ml" class="plugin-anchor" href="#deploying-to-core-ml"><i class="fa fa-link" aria-hidden="true"></i></a>Deploying to Core ML</h1><p>Object detector models created in Turi Create can easily be deployed to
Core ML.</p><h4 id="deployment-for-ios-12-and-macos-1014-turi-create-5"><a name="deployment-for-ios-12-and-macos-1014-turi-create-5" class="plugin-anchor" href="#deployment-for-ios-12-and-macos-1014-turi-create-5"><i class="fa fa-link" aria-hidden="true"></i></a>Deployment for iOS 12 and macOS 10.14 (Turi Create 5)</h4><p>With Turi Create 5.0+ and starting in iOS 12, macOS 10.14 you can
directly integrate object detector models via the <a href="https://developer.apple.com/documentation/vision" target="_blank">Vision
Framework</a>.</p><p>You can export to Core ML in Turi Create 5 as follows:</p><pre><code class="lang-python">model.export_coreml(<span class="hljs-string">&apos;MyDetector.mlmodel&apos;</span>)</code></pre>
<pre><code class="lang-swift"><span class="hljs-keyword">let</span> mlmodel = <span class="hljs-type">MyDetector</span>()
<span class="hljs-keyword">let</span> visionModel = <span class="hljs-keyword">try</span> <span class="hljs-type">VNCoreMLModel</span>(<span class="hljs-keyword">for</span>: mlmodel.model)
<span class="hljs-keyword">let</span> objectRecognition = <span class="hljs-type">VNCoreMLRequest</span>(model: visionModel,
                                        completionHandler: { (request, error) <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> results = request.results <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

    <span class="hljs-keyword">for</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">let</span> foundObject <span class="hljs-keyword">as</span> <span class="hljs-type">VNRecognizedObjectObservation</span> <span class="hljs-keyword">in</span> results {
        <span class="hljs-keyword">let</span> bestLabel = foundObject.labels.first! <span class="hljs-comment">// Label with highest confidence</span>
        <span class="hljs-keyword">let</span> objectBounds = foundObject.boundingBox <span class="hljs-comment">// Normalized between [0,1]</span>
        <span class="hljs-keyword">let</span> confidence = foundObject.confidence <span class="hljs-comment">// Confidence for the predicted class</span>

        <span class="hljs-comment">// Use the computed values.</span>
        <span class="hljs-built_in">print</span>(bestLabel.identifier, confidence, objectBounds)
    }
})
objectRecognition.imageCropAndScaleOption = .scaleFill</code></pre>
<p>For more details on the integration with Core ML and a sample app to get
you started, please look at the the article on
<a href="https://developer.apple.com/documentation/vision/recognizing_objects_in_live_capture" target="_blank">Recognizing Objects in Live Capture</a>. Please note that the demo in the above link uses a <em>normalized</em> confidence which enforces that the score across all classes sum to 1.</p><p><strong>Note:</strong> The bounding box object <code>VNRecognizedObjectObservation.boundingBox</code> has a different definition from the one used for Turi Create. First, the location is defined by the lower-left corner of the bounding box instead of the center. Secondly, the coordinate space has origin located in the lower-left corner of image. Third, the location, width, and height for the bounding box are all normalized between [0,1] by the dimensions of the images.</p><p><strong>Note:</strong> Only models that were exported with <em>non-maximum suppression</em> (the default
behavior in Turi Create 5.0+) will work with this example app. Older models
or models that specify <code>include_non_maximum_suppression=False</code> will not give
results as <code>VNRecognizedObjectObservation</code> objects and instead as
<code>VNCoreMLFeatureValueObservation</code> objects; these are silently ignored in
this example app. To learn how to work with <code>VNCoreMLFeatureValueObservation</code>
objects, please continue reading.</p><h4 id="deployment-for-ios-11-and--macos-1013"><a name="deployment-for-ios-11-and--macos-1013" class="plugin-anchor" href="#deployment-for-ios-11-and--macos-1013"><i class="fa fa-link" aria-hidden="true"></i></a>Deployment for iOS 11 and  macOS 10.13</h4><p>To deploy the object detector in apps for iOS 11 and macOS 10.13, you
need a few extra steps (these have been incorporated into iOS 12 and
macOS 10.14).</p><p>You can export to Core ML in Turi Create 5 as follows:</p><pre><code class="lang-python">model.export_coreml(<span class="hljs-string">&apos;MyDetector.mlmodel&apos;</span>, include_non_maximum_suppression=<span class="hljs-keyword">False</span>)</code></pre>
<p>and with Turi Create 4 you can do</p><pre><code class="lang-python">model.export_coreml(<span class="hljs-string">&apos;MyDetector.mlmodel&apos;</span>)</code></pre>
<p>This Core ML model takes an image and outputs two matrices of floating
point values, <em>confidence</em> and <em>coordinates</em>. The first one has shape
N-by-C, where N is the maximum number of bounding boxes that can be
returned in a single image, and C is the number of classes. If you index
this at <em>(n, c)</em>, you get the confidence of the <em>n</em>:th bounding box for
class <em>c</em>. The other output, <em>coordinates</em>, is N-by-4 and contains [<em>x</em>,
<em>y</em>, <em>width</em>, <em>height</em>] coordinates for each bounding box. The
coordinates are expressed relative to the original input size as values
between 0 and 1. This is because it does not know the size before it was
resized to fit the neural network. To get pixel values as in Turi
Create, you have to multiply <em>x</em> and <em>width</em> by the original width <em>y</em>
and <em>height</em> by the original height. Note that <em>x</em> and <em>y</em> refer to the
center of the box.</p><p>Drag and drop <code>MyDetector.mlmodel</code> into your Xcode project and add it to
your app by ticking the appropriate Target Membership check box. An
arrow next to MyDetector should appear:</p><p><img alt="Xcode view of MyDetector.mlmodel" src="images/xcode_detector.png"></p><p>Useful meta data is stored inside the model, such as class labels:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> mlmodel = <span class="hljs-type">MyDetector</span>()
<span class="hljs-keyword">let</span> userDefined: [<span class="hljs-type">String</span>: <span class="hljs-type">String</span>] = mlmodel.model.modelDescription.metadata[<span class="hljs-type">MLModelMetadataKey</span>.creatorDefinedKey]! <span class="hljs-keyword">as</span>! [<span class="hljs-type">String</span> : <span class="hljs-type">String</span>]
<span class="hljs-keyword">let</span> labels = userDefined[<span class="hljs-string">&quot;classes&quot;</span>]!.components(separatedBy: <span class="hljs-string">&quot;,&quot;</span>)</code></pre>
<p>The order of <code>labels</code> corresponds to the <em>confidence</em> output. The meta data
also contains a third type of threshold that we have yet to discuss:
<code>non_maximum_suppression_threshold</code>:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> nmsThreshold = <span class="hljs-type">Float</span>(userDefined[<span class="hljs-string">&quot;non_maximum_suppression_threshold&quot;</span>]!) ?? <span class="hljs-number">0.5</span></code></pre>
<p>Before we discuss how to use this threshold, we must first make a prediction.</p><h5 id="prediction"><a name="prediction" class="plugin-anchor" href="#prediction"><i class="fa fa-link" aria-hidden="true"></i></a>Prediction</h5><p>Making a prediction is easy. Starting in iOS 13 we can now include confidence thresholds
directly in the <code>VNCoreMLModel</code>. For an example of how to include thresholds in a project utilizing the Vision framework,
see <a href="https://developer.apple.com/documentation/coreml/understanding_a_dice_roll_with_vision_and_object_detection" target="_blank">here</a>.
First, we need to setup a subclass of <a href="https://developer.apple.com/documentation/coreml/mlfeatureprovider" target="_blank"><code>MLFeatureProvider</code></a>:</p><pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThresholdProvider</span>: <span class="hljs-title">MLFeatureProvider</span> </span>{

    open <span class="hljs-keyword">var</span> values = [
        <span class="hljs-string">&quot;iouThreshold&quot;</span>: <span class="hljs-type">MLFeatureValue</span>(double: <span class="hljs-number">0.3</span>),
        <span class="hljs-string">&quot;confidenceThreshold&quot;</span>: <span class="hljs-type">MLFeatureValue</span>(double: <span class="hljs-number">0.2</span>)
    ]

    <span class="hljs-keyword">var</span> featureNames: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-type">Set</span>(values.keys)
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">featureValue</span><span class="hljs-params">(<span class="hljs-keyword">for</span> featureName: String)</span></span> -&gt; <span class="hljs-type">MLFeatureValue</span>? {
        <span class="hljs-keyword">return</span> values[featureName]
    }
}</code></pre>
<p>After we&apos;ve specified one or more thresholds, we assign them to the model object and
make a prediction:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> model = <span class="hljs-keyword">try</span> <span class="hljs-type">VNCoreMLModel</span>(<span class="hljs-keyword">for</span>: mlmodel.model)

model.featureProvider = <span class="hljs-type">ThresholdProvider</span>()

<span class="hljs-keyword">let</span> request = <span class="hljs-type">VNCoreMLRequest</span>(model: model, completionHandler: { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] request, error <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">self</span>?.processClassifications(<span class="hljs-keyword">for</span>: request, error: error)
})
request.imageCropAndScaleOption = .scaleFill</code></pre>
<p>We use <code>.scaleFill</code> that stretches the image into the native input size of the
model. If you use <code>.centerCrop</code> or <code>.scaleFit</code>, it will be a bit trickier to
correctly map the bounding box coordinate system to the original input image.</p><p>From the <code>request</code> results we get two <code>MLMultiArray</code> instances,
<code>coordinates</code> and <code>confidence</code>. For easier handling, we will convert these
results into an array of the following <code>struct</code>:</p><pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Prediction</span> </span>{
    <span class="hljs-keyword">let</span> labelIndex: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> confidence: <span class="hljs-type">Float</span>
    <span class="hljs-keyword">let</span> boundingBox: <span class="hljs-type">CGRect</span>
}</code></pre>
<p>While building an array of these, we might as well trim the list of predictions
by enforcing a minimum confidence threshold. This threshold is entirely up to
you and your user experience and corresponds to the <code>confidence_threshold</code>
parameter in <code>predict</code> inside Turi Create:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> results = request.results <span class="hljs-keyword">as</span>! [<span class="hljs-type">VNCoreMLFeatureValueObservation</span>]

<span class="hljs-keyword">let</span> coordinates = results[<span class="hljs-number">0</span>].featureValue.multiArrayValue!
<span class="hljs-keyword">let</span> confidence = results[<span class="hljs-number">1</span>].featureValue.multiArrayValue!

<span class="hljs-keyword">let</span> confidenceThreshold = <span class="hljs-number">0.25</span>
<span class="hljs-keyword">var</span> unorderedPredictions = [<span class="hljs-type">Prediction</span>]()
<span class="hljs-keyword">let</span> numBoundingBoxes = confidence.shape[<span class="hljs-number">0</span>].intValue
<span class="hljs-keyword">let</span> numClasses = confidence.shape[<span class="hljs-number">1</span>].intValue
<span class="hljs-keyword">let</span> confidencePointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(confidence.dataPointer))
<span class="hljs-keyword">let</span> coordinatesPointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(coordinates.dataPointer))
<span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;numBoundingBoxes {
    <span class="hljs-keyword">var</span> maxConfidence = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">var</span> maxIndex = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">c</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;numClasses {
        <span class="hljs-keyword">let</span> conf = confidencePointer[b * numClasses + <span class="hljs-built_in">c</span>]
        <span class="hljs-keyword">if</span> conf &gt; maxConfidence {
            maxConfidence = conf
            maxIndex = <span class="hljs-built_in">c</span>
        }
    }
    <span class="hljs-keyword">if</span> maxConfidence &gt; confidenceThreshold {
        <span class="hljs-keyword">let</span> x = coordinatesPointer[b * <span class="hljs-number">4</span>]
        <span class="hljs-keyword">let</span> y = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>]
        <span class="hljs-keyword">let</span> w = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>]
        <span class="hljs-keyword">let</span> h = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>]

        <span class="hljs-keyword">let</span> rect = <span class="hljs-type">CGRect</span>(x: <span class="hljs-type">CGFloat</span>(x - w/<span class="hljs-number">2</span>), y: <span class="hljs-type">CGFloat</span>(y - h/<span class="hljs-number">2</span>),
                          width: <span class="hljs-type">CGFloat</span>(w), height: <span class="hljs-type">CGFloat</span>(h))

        <span class="hljs-keyword">let</span> prediction = <span class="hljs-type">Prediction</span>(labelIndex: maxIndex,
                                    confidence: <span class="hljs-type">Float</span>(maxConfidence),
                                    boundingBox: rect)
        unorderedPredictions.append(prediction)
    }
}</code></pre>
<p>This gives us an array of predictions (<code>unorderedPredictions</code>), still in no
particular order. This array contains more predictions than returned by
<code>predict</code> in Turi Create, since we are still missing a post-processing step
called <em>non-maximum suppression</em>.</p><h5 id="non-maximum-suppression"><a name="non-maximum-suppression" class="plugin-anchor" href="#non-maximum-suppression"><i class="fa fa-link" aria-hidden="true"></i></a>Non-maximum suppression</h5><p>This step is performed automatically by <code>predict</code> in Turi Create, but it
is not performed inside the Core ML inference model, so we will have to
add it ourselves. The model is prone to predict multiple similar
predictions associated with a single object instance. Here are the
results of the two dogs without non-maximum suppression:</p><p><img alt="Two dogs each with a swarm of bounding boxes around the face" src="images/without_nms.jpg"></p><p>The algorithm is simple: Start by taking your highest-confidence prediction and
add it to your final list of predictions.
Check the IoU (see <a href="#evaluation">Evaluation</a>) between it and and all the remaining
predictions. Remove (or <em>suppress</em>) any prediction with an IoU above a
pre-determined threshold (the <code>nmsThreshold</code> we extracted from the meta data).
Repeat this procedure, now excluding predictions that you have already added
or removed. Here is a reference implementation:</p><pre><code class="lang-swift"># <span class="hljs-type">Array</span> to store <span class="hljs-keyword">final</span> predictions (after post-processing)
<span class="hljs-keyword">var</span> predictions: [<span class="hljs-type">Prediction</span>] = []
<span class="hljs-keyword">let</span> orderedPredictions = unorderedPredictions.sorted { $<span class="hljs-number">0</span>.confidence &gt; $<span class="hljs-number">1</span>.confidence }
<span class="hljs-keyword">var</span> keep = [<span class="hljs-type">Bool</span>](repeating: <span class="hljs-literal">true</span>, <span class="hljs-built_in">count</span>: orderedPredictions.<span class="hljs-built_in">count</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;orderedPredictions.<span class="hljs-built_in">count</span> {
    <span class="hljs-keyword">if</span> keep[i] {
        predictions.append(orderedPredictions[i])
        <span class="hljs-keyword">let</span> bbox1 = orderedPredictions[i].boundingBox
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> (i+<span class="hljs-number">1</span>)..&lt;orderedPredictions.<span class="hljs-built_in">count</span> {
            <span class="hljs-keyword">if</span> keep[j] {
                <span class="hljs-keyword">let</span> bbox2 = orderedPredictions[j].boundingBox
                <span class="hljs-keyword">if</span> <span class="hljs-type">IoU</span>(bbox1, bbox2) &gt; nms_threshold {
                    keep[j] = <span class="hljs-literal">false</span>
                }
            }
        }
    }
}</code></pre>
<p>The intersection-over-union can be computed as:</p><pre><code class="lang-swift"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IoU</span><span class="hljs-params">(<span class="hljs-number">_</span> a: CGRect, <span class="hljs-number">_</span> b: CGRect)</span></span> -&gt; <span class="hljs-type">Float</span> {
    <span class="hljs-keyword">let</span> intersection = a.intersection(b)
    <span class="hljs-keyword">let</span> union = a.union(b)
    <span class="hljs-keyword">return</span> <span class="hljs-type">Float</span>((intersection.width * intersection.height) / (union.width * union.height))
}</code></pre>
<p>The array <code>predictions</code> is now the final array of predictions corresponding
to what <code>predict</code> returns in Turi Create.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="advanced-usage.html" class="navigation navigation-prev " aria-label="Previous page: Advanced Usage">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="how-it-works.html" class="navigation navigation-next " aria-label="Next page: How it works">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deployment to Core ML","level":"1.3.6.3","depth":3,"next":{"title":"How it works","level":"1.3.6.4","depth":3,"path":"object_detection/how-it-works.md","ref":"object_detection/how-it-works.md","articles":[]},"previous":{"title":"Advanced Usage","level":"1.3.6.2","depth":3,"path":"object_detection/advanced-usage.md","ref":"object_detection/advanced-usage.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"3.2.0","theme":"default","variables":{},"plugins":["collapsible-menu@1.0.2","anchors@0.5.0","mathjax"],"pluginsConfig":{"collapsible-menu":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"fontSettings":{"theme":"white","family":"sans","size":2},"highlight":{},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"object_detection/export-coreml.md","mtime":"2020-02-26T19:36:26.805Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2020-05-08T19:38:12.038Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

