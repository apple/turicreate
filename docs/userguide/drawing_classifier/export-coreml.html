
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Deployment to Core ML Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="advanced-usage.html" />
    
    
    <link rel="prev" href="data-preparation.html" />
    

    <script src="../turi/js/jquery/jquery-2.1.3.min.js"></script>
    <script src="../turi/js/d3/d3.min.js"></script>
    <script src="../supervised-learning/images/random-utils.js"></script>
    <script src="../supervised-learning/images/plotting-utils.js"></script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../sframe/">
            
                <a href="../sframe/">
            
                    
                    Working with data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../sframe/tabular-data.html">
            
                <a href="../sframe/tabular-data.html">
            
                    
                    Tabular data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../sframe/sframe-intro.html">
            
                <a href="../sframe/sframe-intro.html">
            
                    
                    Loading and Saving
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../sframe/data-manipulation.html">
            
                <a href="../sframe/data-manipulation.html">
            
                    
                    Data Manipulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="../data_formats_and_sources/sql_integration.html">
            
                <a href="../data_formats_and_sources/sql_integration.html">
            
                    
                    SQL Databases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../sgraph/sgraph.html">
            
                <a href="../sgraph/sgraph.html">
            
                    
                    Graph data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../text/analysis.html">
            
                <a href="../text/analysis.html">
            
                    
                    Text data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../vis/">
            
                <a href="../vis/">
            
                    
                    Visualization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../vis/gallery.html">
            
                <a href="../vis/gallery.html">
            
                    
                    Example Gallery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../vis/use_cases.html">
            
                <a href="../vis/use_cases.html">
            
                    
                    Sample Use Cases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../applications/">
            
                <a href="../applications/">
            
                    
                    Task focused toolkits
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../recommender/">
            
                <a href="../recommender/">
            
                    
                    Recommender Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../recommender/using-trained-models.html">
            
                <a href="../recommender/using-trained-models.html">
            
                    
                    Using models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../recommender/choosing-a-model.html">
            
                <a href="../recommender/choosing-a-model.html">
            
                    
                    Choosing a model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../recommender/coreml-deployment.html">
            
                <a href="../recommender/coreml-deployment.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../image_classifier/">
            
                <a href="../image_classifier/">
            
                    
                    Image Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../image_classifier/advanced-usage.html">
            
                <a href="../image_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../image_classifier/how-it-works.html">
            
                <a href="../image_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="../image_classifier/export-coreml.html">
            
                <a href="../image_classifier/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="./">
            
                <a href="./">
            
                    
                    Drawing Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="how-it-works.html">
            
                <a href="how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="data-preparation.html">
            
                <a href="data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.3.3" data-path="export-coreml.html">
            
                <a href="export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="advanced-usage.html">
            
                <a href="advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../sound_classifier/">
            
                <a href="../sound_classifier/">
            
                    
                    Sound Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="../sound_classifier/how-it-works.html">
            
                <a href="../sound_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.2" data-path="../sound_classifier/advanced-usage.html">
            
                <a href="../sound_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.3" data-path="../sound_classifier/export-coreml.html">
            
                <a href="../sound_classifier/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../image_similarity/">
            
                <a href="../image_similarity/">
            
                    
                    Image Similarity
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../image_similarity/export-coreml.html">
            
                <a href="../image_similarity/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../object_detection/">
            
                <a href="../object_detection/">
            
                    
                    Object Detection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.6.1" data-path="../object_detection/data-preparation.html">
            
                <a href="../object_detection/data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6.2" data-path="../object_detection/advanced-usage.html">
            
                <a href="../object_detection/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6.3" data-path="../object_detection/export-coreml.html">
            
                <a href="../object_detection/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6.4" data-path="../object_detection/how-it-works.html">
            
                <a href="../object_detection/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../one_shot_object_detection/">
            
                <a href="../one_shot_object_detection/">
            
                    
                    One-Shot Object Detection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../style_transfer/">
            
                <a href="../style_transfer/">
            
                    
                    Style Transfer
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.8.1" data-path="../style_transfer/how-it-works.html">
            
                <a href="../style_transfer/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8.2" data-path="../style_transfer/export-coreml.html">
            
                <a href="../style_transfer/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../activity_classifier/">
            
                <a href="../activity_classifier/">
            
                    
                    Activity Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.9.1" data-path="../activity_classifier/data-preparation.html">
            
                <a href="../activity_classifier/data-preparation.html">
            
                    
                    Data Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.2" data-path="../activity_classifier/advanced-usage.html">
            
                <a href="../activity_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.3" data-path="../activity_classifier/export_coreml.html">
            
                <a href="../activity_classifier/export_coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.4" data-path="../activity_classifier/how-it-works.html">
            
                <a href="../activity_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../text_classifier/">
            
                <a href="../text_classifier/">
            
                    
                    Text Classifier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../modeling-data/">
            
                <a href="../modeling-data/">
            
                    
                    Machine learning essentials
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../supervised-learning/classifier.html">
            
                <a href="../supervised-learning/classifier.html">
            
                    
                    Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../supervised-learning/boosted_trees_classifier.html">
            
                <a href="../supervised-learning/boosted_trees_classifier.html">
            
                    
                    Boosted Trees Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../supervised-learning/decision_tree_classifier.html">
            
                <a href="../supervised-learning/decision_tree_classifier.html">
            
                    
                    Decision Tree Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.3" data-path="../supervised-learning/logistic-regression.html">
            
                <a href="../supervised-learning/logistic-regression.html">
            
                    
                    Logistic Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.4" data-path="../supervised-learning/knn_classifier.html">
            
                <a href="../supervised-learning/knn_classifier.html">
            
                    
                    Nearest Neighbor Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.5" data-path="../supervised-learning/random_forest_classifier.html">
            
                <a href="../supervised-learning/random_forest_classifier.html">
            
                    
                    Random Forest Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.6" data-path="../supervised-learning/svm.html">
            
                <a href="../supervised-learning/svm.html">
            
                    
                    SVM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.7" data-path="../supervised-learning/export-coreml.html">
            
                <a href="../supervised-learning/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../clustering/">
            
                <a href="../clustering/">
            
                    
                    Clustering
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../clustering/kmeans.html">
            
                <a href="../clustering/kmeans.html">
            
                    
                    KMeans
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../clustering/dbscan.html">
            
                <a href="../clustering/dbscan.html">
            
                    
                    DBSCAN
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../graph_analytics/">
            
                <a href="../graph_analytics/">
            
                    
                    Graph analytics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../nearest_neighbors/nearest_neighbors.html">
            
                <a href="../nearest_neighbors/nearest_neighbors.html">
            
                    
                    Nearest neighbors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../supervised-learning/regression.html">
            
                <a href="../supervised-learning/regression.html">
            
                    
                    Regression
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.5.1" data-path="../supervised-learning/boosted_trees_regression.html">
            
                <a href="../supervised-learning/boosted_trees_regression.html">
            
                    
                    Boosted Trees Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.2" data-path="../supervised-learning/decision_tree_regression.html">
            
                <a href="../supervised-learning/decision_tree_regression.html">
            
                    
                    Decision Tree Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.3" data-path="../supervised-learning/linear-regression.html">
            
                <a href="../supervised-learning/linear-regression.html">
            
                    
                    Linear Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.4" data-path="../supervised-learning/random_forest_regression.html">
            
                <a href="../supervised-learning/random_forest_regression.html">
            
                    
                    Random Forest Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.5" data-path="../supervised-learning/export-coreml.html">
            
                <a href="../supervised-learning/export-coreml.html">
            
                    
                    Deployment to Core ML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../text/">
            
                <a href="../text/">
            
                    
                    Text analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../evaluation/">
            
                <a href="../evaluation/">
            
                    
                    Evaluating models
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../evaluation/regression.html">
            
                <a href="../evaluation/regression.html">
            
                    
                    Regression metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../evaluation/classification.html">
            
                <a href="../evaluation/classification.html">
            
                    
                    Classification metrics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../conclusion.html">
            
                <a href="../conclusion.html">
            
                    
                    Additional Resources
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../cpp.html">
            
                <a href="../cpp.html">
            
                    
                    C++ API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../datasets.html">
            
                <a href="../datasets.html">
            
                    
                    Dataset Disclaimer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deployment to Core ML</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deploying-to-core-ml"><a name="deploying-to-core-ml" class="plugin-anchor" href="#deploying-to-core-ml"><i class="fa fa-link" aria-hidden="true"></i></a>Deploying to Core ML</h1><p>Drawing Classifier models created in Turi Create can easily be deployed to
Core ML.</p><p>You can export to Core ML in Turi Create 5.4 or higher as follows:</p><pre><code class="lang-python">model.export_coreml(<span class="hljs-string">&quot;MySquareTriangleClassifier.mlmodel&quot;</span>)</code></pre>
<p>The Core ML Model should look like the following:</p><p><img alt="Xcode view of MySquareTriangleClassifier.mlmodel" src="images/xcode_drawing_classifier.png"></p><p>Drag and drop <code>MySquareTriangleClassifier.mlmodel</code> into your Xcode project and
add it to your app by ticking the appropriate Target Membership check box.</p><h3 id="inference"><a name="inference" class="plugin-anchor" href="#inference"><i class="fa fa-link" aria-hidden="true"></i></a>Inference</h3><p>Making a prediction at inference time on device is easy! In this section, we go
over your workflow depending on what input you may have in your app at inference
time.</p><h4 id="using-bitmap-input"><a name="using-bitmap-input" class="plugin-anchor" href="#using-bitmap-input"><i class="fa fa-link" aria-hidden="true"></i></a>Using Bitmap Input</h4><p>At inference time, if you have access to a bitmap and/or image that represents
the drawing you want to classify, you can use the Vision framework to consume
the exported Core ML model. Note that the image you provide to the Vision API
must be a Grayscale Image.</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> model = <span class="hljs-keyword">try</span> <span class="hljs-type">VNCoreMLModel</span>(<span class="hljs-keyword">for</span>: <span class="hljs-type">MySquareTriangleClassifier</span>().model)
<span class="hljs-keyword">let</span> request = <span class="hljs-type">VNCoreMLRequest</span>(model: model!, completionHandler: { [] request, error <span class="hljs-keyword">in</span>
        processClassifications(<span class="hljs-keyword">for</span>: request, error: error)
    })

<span class="hljs-keyword">let</span> grayscaleImage! = <span class="hljs-type">UIImage</span>(named: bitmapFilename)
<span class="hljs-keyword">let</span> handler = <span class="hljs-type">VNImageRequestHandler</span>(cgImage: grayscaleImage.cgImage!, options: [:])

<span class="hljs-keyword">try</span>? handler.perform([request])

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processClassifications</span><span class="hljs-params">(<span class="hljs-keyword">for</span> request: VNRequest, error: error)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> sortedResults = request.results! <span class="hljs-keyword">as</span>? [<span class="hljs-type">VNClassificationObservation</span>] {
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> sortedResults {
            <span class="hljs-built_in">print</span>(result.identifier, result.confidence)
        }
    }
}
</code></pre>
<h4 id="using-stroke-based-drawing-input"><a name="using-stroke-based-drawing-input" class="plugin-anchor" href="#using-stroke-based-drawing-input"><i class="fa fa-link" aria-hidden="true"></i></a>Using Stroke-Based Drawing Input</h4><p>On the other hand, if you have access to raw stroke-based drawing data at 
inference time, you will first have to convert it to a Grayscale Bitmap and then
use the Vision framework so the Core ML model can consume images at inference 
time.</p><p>First, convert your stroke-based drawing into a member of the following Drawing 
class using the methods that the following Drawing class exposes.</p><pre><code class="lang-swift"><span class="hljs-keyword">import</span> Foundation
<span class="hljs-keyword">import</span> CoreGraphics

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Drawing</span> </span>{
    <span class="hljs-keyword">var</span> drawing: <span class="hljs-type">NSMutableArray</span>
    <span class="hljs-keyword">var</span> stroke: <span class="hljs-type">NSMutableArray</span>
    <span class="hljs-keyword">var</span> min_x: <span class="hljs-type">CGFloat</span>
    <span class="hljs-keyword">var</span> min_y: <span class="hljs-type">CGFloat</span>
    <span class="hljs-keyword">var</span> max_x: <span class="hljs-type">CGFloat</span>
    <span class="hljs-keyword">var</span> max_y: <span class="hljs-type">CGFloat</span>

    <span class="hljs-keyword">init</span>() {
        drawing = <span class="hljs-type">NSMutableArray</span>()
        stroke = <span class="hljs-type">NSMutableArray</span>()
        min_x = <span class="hljs-type">CGFloat</span>.greatestFiniteMagnitude
        max_x = <span class="hljs-number">0.0</span>
        min_y = <span class="hljs-type">CGFloat</span>.greatestFiniteMagnitude
        max_y = <span class="hljs-number">0.0</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pointCount</span><span class="hljs-params">(stroke i:Int)</span></span> -&gt; <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">let</span> corresponding_stroke = drawing.object(at:i) <span class="hljs-keyword">as</span>! <span class="hljs-type">NSArray</span>
        <span class="hljs-keyword">return</span> corresponding_stroke.<span class="hljs-built_in">count</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">strokeCount</span><span class="hljs-params">()</span></span> -&gt; <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">return</span> drawing.<span class="hljs-built_in">count</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">point</span><span class="hljs-params">(stroke i:Int, point j:Int)</span></span> -&gt; <span class="hljs-type">CGPoint</span> {
        <span class="hljs-keyword">let</span> corresponding_stroke = drawing.object(at:i) <span class="hljs-keyword">as</span>! <span class="hljs-type">NSArray</span>
        <span class="hljs-keyword">let</span> answer = corresponding_stroke.object(at:j) <span class="hljs-keyword">as</span>! <span class="hljs-type">CGPoint</span>
        <span class="hljs-keyword">return</span> answer
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stroke</span><span class="hljs-params">(index i:Int)</span></span> -&gt; <span class="hljs-type">NSMutableArray</span> {
        <span class="hljs-keyword">return</span> drawing.object(at: i) <span class="hljs-keyword">as</span>! <span class="hljs-type">NSMutableArray</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(point P:CGPoint)</span></span> {
        <span class="hljs-keyword">let</span> x = <span class="hljs-type">P</span>.x
        <span class="hljs-keyword">let</span> y = <span class="hljs-type">P</span>.y
        min_x = <span class="hljs-built_in">min</span>(x, min_x)
        max_x = <span class="hljs-built_in">max</span>(x, max_x)
        min_y = <span class="hljs-built_in">min</span>(y, min_y)
        max_y = <span class="hljs-built_in">max</span>(y, max_y)
        stroke.add(<span class="hljs-type">P</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">endStroke</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">let</span> new_stroke = <span class="hljs-type">NSMutableArray</span>()
        new_stroke.addObjects(from: stroke <span class="hljs-keyword">as</span>! [<span class="hljs-type">Any</span>])
        drawing.add(new_stroke)
        stroke.removeAllObjects()
    }
}</code></pre>
<p>The Drawing class can be used in the following way.</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> example_drawing = [
            [
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">2.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">2.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">2.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">3.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">2.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">4.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">2.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">5.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">2.0</span>]
            ],
            [
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">10.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">10.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">10.5</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">10.5</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">11.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">11.0</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">12.5</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">12.5</span>],
                [<span class="hljs-string">&quot;x&quot;</span>: <span class="hljs-number">15.0</span>, <span class="hljs-string">&quot;y&quot;</span>: <span class="hljs-number">15.0</span>]
            ]
        ]

<span class="hljs-keyword">let</span> myDrawing = <span class="hljs-type">Drawing</span>()
<span class="hljs-keyword">for</span> stroke <span class="hljs-keyword">in</span> example_drawing {
    <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> stroke {
        myDrawing.add(point: <span class="hljs-type">CGPoint</span>(x: point[<span class="hljs-string">&quot;x&quot;</span>]!, y: point[<span class="hljs-string">&quot;y&quot;</span>]!))
    }
    myDrawing.endStroke()
}</code></pre>
<p>Each drawing is a set of strokes and each stroke is a set of points. Here, example_drawing is a drawing with two strokes and each stroke with different number of points. The drawing data can also be collected as streaming points using touch events, mouse events etc using the Drawing class.</p><p>Once your stroke-based drawing is a member of the above Drawing class, call the 
<code>rasterize</code> function on it to build a 28x28 grayscale bitmap.</p><p>The code snippet containing <code>rasterize</code> and its helper, 
<code>normalize</code> are provided below.</p><pre><code class="lang-swift">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">normalize</span><span class="hljs-params">(drawing D:Drawing)</span></span> -&gt; <span class="hljs-type">Drawing</span> {
    <span class="hljs-keyword">let</span> new_drawing = <span class="hljs-type">Drawing</span>()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-type">D</span>.strokeCount() {
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-type">D</span>.pointCount(stroke: i) {
            <span class="hljs-keyword">let</span> current_point = <span class="hljs-type">D</span>.point(stroke: i, point: j)
            <span class="hljs-keyword">var</span> new_x, new_y : <span class="hljs-type">CGFloat</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-type">D</span>.max_x == <span class="hljs-type">D</span>.min_x) {new_x = <span class="hljs-type">D</span>.min_x}
            <span class="hljs-keyword">else</span> {
                new_x = (current_point.x - <span class="hljs-type">D</span>.min_x) * <span class="hljs-number">255.0</span> / (<span class="hljs-type">D</span>.max_x - <span class="hljs-type">D</span>.min_x)
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-type">D</span>.max_y == <span class="hljs-type">D</span>.min_y) {new_y = <span class="hljs-type">D</span>.min_y}
            <span class="hljs-keyword">else</span> {
                new_y = (current_point.y - <span class="hljs-type">D</span>.min_y) * <span class="hljs-number">255.0</span> / (<span class="hljs-type">D</span>.max_y - <span class="hljs-type">D</span>.min_y)
            }
            <span class="hljs-keyword">let</span> new_point = <span class="hljs-type">CGPoint</span>(x: new_x, y: new_y)
            new_drawing.add(point: new_point)
        }
        new_drawing.endStroke()
    }
    <span class="hljs-keyword">return</span> new_drawing
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rasterize</span><span class="hljs-params">(drawing stroke_based_drawing:Drawing)</span></span> -&gt; <span class="hljs-type">CGImage</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-type">D</span> = normalize(drawing: stroke_based_drawing)
    <span class="hljs-keyword">let</span> grayscale = <span class="hljs-type">CGColorSpaceCreateDeviceGray</span>()
    <span class="hljs-keyword">let</span> intermediate_bitmap_context = <span class="hljs-type">CGContext</span>(
        data:<span class="hljs-literal">nil</span>, width:<span class="hljs-number">256</span>, height:<span class="hljs-number">256</span>, bitsPerComponent:<span class="hljs-number">8</span>, bytesPerRow:<span class="hljs-number">0</span>, 
        space:grayscale, bitmapInfo:<span class="hljs-type">CGImageAlphaInfo</span>.<span class="hljs-keyword">none</span>.rawValue)
    intermediate_bitmap_context?.setStrokeColor(
        red: <span class="hljs-number">1.0</span>, green: <span class="hljs-number">1.0</span>, blue: <span class="hljs-number">1.0</span>, alpha: <span class="hljs-number">1.0</span>)
    <span class="hljs-keyword">let</span> transform = <span class="hljs-type">CGAffineTransform</span>.identity
    <span class="hljs-keyword">let</span> path = <span class="hljs-type">CGMutablePath</span>()
    <span class="hljs-keyword">for</span> strokeIndex <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-type">D</span>.strokeCount() {
        <span class="hljs-keyword">let</span> stroke = <span class="hljs-type">D</span>.stroke(index: strokeIndex)
        <span class="hljs-keyword">let</span> startPoint = <span class="hljs-type">D</span>.point(stroke: strokeIndex, point: <span class="hljs-number">0</span>)
        path.move(to: startPoint, transform: transform)
        <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> stroke {
            path.addLine(to: point <span class="hljs-keyword">as</span>! <span class="hljs-type">CGPoint</span>, transform: transform)
        }
    }
    intermediate_bitmap_context?.setLineWidth(<span class="hljs-number">20.0</span>)
    intermediate_bitmap_context?.beginPath()
    intermediate_bitmap_context?.addPath(path)
    intermediate_bitmap_context?.strokePath()
    <span class="hljs-keyword">let</span> intermediate_image = intermediate_bitmap_context?.makeImage()

    <span class="hljs-keyword">let</span> final_bitmap_context = <span class="hljs-type">CGContext</span>(
        data:<span class="hljs-literal">nil</span>, width:<span class="hljs-number">28</span>, height:<span class="hljs-number">28</span>, bitsPerComponent:<span class="hljs-number">8</span>, bytesPerRow:<span class="hljs-number">0</span>, 
        space:grayscale, bitmapInfo:<span class="hljs-type">CGImageAlphaInfo</span>.<span class="hljs-keyword">none</span>.rawValue)
    <span class="hljs-keyword">let</span> final_rect = <span class="hljs-type">CGRect</span>(x: <span class="hljs-number">0.0</span>, y: <span class="hljs-number">0.0</span>, width: <span class="hljs-number">28.0</span>, height: <span class="hljs-number">28.0</span>)
    final_bitmap_context?.draw(intermediate_image!, <span class="hljs-keyword">in</span>: final_rect)
    <span class="hljs-keyword">return</span> (final_bitmap_context?.makeImage())!
}</code></pre>
<p>The Core ML model can then run inference on this bitmap via the Vision framework
as described above under &quot;Using Bitmap Input&quot;.</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> model = <span class="hljs-keyword">try</span> <span class="hljs-type">VNCoreMLModel</span>(<span class="hljs-keyword">for</span>: <span class="hljs-type">MySquareTriangleClassifier</span>().model)
<span class="hljs-keyword">let</span> request = <span class="hljs-type">VNCoreMLRequest</span>(model: model!, completionHandler: { [] request, error <span class="hljs-keyword">in</span>
        processClassifications(<span class="hljs-keyword">for</span>: request, error: error)
    })

<span class="hljs-keyword">let</span> main_image: <span class="hljs-type">CGImage</span> = rasterize(drawing: myDrawing)
<span class="hljs-keyword">let</span> handler = <span class="hljs-type">VNImageRequestHandler</span>(cgImage: main_image)        

<span class="hljs-keyword">try</span>? handler.perform([request])

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processClassifications</span><span class="hljs-params">(<span class="hljs-keyword">for</span> request: VNRequest, error: error)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> sortedResults = request.results! <span class="hljs-keyword">as</span>? [<span class="hljs-type">VNClassificationObservation</span>] {
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> sortedResults {
            <span class="hljs-built_in">print</span>(result.identifier, result.confidence)
        }
    }
}</code></pre>
<p>Through a simple drag and drop process, you can incorporate the model into Xcode. The Swift code snippets are provided to take either bitmap or stroke-based drawing as input and consume the model in an iOS app.</p><p>Refer to the <a href="https://developer.apple.com/documentation/vision/classifying_images_with_vision_and_core_ml" target="_blank">Core ML sample application
</a>
for more details on using image classifiers in Core ML and Vision
frameworks for iOS and macOS.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="data-preparation.html" class="navigation navigation-prev " aria-label="Previous page: Data Preparation">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="advanced-usage.html" class="navigation navigation-next " aria-label="Next page: Advanced Usage">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deployment to Core ML","level":"1.3.3.3","depth":3,"next":{"title":"Advanced Usage","level":"1.3.3.4","depth":3,"path":"drawing_classifier/advanced-usage.md","ref":"drawing_classifier/advanced-usage.md","articles":[]},"previous":{"title":"Data Preparation","level":"1.3.3.2","depth":3,"path":"drawing_classifier/data-preparation.md","ref":"drawing_classifier/data-preparation.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"3.2.0","theme":"default","variables":{},"plugins":["collapsible-menu@1.0.2","anchors@0.5.0","mathjax"],"pluginsConfig":{"collapsible-menu":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"fontSettings":{"theme":"white","family":"sans","size":2},"highlight":{},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"drawing_classifier/export-coreml.md","mtime":"2020-05-01T01:06:35.548Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2020-10-09T21:45:22.325Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

