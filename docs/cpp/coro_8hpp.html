<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Turi Create: core/util/coro.hpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Turi Create
   &#160;<span id="projectnumber">4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('coro_8hpp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">coro.hpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="coro_8hpp_source.html">Go to the source code of this file.</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Very limited coroutine implementation.</p>
<p>Kind of inspired by <a href="https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html">https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html</a></p>
<p>Essentially, DECL_CORO_STATE holds an integer which is a line number of the function., RESET_CORO resets that value to 0. CORO_YIELD sets the current line number so that the next time the function is called, a switch is used to jump to the next line.</p>
<p>Generally this means that this is not a truly general coroutine mechanic since it does not remember any stack state between function invocations. Any stack state has to be maintained outside the function. To some extent this is automatically checked by the compiler due to the use of switch statements. Generally extra braces between CORO_YIELDs might be necessary to get the compiler to accept the code.</p>
<p>Furthermore, parallel invocations, or multiple simultaneous coroutine invocations of the function is not allowed since there is a single global variable which maintains the line number. However, wrapping the DECL_CORO_STATE and the function in a struct/class will allow for it.</p>
<p>Example: </p><div class="fragment"><div class="line">DECL_CORO_STATE(integers)</div><div class="line"><span class="keywordtype">int</span> ctr;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> integers() {</div><div class="line">  <span class="comment">// anything before CORO_BEGIN is run *everytime*</span></div><div class="line">  CORO_BEGIN(integers)</div><div class="line">  ctr = 0;</div><div class="line">  <span class="keywordflow">while</span>(1) {</div><div class="line">    CORO_YIELD(ctr);</div><div class="line">    ++ctr;</div><div class="line">  };</div><div class="line">  CORO_END</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">  <span class="keywordflow">while</span>(1) {</div><div class="line">    std::cout &lt;&lt; CALL_CORO(integers) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">    getchar();</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>The behavior of this system is very subtle and takes some care to get right. A perculiarity is that argument values may be different between successive calls. Ex: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> ctr = 0;</div><div class="line"><span class="keywordtype">int</span> integers(<span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end) {</div><div class="line">  CORO_BEGIN(integers)</div><div class="line">  <span class="keywordflow">for</span> (ctr = start; ctr &lt; end; ++ctr) {</div><div class="line">    CORO_YIELD(ctr);</div><div class="line">  }</div><div class="line">  CORO_END</div><div class="line"> }</div><div class="line"></div><div class="line"><span class="keywordflow">do</span> {</div><div class="line">  std::cout &lt;&lt; integers(1,10) &lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">} <span class="keywordflow">while</span>(CORO_RUNNING(integers));</div></div><!-- fragment --><p>User must be careful to call the method with the same input arguments everytime or interesting behavior might happen. Similarly, this allows input arguments to be used to transfer information to the coroutine (for instance, in a producer/consumer model, an argument can be used to transfer a buffer from the consumer to the producer).</p>
<p>Example: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> ctr = 0;</div><div class="line"><span class="keywordtype">void</span> integers(<span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span>* out) {</div><div class="line">  CORO_BEGIN(integers)</div><div class="line">  <span class="keywordflow">for</span> (ctr = start; ctr &lt; end; ++ctr) {</div><div class="line">    (*out) = ctr;</div><div class="line">    CORO_YIELD(ctr);</div><div class="line">    <span class="comment">// after this, the out pointer may change.</span></div><div class="line">  }</div><div class="line">  CORO_END</div><div class="line"> }</div></div><!-- fragment --><p>But some care must be taken because after a CORO_YIELD, any of the arguments may have new values. Essentially, CORO_YIELD itself is an entry point to the function and has to be treated that way.</p>
<p>To help in closure maintenance, a struct/class version of the macros are provided. </p><div class="fragment"><div class="line"><span class="keyword">struct </span>integers {</div><div class="line"> DECL_CORO_STATE(call)</div><div class="line"> <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end;</div><div class="line"> <span class="keywordtype">int</span> ctr;</div><div class="line"> integers(<span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end):start(start),end(end), ctr(0) {}</div><div class="line"></div><div class="line"> <span class="keywordtype">int</span> read() {</div><div class="line">   CORO_BEGIN(integers)</div><div class="line">   <span class="keywordflow">for</span> (ctr = start; ctr &lt; end; ++ctr) {</div><div class="line">     CORO_YIELD(ctr);</div><div class="line">   }</div><div class="line">   CORO_END</div><div class="line">  }</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line">integers counter(1, 10);</div><div class="line"><span class="keywordflow">do</span> {</div><div class="line">  std::cout &lt;&lt; counter.read() &lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line">} <span class="keywordflow">while</span>(CLASS_CORO_RUNNING(counter, read));</div></div><!-- fragment --> 
<p class="definition">Definition in file <a class="el" href="coro_8hpp_source.html">coro.hpp</a>.</p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_4270bfced15e0e73154b13468c7c9ad9.html">core</a></li><li class="navelem"><a class="el" href="dir_459a7c9a427a2877b0db19c6b8d6e89d.html">util</a></li><li class="navelem"><a class="el" href="coro_8hpp.html">coro.hpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
