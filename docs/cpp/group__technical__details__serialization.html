<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Turi Create: Technical Details: Serialization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Turi Create
   &#160;<span id="projectnumber">4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__technical__details__serialization.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Technical Details: Serialization<div class="ingroups"><a class="el" href="group__group__serialization.html">Serialization</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>The two key serialization objects are oarchive and iarchive (in <code>src/turicreate/serialization/oarchive.hpp</code> and <code>src/turicreate/serialization/iarchive.hpp</code>) respectively. oarchive internally wraps either a direct <code>char*</code> buffer which it resizes automatically, or a <code>ostream</code> object. Similarly, iarchive internally wraps either a direct <code>char*</code> buffer with a known length, or an <code>istream</code> object. All these members are directly accessible.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>oarchive{</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  std::ostream* out;    <span class="comment">// pointer to output stream. Used if not NULL</span></div><div class="line">  <span class="keywordtype">char</span>* buf;            <span class="comment">// pointer to buffer. Used if out is NULL</span></div><div class="line">  <span class="keywordtype">size_t</span> off;           <span class="comment">// current length of buffer</span></div><div class="line">  <span class="keywordtype">size_t</span> len;           <span class="comment">// current maximum length of buffer.</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>iarchive {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  std::istream* in;     <span class="comment">// pointer to input stream. Used if not NULL</span></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* buf;      <span class="comment">// pointer to input buffer. Used if in is NULL</span></div><div class="line">  <span class="keywordtype">size_t</span> off;           <span class="comment">// offset of next position in buf</span></div><div class="line">  <span class="keywordtype">size_t</span> len;           <span class="comment">// length of buffer</span></div><div class="line">}</div></div><!-- fragment --><p>The oarchive overloads operator&lt;&lt; and iarchive overloads operator&gt;&gt; to allow the use of the stream operator to serialize / deserialize objects.</p>
<div class="fragment"><div class="line">oarchive oarc(outstrm)</div><div class="line"><span class="keywordtype">string</span> s;</div><div class="line">oarc &lt;&lt; s &lt;&lt; int(1) &lt;&lt; long(2);</div><div class="line">...</div><div class="line">iarchive iarc(instrm)</div><div class="line"><span class="keywordtype">string</span> s;</div><div class="line"><span class="keywordtype">int</span> i; <span class="keywordtype">long</span> j;</div><div class="line">iarc &gt;&gt; s &gt;&gt; i &gt;&gt; j;</div></div><!-- fragment --><p>Using the oarchive as an example: this is done by a function:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="keyword">inline</span> oarchive&amp; <a class="code" href="int128__types_8hpp.html#ad58745b6418f9446138d4bc388d5c873">operator&lt;&lt;</a>(oarchive&amp; oarc, <span class="keyword">const</span> T&amp; t)</div></div><!-- fragment --><p>which immediately re-dispatches into the following template class:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OutArcType, <span class="keyword">typename</span> T, <span class="keywordtype">bool</span> IsPodType&gt;</div><div class="line"><span class="keyword">struct </span>serialize_impl {</div><div class="line">  <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">void</span> exec(OutArcType&amp; oarc, <span class="keyword">const</span> T&amp; t) {</div><div class="line">    ...</div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><p>Where IsPodType is true if T is a scalar or inherits from <a class="el" href="structturi_1_1IS__POD__TYPE.html">turi::IS_POD_TYPE</a> (see <a class="el" href="is__pod_8hpp_source.html">is_pod.hpp</a>) and false otherwise. The serialize_impl class is then further specialized around T to provide serializers for basic types (int, float, etc) , and common STL types (pair, string, vector, etc) using recursive calls if necessary. The base template class (when none of the specializations match), simply calls t.save(oarc). This thus implements the user-defined serializers for save and load functions.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>user_struct {</div><div class="line">  <span class="keywordtype">int</span> i;</div><div class="line">  <span class="keywordtype">string</span> s;</div><div class="line">  <span class="keywordtype">void</span> save(oarchive&amp; oarc)<span class="keyword"> const </span>{</div><div class="line">    oarc &lt;&lt; i &lt;&lt; s;</div><div class="line">  }</div><div class="line">  <span class="keywordtype">void</span> load(iarchive&amp; iarc) {</div><div class="line">    iarc &gt;&gt; i &gt;&gt; s;</div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><p>The templatization over OutArcType allows for alternate definitions of oarchive which behave differently. For instance, <a class="el" href="classturi_1_1oarchive__soft__fail.html">turi::oarchive_soft_fail</a> which will only fail at runtime if an object type cannot be serialized. This is done via a use of SFINAE in <code><a class="el" href="has__save_8hpp_source.html">has_save.hpp</a></code> and <code><a class="el" href="has__load_8hpp_source.html">has_load.hpp</a></code>. To permit generic implementations of serialize_impl which are independent of OutArcType, the oarchive/iarchive must implement the following functions:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>oarchive {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="comment">// writes s bytes from c into the archive</span></div><div class="line">  <span class="keywordtype">void</span> write(<span class="keyword">const</span> <span class="keywordtype">char</span>* c, std::streamsize s);</div><div class="line"></div><div class="line">  <span class="comment">// writes t into the stream by direct memcpy.</span></div><div class="line">  <span class="comment">// i.e. equivalent to write(reinterpret_cast&lt;char*&gt;(t), sizeof(t))</span></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div><div class="line">  <span class="keywordtype">void</span> direct_assign(<span class="keyword">const</span> T&amp; t);</div><div class="line"></div><div class="line">  <span class="comment">// advances the buffer by s bytes. equivalent to writing s bytes of \0</span></div><div class="line">  <span class="keyword">inline</span> <span class="keywordtype">void</span> advance(<span class="keywordtype">size_t</span> s);</div><div class="line"></div><div class="line">  <span class="comment">// return true if the buffer is invalid</span></div><div class="line">  <span class="keyword">inline</span> <span class="keywordtype">bool</span> fail();</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">class </span>iarchive {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Reads one character from the archive</span></div><div class="line">  <span class="keywordtype">char</span> read_char();</div><div class="line"></div><div class="line">  <span class="comment">// reads len bytes from the archive writing into c</span></div><div class="line">  <span class="keywordtype">void</span> read(<span class="keywordtype">char</span>* c, <span class="keywordtype">size_t</span> len);</div><div class="line">};</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
