!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.vl={})}(this,function(e){"use strict";function t(e,t,n){return e.fields=t||[],e.fname=n,e}function n(e){throw Error(e)}function r(e){var t,r,i,o=[],a=null,u=0,s=e.length,c="";function l(){o.push(c+e.substring(t,r)),c="",t=r+1}for(e+="",t=r=0;r<s;++r)if("\\"===(i=e[r]))c+=e.substring(t,r),t=++r;else if(i===a)l(),a=null,u=-1;else{if(a)continue;t===u&&'"'===i?(t=r+1,a=i):t===u&&"'"===i?(t=r+1,a=i):"."!==i||u?"["===i?(r>t&&l(),u=t=r+1):"]"===i&&(u||n("Access path missing open bracket: "+e),u>0&&l(),u=0,t=r+1):r>t?l():t=r+1}return u&&n("Access path missing closing bracket: "+e),a&&n("Access path missing closing quote: "+e),r>t&&(r++,l()),o}var i=Array.isArray;function o(e){return e===Object(e)}function a(e){return"string"==typeof e}function u(e){return i(e)?"["+e.map(u)+"]":o(e)||a(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e}var s=[];(function(e,n){var i=r(e),o="return _["+i.map(u).join("][")+"];";t(Function("_",o),[e=1===i.length?i[0]:e],n||e)})("id"),t(function(e){return e},s,"identity"),t(function(){return 0},s,"zero"),t(function(){return 1},s,"one"),t(function(){return!0},s,"true"),t(function(){return!1},s,"false");function c(e,t,n){var r=[t].concat([].slice.call(n));console[e].apply(console,r)}var l=0,f=1,d=2,p=3,h=4;function m(e){for(var t,n,r=1,i=arguments.length;r<i;++r)for(n in t=arguments[r])e[n]=t[n];return e}function g(e){return"boolean"==typeof e}function v(e){return"number"==typeof e}function y(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n]]=!0;return t}var b=function(e,t){return(b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function x(e,t){function n(){this.constructor=e}b(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var S=function(){return(S=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function E(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n}var w,k,C,O,N=Array.isArray,A=Object.keys,T=Object.prototype.hasOwnProperty,_={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},D=function(e){throw{name:"SyntaxError",message:e,at:w,text:C}},R=function(e){return e&&e!==k&&D("Expected '"+e+"' instead of '"+k+"'"),k=C.charAt(w),w+=1,k},z=function(){var e,t="";for("-"===k&&(t="-",R("-"));k>="0"&&k<="9";)t+=k,R();if("."===k)for(t+=".";R()&&k>="0"&&k<="9";)t+=k;if("e"===k||"E"===k)for(t+=k,R(),"-"!==k&&"+"!==k||(t+=k,R());k>="0"&&k<="9";)t+=k,R();if(e=+t,isFinite(e))return e;D("Bad number")},I=function(){var e,t,n,r="";if('"'===k)for(;R();){if('"'===k)return R(),r;if("\\"===k)if(R(),"u"===k){for(n=0,t=0;t<4&&(e=parseInt(R(),16),isFinite(e));t+=1)n=16*n+e;r+=String.fromCharCode(n)}else{if("string"!=typeof _[k])break;r+=_[k]}else r+=k}D("Bad string")},F=function(){for(;k&&k<=" ";)R()};O=function(){switch(F(),k){case"{":return function(){var e,t={};if("{"===k){if(R("{"),F(),"}"===k)return R("}"),t;for(;k;){if(e=I(),F(),R(":"),Object.hasOwnProperty.call(t,e)&&D('Duplicate key "'+e+'"'),t[e]=O(),F(),"}"===k)return R("}"),t;R(","),F()}}D("Bad object")}();case"[":return function(){var e=[];if("["===k){if(R("["),F(),"]"===k)return R("]"),e;for(;k;){if(e.push(O()),F(),"]"===k)return R("]"),e;R(","),F()}}D("Bad array")}();case'"':return I();case"-":return z();default:return k>="0"&&k<="9"?z():function(){switch(k){case"t":return R("t"),R("r"),R("u"),R("e"),!0;case"f":return R("f"),R("a"),R("l"),R("s"),R("e"),!1;case"n":return R("n"),R("u"),R("l"),R("l"),null}D("Unexpected '"+k+"'")}()}};var L,j,U,P=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,M={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function q(e){return P.lastIndex=0,P.test(e)?'"'+e.replace(P,function(e){var t=M[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}var H="undefined"!=typeof JSON?JSON:{parse:function(e,t){var n;return C=e,w=0,k=" ",n=O(),F(),k&&D("Syntax error"),"function"==typeof t?function e(n,r){var i,o,a=n[r];if(a&&"object"==typeof a)for(i in a)Object.prototype.hasOwnProperty.call(a,i)&&(void 0!==(o=e(a,i))?a[i]=o:delete a[i]);return t.call(n,r,a)}({"":n},""):n},stringify:function(e,t,n){var r;if(L="",j="","number"==typeof n)for(r=0;r<n;r+=1)j+=" ";else"string"==typeof n&&(j=n);if(U=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return function e(t,n){var r,i,o,a,u,s=L,c=n[t];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(t)),"function"==typeof U&&(c=U.call(n,t,c)),typeof c){case"string":return q(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(L+=j,u=[],"[object Array]"===Object.prototype.toString.apply(c)){for(a=c.length,r=0;r<a;r+=1)u[r]=e(r,c)||"null";return o=0===u.length?"[]":L?"[\n"+L+u.join(",\n"+L)+"\n"+s+"]":"["+u.join(",")+"]",L=s,o}if(U&&"object"==typeof U)for(a=U.length,r=0;r<a;r+=1)"string"==typeof(i=U[r])&&(o=e(i,c))&&u.push(q(i)+(L?": ":":")+o);else for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(o=e(i,c))&&u.push(q(i)+(L?": ":":")+o);return o=0===u.length?"{}":L?"{\n"+L+u.join(",\n"+L)+"\n"+s+"}":"{"+u.join(",")+"}",L=s,o}}("",{"":e})}},W=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var n=t.space||"";"number"==typeof n&&(n=Array(n+1).join(" "));var r,i="boolean"==typeof t.cycles&&t.cycles,o=t.replacer||function(e,t){return t},a=t.cmp&&(r=t.cmp,function(e){return function(t,n){var i={key:t,value:e[t]},o={key:n,value:e[n]};return r(i,o)}}),u=[];return function e(t,r,s,c){var l=n?"\n"+new Array(c+1).join(n):"",f=n?": ":":";if(s&&s.toJSON&&"function"==typeof s.toJSON&&(s=s.toJSON()),void 0!==(s=o.call(t,r,s))){if("object"!=typeof s||null===s)return H.stringify(s);if(B(s)){for(var d=[],p=0;p<s.length;p++){var h=e(s,p,s[p],c+1)||H.stringify(null);d.push(l+n+h)}return"["+d.join(",")+l+"]"}if(-1!==u.indexOf(s)){if(i)return H.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}u.push(s);var m=Y(s).sort(a&&a(s));for(d=[],p=0;p<m.length;p++){var g=e(s,r=m[p],s[r],c+1);if(g){var v=H.stringify(r)+f+g;d.push(l+n+v)}}return u.splice(u.indexOf(s),1),"{"+d.join(",")+l+"}"}}({"":e},"",e,0)},B=Array.isArray||function(e){return"[object Array]"==={}.toString.call(e)},Y=Object.keys||function(e){var t=Object.prototype.hasOwnProperty||function(){return!0},n=[];for(var r in e)t.call(e,r)&&n.push(r);return n};function G(e){return!!e.or}function V(e){return!!e.and}function X(e){return!!e.not}var K=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var r,i,o,a=N(t),u=N(n);if(a&&u){if((i=t.length)!=n.length)return!1;for(r=i;0!=r--;)if(!e(t[r],n[r]))return!1;return!0}if(a!=u)return!1;var s=t instanceof Date,c=n instanceof Date;if(s!=c)return!1;if(s&&c)return t.getTime()==n.getTime();var l=t instanceof RegExp,f=n instanceof RegExp;if(l!=f)return!1;if(l&&f)return t.toString()==n.toString();var d=A(t);if((i=d.length)!==A(n).length)return!1;for(r=i;0!=r--;)if(!T.call(n,d[r]))return!1;for(r=i;0!=r--;)if(!e(t[o=d[r]],n[o]))return!1;return!0}return t!=t&&n!=n};function Q(e,t){for(var n={},r=0,i=t;r<i.length;r++){var o=i[r];e.hasOwnProperty(o)&&(n[o]=e[o])}return n}function J(e,t){for(var n=S({},e),r=0,i=t;r<i.length;r++){delete n[i[r]]}return n}var Z=W;function $(e){if(v(e))return e;var t=a(e)?e:W(e);if(t.length<250)return t;for(var n=0,r=0;r<t.length;r++){n=(n<<5)-n+t.charCodeAt(r),n&=n}return n}function ee(e,t){return e.indexOf(t)>-1}function te(e,t){return e.filter(function(e){return!ee(t,e)})}function ne(e,t){for(var n=0,r=0;r<e.length;r++)if(t(e[r],r,n++))return!0;return!1}function re(e,t){for(var n=0,r=0;r<e.length;r++)if(!t(e[r],r,n++))return!1;return!0}function ie(e){var t;return(t=[]).concat.apply(t,e)}function oe(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=0,i=t;r<i.length;r++){e=ae(e,i[r])}return e}function ae(e,t){if("object"!=typeof t||null===t)return e;for(var n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&("object"!=typeof t[n]||i(t[n])||null===t[n]?e[n]=t[n]:"object"!=typeof e[n]||null===e[n]?e[n]=oe(i(t[n].constructor)?[]:{},t[n]):oe(e[n],t[n]));return e}function ue(e,t){for(var n,r=[],i={},o=0,a=e;o<a.length;o++){var u=a[o];(n=t(u))in i||(i[n]=1,r.push(u))}return r}function se(e,t){var n=de(e),r=de(t);if(n.length!==r.length)return!1;for(var i=0,o=n;i<o.length;i++){var a=o[i];if(e[a]!==t[a])return!1}return!0}function ce(e,t){for(var n in e)if(n in t)return!0;return!1}function le(e){for(var t={},n=function(e){var n=r(e).map(function(e,t){return 0===t?e:"["+e+"]"});n.map(function(e,t){return n.slice(0,t+1).join("")}).forEach(function(e){return t[e]=!0})},i=0,o=de(e);i<o.length;i++){n(o[i])}return t}function fe(e,t){return ce(le(e),le(t))}var de=Object.keys;function pe(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function he(e){return de(e)}function me(e){return JSON.parse(JSON.stringify(e))}function ge(e){return!0===e||!1===e}function ve(e){var t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function ye(e,t){return X(e)?"!("+ye(e.not,t)+")":V(e)?"("+e.and.map(function(e){return ye(e,t)}).join(") && (")+")":G(e)?"("+e.or.map(function(e){return ye(e,t)}).join(") || (")+")":t(e)}function be(e,t){if(0===t.length)return!0;var n=t.shift();return be(e[n],t)&&delete e[n],0===Object.keys(e).length}function xe(e){return e.charAt(0).toUpperCase()+e.substr(1)}function Se(e,t){void 0===t&&(t="datum");for(var n=r(e),i=[],o=1;o<=n.length;o++){var a="["+n.slice(0,o).map(u).join("][")+"]";i.push(""+t+a)}return i.join(" && ")}function Ee(e,t){return void 0===t&&(t="datum"),t+"["+u(r(e).join("."))+"]"}function we(e){return""+r(e).map(function(e){return e.replace(".","\\.")}).join("\\.")}function ke(e){return""+r(e).join(".")}function Ce(e){return e?r(e).length:0}function Oe(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,r=e;n<r.length;n++){var i=r[n];if(void 0!==i)return i}}var Ne=42;function Ae(e){var t=++Ne;return e?String(e)+t:t}var Te=Object.freeze({deepEqual:K,pick:Q,omit:J,stringify:Z,hash:$,contains:ee,without:te,union:function(e,t){return e.concat(te(t,e))},some:ne,every:re,flatten:ie,fill:function(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e;return n},mergeDeep:oe,unique:ue,isEqual:se,hasIntersection:ce,prefixGenerator:le,fieldIntersection:fe,isNumeric:function(e){return!isNaN(e)},differArray:function(e,t){if(e.length!==t.length)return!0;e.sort(),t.sort();for(var n=0;n<e.length;n++)if(t[n]!==e[n])return!0;return!1},keys:de,vals:pe,entries:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({key:n,value:e[n]});return t},flagKeys:he,duplicate:me,isBoolean:ge,varName:ve,logicalExpr:ye,deleteNestedProperty:be,titlecase:xe,accessPathWithDatum:Se,flatAccessWithDatum:Ee,replacePathInField:we,removePathFromField:ke,accessPathDepth:Ce,getFirstDefined:Oe,uniqueId:Ae,resetIdCounter:function(){Ne=42}}),_e={argmax:1,argmin:1,average:1,count:1,distinct:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},De=he(_e);function Re(e){return!!_e[e]}var ze=["count","valid","missing","distinct"];function Ie(e){return e&&ee(ze,e)}function Fe(e){return e&&ee(["min","max"],e)}var Le=["count","sum","distinct","valid","missing"],je=["mean","average","median","q1","q3","min","max"],Ue=y(je),Pe=Object.freeze({AGGREGATE_OPS:De,isAggregateOp:Re,COUNTING_OPS:ze,isCountingAggregateOp:Ie,isMinMaxOp:Fe,SUM_OPS:Le,SHARED_DOMAIN_OPS:je,SHARED_DOMAIN_OP_INDEX:Ue}),Me=["domain","grid","labels","ticks","title"],qe={grid:"grid",gridColor:"grid",gridDash:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"main",domain:"main",domainColor:"main",domainOpacity:"main",domainWidth:"main",format:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontWeight:"main",labelLimit:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",maxExtent:"main",minExtent:"main",offset:"main",position:"main",tickColor:"main",tickExtra:"main",tickOffset:"main",tickOpacity:"main",tickRound:"main",ticks:"main",tickSize:"main",title:"main",titleAlign:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontWeight:"main",titleLimit:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",tickWidth:"both",tickCount:"both",values:"both",scale:"both",zindex:"both"},He={orient:1,bandPosition:1,domain:1,domainColor:1,domainOpacity:1,domainWidth:1,format:1,grid:1,gridColor:1,gridDash:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,maxExtent:1,minExtent:1,offset:1,position:1,tickColor:1,tickCount:1,tickExtra:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,values:1,zindex:1},We=S({},He,{encoding:1,labelAngle:1,tickStep:1});function Be(e){return!!We[e]}var Ye,Ge,Ve=he(S({gridScale:1,scale:1},He,{encode:1})),Xe=he(We),Ke=Object.freeze({AXIS_PARTS:Me,AXIS_PROPERTY_TYPE:qe,isAxisProperty:Be,VG_AXIS_PROPERTIES:Ve,AXIS_PROPERTIES:Xe}),Qe=(Ye=d||l,{level:function(e){return arguments.length?(Ye=+e,this):Ye},error:function(){return Ye>=f&&c("error","ERROR",arguments),this},warn:function(){return Ye>=d&&c("warn","WARN",arguments),this},info:function(){return Ye>=p&&c("log","INFO",arguments),this},debug:function(){return Ye>=h&&c("log","DEBUG",arguments),this}}),Je=Qe;function Ze(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Je.warn.apply(Je,arguments)}!function(e){e.INVALID_SPEC="Invalid spec",e.FIT_NON_SINGLE='Autosize "fit" only works for single views and layered views.',e.CANNOT_FIX_RANGE_STEP_WITH_FIT='Cannot use a fixed value of "rangeStep" when "autosize" is "fit".',e.cannotProjectOnChannelWithoutField=function(e){return'Cannot project a selection on encoding channel "'+e+'", which has no field.'},e.nearestNotSupportForContinuous=function(e){return'The "nearest" transform is not supported for '+e+" marks."},e.selectionNotSupported=function(e){return"Selection not supported for "+e+" yet"},e.selectionNotFound=function(e){return'Cannot find a selection named "'+e+'"'},e.SCALE_BINDINGS_CONTINUOUS="Scale bindings are currently only supported for scales with unbinned, continuous domains.",e.noSuchRepeatedValue=function(e){return'Unknown repeated value "'+e+'".'},e.CONCAT_CANNOT_SHARE_AXIS="Axes cannot be shared in concatenated views.",e.REPEAT_CANNOT_SHARE_AXIS="Axes cannot be shared in repeated views.",e.cannotSetTitleAnchor=function(e){return'Cannot set title "anchor" for a '+e+" spec"},e.unrecognizedParse=function(e){return'Unrecognized parse "'+e+'".'},e.differentParse=function(e,t,n){return'An ancestor parsed field "'+e+'" as '+n+" but a child wants to parse the field as "+t+"."},e.invalidTransformIgnored=function(e){return"Ignoring an invalid transform: "+Z(e)+"."},e.NO_FIELDS_NEEDS_AS='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.',e.encodingOverridden=function(e){return"Layer's shared "+e.join(",")+" channel "+(1===e.length?"is":"are")+" overriden"},e.projectionOverridden=function(e){var t=e.parentProjection,n=e.projection;return"Layer's shared projection "+Z(t)+" is overridden by a child projection "+Z(n)+"."},e.primitiveChannelDef=function(e,t,n){return"Channel "+e+" is a "+t+". Converted to {value: "+Z(n)+"}."},e.invalidFieldType=function(e){return'Invalid field type "'+e+'"'},e.nonZeroScaleUsedWithLengthMark=function(e,t,n){return"A "+(n.scaleType?n.scaleType+" scale":n.zeroFalse?"scale with zero=false":"scale with custom domain that excludes zero")+" is used to encode "+e+"'s "+t+". This can be misleading as the "+("x"===t?"width":"height")+" of the "+e+" can be arbitrary based on the scale domain. You may want to use point mark instead."},e.invalidFieldTypeForCountAggregate=function(e,t){return'Invalid field type "'+e+'" for aggregate: "'+t+'", using "quantitative" instead.'},e.invalidAggregate=function(e){return'Invalid aggregation operator "'+e+'"'},e.emptyOrInvalidFieldType=function(e,t,n){return'Invalid field type "'+e+'" for channel "'+t+'", using "'+n+'" instead.'},e.droppingColor=function(e,t){var n=t.fill,r=t.stroke;return"Dropping color "+e+" as the plot also has "+(n&&r?"fill and stroke":n?"fill":"stroke")},e.emptyFieldDef=function(e,t){return"Dropping "+Z(e)+' from channel "'+t+'" since it does not contain data field or value.'},e.latLongDeprecated=function(e,t,n){return e+"-encoding with type "+t+" is deprecated. Replacing with "+n+"-encoding."},e.LINE_WITH_VARYING_SIZE="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.",e.incompatibleChannel=function(e,t,n){return e+' dropped as it is incompatible with "'+t+'"'+(n?" when "+n:"")+"."},e.invalidEncodingChannel=function(e){return e+"-encoding is dropped as "+e+" is not a valid encoding channel."},e.facetChannelShouldBeDiscrete=function(e){return e+" encoding should be discrete (ordinal / nominal / binned)."},e.discreteChannelCannotEncode=function(e,t){return'Using discrete channel "'+e+'" to encode "'+t+'" field can be misleading as it does not encode '+("ordinal"===t?"order":"magnitude")+"."},e.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL="Bar mark should not be used with point scale when rangeStep is null. Please use band scale instead.",e.lineWithRange=function(e,t){return"Line mark is for continuous lines and thus cannot be used with "+(e&&t?"x2 and y2":e?"x2":"y2")+". We will use the rule mark (line segments) instead."},e.orientOverridden=function(e,t){return'Specified orient "'+e+'" overridden with "'+t+'"'},e.CANNOT_UNION_CUSTOM_DOMAIN_WITH_FIELD_DOMAIN="custom domain scale cannot be unioned with default field-based domain",e.cannotUseScalePropertyWithNonColor=function(e){return'Cannot use the scale property "'+e+'" with non-color channel.'},e.unaggregateDomainHasNoEffectForRawField=function(e){return"Using unaggregated domain with raw field has no effect ("+Z(e)+")."},e.unaggregateDomainWithNonSharedDomainOp=function(e){return'Unaggregated domain not applicable for "'+e+'" since it produces values outside the origin domain of the source data.'},e.unaggregatedDomainWithLogScale=function(e){return"Unaggregated domain is currently unsupported for log scale ("+Z(e)+")."},e.cannotApplySizeToNonOrientedMark=function(e){return'Cannot apply size to non-oriented mark "'+e+'".'},e.rangeStepDropped=function(e){return'rangeStep for "'+e+'" is dropped as top-level '+("x"===e?"width":"height")+" is provided."},e.scaleTypeNotWorkWithChannel=function(e,t,n){return'Channel "'+e+'" does not work with "'+t+'" scale. We are using "'+n+'" scale instead.'},e.scaleTypeNotWorkWithFieldDef=function(e,t){return'FieldDef does not work with "'+e+'" scale. We are using "'+t+'" scale instead.'},e.scalePropertyNotWorkWithScaleType=function(e,t,n){return n+"-scale's \""+t+'" is dropped as it does not work with '+e+" scale."},e.scaleTypeNotWorkWithMark=function(e,t){return'Scale type "'+t+'" does not work with mark "'+e+'".'},e.mergeConflictingProperty=function(e,t,n,r){return"Conflicting "+t.toString()+' property "'+e.toString()+'" ('+Z(n)+" and "+Z(r)+").  Using "+Z(n)+"."},e.independentScaleMeansIndependentGuide=function(e){return'Setting the scale to be independent for "'+e+'" means we also have to set the guide (axis or legend) to be independent.'},e.domainSortDropped=function(e){return"Dropping sort property "+Z(e)+" as unioned domains only support boolean or op 'count'."},e.UNABLE_TO_MERGE_DOMAINS="Unable to merge domains",e.MORE_THAN_ONE_SORT="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",e.INVALID_CHANNEL_FOR_AXIS="Invalid channel for axis.",e.cannotStackRangedMark=function(e){return'Cannot stack "'+e+'" if there is already "'+e+'2"'},e.cannotStackNonLinearScale=function(e){return"Cannot stack non-linear scale ("+e+")"},e.stackNonSummativeAggregate=function(e){return'Stacking is applied even though the aggregate function is non-summative ("'+e+'")'},e.invalidTimeUnit=function(e,t){return"Invalid "+e+": "+Z(t)},e.dayReplacedWithDate=function(e){return'Time unit "'+e+'" is not supported. We are replacing it with '+e.replace("day","date")+"."},e.droppedDay=function(e){return"Dropping day from datetime "+Z(e)+" as day cannot be combined with other units."},e.errorBarCenterAndExtentAreNotNeeded=function(e,t){return(t?"extent ":"")+(t&&e?"and ":"")+(e?"center ":"")+(t&&e?"are ":"is ")+"not needed when data are aggregated."},e.errorBarCenterIsUsedWithWrongExtent=function(e,t,n){return e+" is not usually used with "+t+" for "+n+"."},e.errorBarContinuousAxisHasCustomizedAggregate=function(e,t){return"Continuous axis should not have customized aggregation function "+e+"; "+t+" already agregates the axis."},e.errorBarCenterIsNotNeeded=function(e,t){return"Center is not needed to be specified in "+t+" when extent is "+e+"."},e.errorBand1DNotSupport=function(e){return"1D error band does not support "+e},e.channelRequiredForBinned=function(e){return"Channel "+e+' is required for "binned" bin'},e.domainRequiredForThresholdScale=function(e){return"Domain for "+e+" is required for threshold scale"}}(Ge||(Ge={}));var $e=2006;function et(e){return!!(e&&(e.year||e.quarter||e.month||e.date||e.day||e.hours||e.minutes||e.seconds||e.milliseconds))}var tt=["january","february","march","april","may","june","july","august","september","october","november","december"],nt=tt.map(function(e){return e.substr(0,3)}),rt=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],it=rt.map(function(e){return e.substr(0,3)});function ot(e,t){void 0===t&&(t=!1);var n=[];if(t&&void 0!==e.day&&de(e).length>1&&(Ze(Ge.droppedDay(e)),delete(e=me(e)).day),void 0!==e.year?n.push(e.year):void 0!==e.day?n.push($e):n.push(0),void 0!==e.month){var r=t?function(e){if(v(e))return(e-1).toString();var t=e.toLowerCase(),n=tt.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=nt.indexOf(r);if(-1!==i)return i+"";throw new Error(Ge.invalidTimeUnit("month",e))}(e.month):e.month;n.push(r)}else if(void 0!==e.quarter){var i=t?function(e){if(v(e))return e>4&&Ze(Ge.invalidTimeUnit("quarter",e)),(e-1).toString();throw new Error(Ge.invalidTimeUnit("quarter",e))}(e.quarter):e.quarter;n.push(i+"*3")}else n.push(0);if(void 0!==e.date)n.push(e.date);else if(void 0!==e.day){var o=t?function(e){if(v(e))return e%7+"";var t=e.toLowerCase(),n=rt.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=it.indexOf(r);if(-1!==i)return i+"";throw new Error(Ge.invalidTimeUnit("day",e))}(e.day):e.day;n.push(o+"+1")}else n.push(1);for(var a=0,u=["hours","minutes","seconds","milliseconds"];a<u.length;a++){var s=u[a];void 0!==e[s]?n.push(e[s]):n.push(0)}return e.utc?"utc("+n.join(", ")+")":"datetime("+n.join(", ")+")"}var at=Object.freeze({isDateTime:et,MONTHS:tt,SHORT_MONTHS:nt,DAYS:rt,SHORT_DAYS:it,dateTimeExpr:ot});function ut(e){return!!e&&!!e.header}var st,ct=Object.freeze({isFacetFieldDef:ut});!function(e){e.YEAR="year",e.MONTH="month",e.DAY="day",e.DATE="date",e.HOURS="hours",e.MINUTES="minutes",e.SECONDS="seconds",e.MILLISECONDS="milliseconds",e.YEARMONTH="yearmonth",e.YEARMONTHDATE="yearmonthdate",e.YEARMONTHDATEHOURS="yearmonthdatehours",e.YEARMONTHDATEHOURSMINUTES="yearmonthdatehoursminutes",e.YEARMONTHDATEHOURSMINUTESSECONDS="yearmonthdatehoursminutesseconds",e.MONTHDATE="monthdate",e.MONTHDATEHOURS="monthdatehours",e.HOURSMINUTES="hoursminutes",e.HOURSMINUTESSECONDS="hoursminutesseconds",e.MINUTESSECONDS="minutesseconds",e.SECONDSMILLISECONDS="secondsmilliseconds",e.QUARTER="quarter",e.YEARQUARTER="yearquarter",e.QUARTERMONTH="quartermonth",e.YEARQUARTERMONTH="yearquartermonth",e.UTCYEAR="utcyear",e.UTCMONTH="utcmonth",e.UTCDAY="utcday",e.UTCDATE="utcdate",e.UTCHOURS="utchours",e.UTCMINUTES="utcminutes",e.UTCSECONDS="utcseconds",e.UTCMILLISECONDS="utcmilliseconds",e.UTCYEARMONTH="utcyearmonth",e.UTCYEARMONTHDATE="utcyearmonthdate",e.UTCYEARMONTHDATEHOURS="utcyearmonthdatehours",e.UTCYEARMONTHDATEHOURSMINUTES="utcyearmonthdatehoursminutes",e.UTCYEARMONTHDATEHOURSMINUTESSECONDS="utcyearmonthdatehoursminutesseconds",e.UTCMONTHDATE="utcmonthdate",e.UTCMONTHDATEHOURS="utcmonthdatehours",e.UTCHOURSMINUTES="utchoursminutes",e.UTCHOURSMINUTESSECONDS="utchoursminutesseconds",e.UTCMINUTESSECONDS="utcminutesseconds",e.UTCSECONDSMILLISECONDS="utcsecondsmilliseconds",e.UTCQUARTER="utcquarter",e.UTCYEARQUARTER="utcyearquarter",e.UTCQUARTERMONTH="utcquartermonth",e.UTCYEARQUARTERMONTH="utcyearquartermonth"}(st||(st={}));var lt={year:1,quarter:1,month:1,day:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},ft=he(lt);function dt(e){return!!lt[e]}var pt={utcyear:1,utcquarter:1,utcmonth:1,utcday:1,utcdate:1,utchours:1,utcminutes:1,utcseconds:1,utcmilliseconds:1};function ht(e){return!!pt[e]}var mt={utcyearquarter:1,utcyearquartermonth:1,utcyearmonth:1,utcyearmonthdate:1,utcyearmonthdatehours:1,utcyearmonthdatehoursminutes:1,utcyearmonthdatehoursminutesseconds:1,utcquartermonth:1,utcmonthdate:1,utcmonthdatehours:1,utchoursminutes:1,utchoursminutesseconds:1,utcminutesseconds:1,utcsecondsmilliseconds:1},gt=S({},pt,mt);function vt(e){return!!gt[e]}function yt(e){return e.substr(3)}var bt=S({},lt,pt,{yearquarter:1,yearquartermonth:1,yearmonth:1,yearmonthdate:1,yearmonthdatehours:1,yearmonthdatehoursminutes:1,yearmonthdatehoursminutesseconds:1,quartermonth:1,monthdate:1,monthdatehours:1,hoursminutes:1,hoursminutesseconds:1,minutesseconds:1,secondsmilliseconds:1},mt),xt=he(bt);var St={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",quarter:null,day:null};function Et(e,t){var n=St[e];return{setDateMethod:t?"setUTC"+n.substr(3):n,getDateMethod:"get"+(t?"UTC":"")+n.substr(3)}}function wt(e){return ft.reduce(function(t,n){return kt(e,n)?t.concat(n):t},[])}function kt(e,t){var n=e.indexOf(t);return n>-1&&(t!==st.SECONDS||0===n||"i"!==e.charAt(n-1))}function Ct(e,t){var n=Se(t),r=vt(e)?"utc":"";return ot(ft.reduce(function(t,i){var o;return kt(e,i)&&(t[i]=(o=i)===st.QUARTER?"("+r+"quarter("+n+")-1)":""+r+o+"("+n+")"),t},{}))}function Ot(e,t){if(e){var n=[],r=kt(e,st.YEAR);kt(e,st.MONTH)&&n.push(!1!==t?"%b":"%B"),kt(e,st.DAY)?n.push(t?"%a":"%A"):kt(e,st.DATE)&&n.push("%d"+(r?",":"")),r&&n.push(t?"%y":"%Y");var i=[];kt(e,st.HOURS)&&i.push("%H"),kt(e,st.MINUTES)&&i.push("%M"),kt(e,st.SECONDS)&&i.push("%S"),kt(e,st.MILLISECONDS)&&i.push("%L");var o=[];return n.length>0&&o.push(n.join(" ")),i.length>0&&o.push(i.join(":")),o}}function Nt(e,t,n,r){if(e){var i=Ot(e,n),o="";return kt(e,st.QUARTER)&&(o="'Q' + quarter("+t+")"),i.length>0&&(o&&(o+=" + ' ' + "),o+=r?"utcFormat("+t+", '"+i.join(" ")+"')":"timeFormat("+t+", '"+i.join(" ")+"')"),o||void 0}}function At(e){return"day"!==e&&e.indexOf("day")>=0?(Ze(Ge.dayReplacedWithDate(e)),e.replace("day","date")):e}var Tt,_t=Object.freeze({get TimeUnit(){return st},TIMEUNIT_PARTS:ft,isLocalSingleTimeUnit:dt,isUtcSingleTimeUnit:ht,isUTCTimeUnit:vt,getLocalTimeUnit:yt,TIMEUNITS:xt,isTimeUnit:function(e){return!!bt[e]},convert:function(e,t){for(var n=vt(e),r=n?new Date(Date.UTC(1972,0,1,0,0,0,0)):new Date(1972,0,1,0,0,0,0),i=0,o=ft;i<o.length;i++){var a=o[i];if(kt(e,a))switch(a){case st.DAY:throw new Error("Cannot convert to TimeUnits containing 'day'");case st.QUARTER:var u=Et("month",n),s=u.getDateMethod;r[u.setDateMethod](3*Math.floor(t[s]()/3));break;default:var c=Et(a,n),l=c.getDateMethod;r[c.setDateMethod](t[l]())}}return r},getTimeUnitParts:wt,containsTimeUnit:kt,fieldExpr:Ct,getDateTimeComponents:Ot,formatExpression:Nt,normalizeTimeUnit:At});!function(e){e.QUANTITATIVE="quantitative",e.ORDINAL="ordinal",e.TEMPORAL="temporal",e.NOMINAL="nominal",e.GEOJSON="geojson"}(Tt||(Tt={}));var Dt={quantitative:1,ordinal:1,temporal:1,nominal:1,geojson:1};var Rt=Tt.QUANTITATIVE,zt=Tt.ORDINAL,It=Tt.TEMPORAL,Ft=Tt.NOMINAL,Lt=Tt.GEOJSON;function jt(e){if(e)switch(e=e.toLowerCase()){case"q":case Rt:return"quantitative";case"t":case It:return"temporal";case"o":case zt:return"ordinal";case"n":case Ft:return"nominal";case Lt:return"geojson"}}var Ut=Object.freeze({get Type(){return Tt},TYPE_INDEX:Dt,isType:function(e){return!!Dt[e]},QUANTITATIVE:Rt,ORDINAL:zt,TEMPORAL:It,NOMINAL:Ft,GEOJSON:Lt,getFullName:jt});function Pt(e){return e.selection}function Mt(e){return e&&!a(e)&&"repeat"in e}function qt(e){var t=e.field,n=e.timeUnit,r=e.bin,i=e.aggregate;return S({},n?{timeUnit:n}:{},r?{bin:r}:{},i?{aggregate:i}:{},{field:t})}function Ht(e){return!!e&&!!e.condition}function Wt(e){return!!e&&!!e.condition&&!i(e.condition)&&Yt(e.condition)}function Bt(e){return!!e&&!!e.condition&&(i(e.condition)||Vt(e.condition))}function Yt(e){return!(!e||!e.field&&"count"!==e.aggregate)}function Gt(e){return Yt(e)&&a(e.field)}function Vt(e){return e&&"value"in e&&void 0!==e.value}function Xt(e){return!(!e||!e.scale&&!e.sort)}function Kt(e){return!(!e||!e.axis&&!e.stack&&!e.impute)}function Qt(e){return!!e&&!!e.legend}function Jt(e){return!!e&&!!e.format}function Zt(e,t){void 0===t&&(t={});var n=e.field,r=t.prefix,i=t.suffix;if(tn(e))n="count_*";else{var o=void 0;t.nofn||(!function(e){return!!e.op}(e)?$r(e.bin)?(o=Zr(e.bin),i=t.binSuffix||""):e.aggregate?o=String(e.aggregate):e.timeUnit&&(o=String(e.timeUnit)):o=e.op),o&&(n=n?o+"_"+n:o)}return i&&(n=n+"_"+i),r&&(n=r+"_"+n),t.forAs?n:t.expr?Ee(n,t.expr):we(n)}function $t(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return!!e.bin;case"temporal":return!1}throw new Error(Ge.invalidFieldType(e.type))}function en(e){return!$t(e)}function tn(e){return"count"===e.aggregate}function nn(e,t){var n=e.field,r=e.bin,i=e.timeUnit,o=e.aggregate;return"count"===o?t.countTitle:$r(r)?n+" (binned)":i?n+" ("+wt(i).join("-")+")":o?xe(o)+" of "+n:n}function rn(e,t){var n=e.aggregate||e.timeUnit||$r(e.bin)&&"bin";return n?n.toUpperCase()+"("+e.field+")":e.field}var on=function(e,t){switch(t.fieldTitle){case"plain":return e.field;case"functional":return rn(e);default:return nn(e,t)}},an=on;function un(e){an=e}function sn(){un(on)}function cn(e,t,n){var r=n.allowDisabling,i=(ln(e)||{}).title;return r?Oe(i,e.title,fn(e,t)):i||e.title||fn(e,t)}function ln(e){return Kt(e)&&e.axis?e.axis:Qt(e)&&e.legend?e.legend:ut(e)&&e.header?e.header:void 0}function fn(e,t){return an(e,t)}function dn(e){return Jt(e)&&e.format?e.format:(ln(e)||{}).format}function pn(e,t){if(e.timeUnit)return"temporal";if($r(e.bin))return"quantitative";switch(Qr(t)){case"continuous":return"quantitative";case"discrete":case"flexible":return"nominal";default:return"quantitative"}}function hn(e){return Yt(e)?e:Wt(e)?e.condition:void 0}function mn(e,t){if(a(e)||v(e)||g(e)){var n=a(e)?"string":v(e)?"number":"boolean";return Ze(Ge.primitiveChannelDef(t,n,e)),{value:e}}return Yt(e)?gn(e,t):Wt(e)?S({},e,{condition:gn(e.condition,t)}):e}function gn(e,t){if(e.aggregate&&!Re(e.aggregate)){e.aggregate;var n=E(e,["aggregate"]);Ze(Ge.invalidAggregate(e.aggregate)),e=n}if(e.timeUnit&&(e=S({},e,{timeUnit:At(e.timeUnit)})),$r(e.bin)&&(e=S({},e,{bin:vn(e.bin,t)})),ei(e.bin)&&!ee(qr,t)&&Ze("Channel "+t+' should not be used with "binned" bin'),e.type){var r=jt(e.type);e.type!==r&&(e=S({},e,{type:r})),"quantitative"!==e.type&&Ie(e.aggregate)&&(Ze(Ge.invalidFieldTypeForCountAggregate(e.type,e.aggregate)),e=S({},e,{type:"quantitative"}))}else{var i=pn(e,t);Ze(Ge.emptyOrInvalidFieldType(e.type,t,i)),e=S({},e,{type:i})}var o=bn(e,t),a=o.compatible,u=o.warning;return a||Ze(u),e}function vn(e,t){return g(e)?{maxbins:ni(t)}:e.maxbins||e.step?e:S({},e,{maxbins:ni(t)})}var yn={compatible:!0};function bn(e,t){var n=e.type;if("geojson"===n&&"shape"!==t)return{compatible:!1,warning:"Channel "+t+" should not be used with a geojson data."};switch(t){case"row":case"column":return en(e)?{compatible:!1,warning:Ge.facetChannelShouldBeDiscrete(t)}:yn;case"x":case"y":case"color":case"fill":case"stroke":case"text":case"detail":case"key":case"tooltip":case"href":return yn;case"longitude":case"longitude2":case"latitude":case"latitude2":return n!==Rt?{compatible:!1,warning:"Channel "+t+" should be used with a quantitative field only, not "+e.type+" field."}:yn;case"opacity":case"fillOpacity":case"strokeOpacity":case"strokeWidth":case"size":case"x2":case"y2":return"nominal"!==n||e.sort?yn:{compatible:!1,warning:"Channel "+t+" should not be used with an unsorted discrete field."};case"shape":return ee(["ordinal","nominal","geojson"],e.type)?yn:{compatible:!1,warning:"Shape channel should be used with only either discrete or geojson data."};case"order":return"nominal"!==e.type||"sort"in e?yn:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}throw new Error("channelCompatability not implemented for channel "+t)}function xn(e){return"quantitative"===e.type||$r(e.bin)}function Sn(e){return"temporal"===e.type||!!e.timeUnit}function En(e,t){var n,r,i=t.timeUnit,o=t.type,u=t.time,s=t.undefinedIfExprNotRequired;return et(e)?r=ot(e,!0):(a(e)||v(e))&&(i||"temporal"===o)&&(r=dt(i)?ot(((n={})[i]=e,n),!0):ht(i)?En(e,{timeUnit:yt(i)}):"datetime("+JSON.stringify(e)+")"),r?u?"time("+r+")":r:s?void 0:JSON.stringify(e)}function wn(e,t){var n=e.timeUnit,r=e.type;return t.map(function(e){var t=En(e,{timeUnit:n,type:r,undefinedIfExprNotRequired:!0});return void 0!==t?{signal:t}:e})}var kn,Cn=Object.freeze({isConditionalSelection:Pt,isRepeatRef:Mt,toFieldDefBase:qt,isConditionalDef:Ht,hasConditionalFieldDef:Wt,hasConditionalValueDef:Bt,isFieldDef:Yt,isStringFieldDef:Gt,isValueDef:Vt,isScaleFieldDef:Xt,isPositionFieldDef:Kt,isMarkPropFieldDef:Qt,isTextFieldDef:Jt,vgField:Zt,isDiscrete:$t,isContinuous:en,isCount:tn,verbalTitleFormatter:nn,functionalTitleFormatter:rn,defaultTitleFormatter:on,setTitleFormatter:un,resetTitleFormatter:sn,title:cn,getGuide:ln,defaultTitle:fn,format:dn,defaultType:pn,getFieldDef:hn,normalize:mn,normalizeFieldDef:gn,normalizeBin:vn,channelCompatibility:bn,isNumberFieldDef:xn,isTimeFieldDef:Sn,valueExpr:En,valueArray:wn});!function(e){e.AREA="area",e.BAR="bar",e.LINE="line",e.POINT="point",e.RECT="rect",e.RULE="rule",e.TEXT="text",e.TICK="tick",e.TRAIL="trail",e.CIRCLE="circle",e.SQUARE="square",e.GEOSHAPE="geoshape"}(kn||(kn={}));var On=kn.AREA,Nn=kn.BAR,An=kn.LINE,Tn=kn.POINT,_n=kn.TEXT,Dn=kn.TICK,Rn=kn.TRAIL,zn=kn.RECT,In=kn.RULE,Fn=kn.GEOSHAPE,Ln=kn.CIRCLE,jn=kn.SQUARE,Un={area:1,bar:1,line:1,point:1,text:1,tick:1,trail:1,rect:1,geoshape:1,rule:1,circle:1,square:1};function Pn(e){return ee(["line","area","trail"],e)}var Mn=he(Un);function qn(e){return e.type}var Hn=y(Mn);function Wn(e){return(qn(e)?e.type:e)in Hn}var Bn,Yn=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],Gn=["fill","fillOpacity"],Vn=[].concat(Yn,Gn),Xn=["filled","color","tooltip"],Kn={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],text:["shortTimeLabels"],tick:["bandSize","thickness"]},Qn={color:"#4c78a8",tooltip:{content:"encoding"}},Jn={binSpacing:1,continuousBandSize:5},Zn={thickness:1},$n=Object.freeze({get Mark(){return kn},AREA:On,BAR:Nn,LINE:An,POINT:Tn,TEXT:_n,TICK:Dn,TRAIL:Rn,RECT:zn,RULE:In,GEOSHAPE:Fn,CIRCLE:Ln,SQUARE:jn,isMark:function(e){return!!Un[e]},isPathMark:Pn,PRIMITIVE_MARKS:Mn,isMarkDef:qn,isPrimitiveMark:Wn,STROKE_CONFIG:Yn,FILL_CONFIG:Gn,FILL_STROKE_CONFIG:Vn,VL_ONLY_MARK_CONFIG_PROPERTIES:Xn,VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX:Kn,defaultMarkConfig:Qn,defaultBarConfig:Jn,defaultTickConfig:Zn});!function(e){e.ROW="row",e.COLUMN="column",e.X="x",e.Y="y",e.X2="x2",e.Y2="y2",e.XERROR="xError",e.YERROR="yError",e.XERROR2="xError2",e.YERROR2="yError2",e.LATITUDE="latitude",e.LONGITUDE="longitude",e.LATITUDE2="latitude2",e.LONGITUDE2="longitude2",e.COLOR="color",e.FILL="fill",e.STROKE="stroke",e.SHAPE="shape",e.SIZE="size",e.OPACITY="opacity",e.FILLOPACITY="fillOpacity",e.STROKEOPACITY="strokeOpacity",e.STROKEWIDTH="strokeWidth",e.TEXT="text",e.ORDER="order",e.DETAIL="detail",e.KEY="key",e.TOOLTIP="tooltip",e.HREF="href"}(Bn||(Bn={}));var er=Bn.X,tr=Bn.Y,nr=Bn.X2,rr=Bn.Y2,ir=Bn.XERROR,or=Bn.YERROR,ar=Bn.XERROR2,ur=Bn.YERROR2,sr=Bn.LATITUDE,cr=Bn.LATITUDE2,lr=Bn.LONGITUDE,fr=Bn.LONGITUDE2,dr=Bn.ROW,pr=Bn.COLUMN,hr=Bn.SHAPE,mr=Bn.SIZE,gr=Bn.COLOR,vr=Bn.FILL,yr=Bn.STROKE,br=Bn.TEXT,xr=Bn.DETAIL,Sr=Bn.KEY,Er=Bn.ORDER,wr=Bn.OPACITY,kr=Bn.FILLOPACITY,Cr=Bn.STROKEOPACITY,Or=Bn.STROKEWIDTH,Nr=Bn.TOOLTIP,Ar=Bn.HREF,Tr={longitude:1,longitude2:1,latitude:1,latitude2:1},_r=he(Tr),Dr=S({x:1,y:1,x2:1,y2:1,xError:1,yError:1,xError2:1,yError2:1},Tr,{color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,size:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1});function Rr(e){return"color"===e||"fill"===e||"stroke"===e}var zr=S({},Dr,{row:1,column:1}),Ir=he(zr),Fr=(zr.order,zr.detail,he(E(zr,["order","detail"])));function Lr(e){return!!zr[e]}var jr=he(Dr),Ur=(Dr.x,Dr.y,Dr.x2,Dr.y2,Dr.xError,Dr.yError,Dr.xError2,Dr.yError2,Dr.latitude,Dr.longitude,Dr.latitude2,Dr.longitude2,E(Dr,["x","y","x2","y2","xError","yError","xError2","yError2","latitude","longitude","latitude2","longitude2"])),Pr=he(Ur),Mr={x:1,y:1},qr=he(Mr),Hr=E(Ur,["text","tooltip","href","detail","key","order"]),Wr=he(Hr);function Br(e){return!!Ur[e]}var Yr=S({},Mr,Hr),Gr=he(Yr);function Vr(e){return!!Yr[e]}function Xr(e,t,n){if(ee([Ln,Tn,jn,Dn],n)&&ee([nr,rr],t)){var r=e[t===nr?er:tr];return!!(Yt(r)&&Yt(e[t])&&ei(r.bin))}return n in Kr(t)}function Kr(e){switch(e){case gr:case vr:case yr:case xr:case Sr:case Nr:case Ar:case Er:case wr:case kr:case Cr:case Or:case dr:case pr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0,geoshape:!0};case er:case tr:case sr:case lr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0};case nr:case rr:case cr:case fr:return{rule:!0,bar:!0,rect:!0,area:!0};case mr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,text:!0,line:!0,trail:!0};case hr:return{point:!0,geoshape:!0};case br:return{text:!0};case ir:case or:case ar:case ur:return{}}}function Qr(e){switch(e){case er:case tr:case mr:case Or:case wr:case kr:case Cr:case nr:case rr:case ir:case or:case ar:case ur:return"continuous";case dr:case pr:case hr:case br:case Nr:case Ar:return"discrete";case gr:case vr:case yr:return"flexible";case sr:case lr:case cr:case fr:case xr:case Sr:case Er:return}throw new Error("rangeType not implemented for "+e)}var Jr=Object.freeze({get Channel(){return Bn},X:er,Y:tr,X2:nr,Y2:rr,XERROR:ir,YERROR:or,XERROR2:ar,YERROR2:ur,LATITUDE:sr,LATITUDE2:cr,LONGITUDE:lr,LONGITUDE2:fr,ROW:dr,COLUMN:pr,SHAPE:hr,SIZE:mr,COLOR:gr,FILL:vr,STROKE:yr,TEXT:br,DETAIL:xr,KEY:Sr,ORDER:Er,OPACITY:wr,FILLOPACITY:kr,STROKEOPACITY:Cr,STROKEWIDTH:Or,TOOLTIP:Nr,HREF:Ar,GEOPOSITION_CHANNEL_INDEX:Tr,GEOPOSITION_CHANNELS:_r,isColorChannel:Rr,CHANNELS:Ir,SINGLE_DEF_CHANNELS:Fr,isChannel:Lr,UNIT_CHANNELS:jr,NONPOSITION_CHANNELS:Pr,POSITION_SCALE_CHANNELS:qr,NONPOSITION_SCALE_CHANNELS:Wr,isNonPositionScaleChannel:Br,SCALE_CHANNELS:Gr,isScaleChannel:Vr,supportMark:Xr,getSupportedMark:Kr,rangeType:Qr});function Zr(e){return g(e)?"bin":"bin"+de(e).map(function(t){return ve("_"+t+"_"+e[t])}).join("")}function $r(e){return!0===e||ti(e)}function ei(e){return"binned"===e}function ti(e){return o(e)}function ni(e){switch(e){case dr:case pr:case mr:case gr:case vr:case yr:case Or:case wr:case kr:case Cr:case hr:return 6;default:return 10}}var ri,ii=Object.freeze({binToString:Zr,isBinning:$r,isBinned:ei,isBinParams:ti,autoMaxBins:ni});!function(e){e.LINEAR="linear",e.BIN_LINEAR="bin-linear",e.LOG="log",e.POW="pow",e.SQRT="sqrt",e.TIME="time",e.UTC="utc",e.SEQUENTIAL="sequential",e.QUANTILE="quantile",e.QUANTIZE="quantize",e.THRESHOLD="threshold",e.ORDINAL="ordinal",e.BIN_ORDINAL="bin-ordinal",e.POINT="point",e.BAND="band"}(ri||(ri={}));var oi={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric","bin-linear":"bin-linear",time:"time",utc:"time",sequential:"sequential",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"},ai=de(oi);function ui(e,t){var n=oi[e],r=oi[t];return n===r||"ordinal-position"===n&&"time"===r||"ordinal-position"===r&&"time"===n}var si={linear:0,log:1,pow:1,sqrt:1,time:0,utc:0,point:10,band:11,"bin-linear":0,sequential:0,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function ci(e){return si[e]}var li=["linear","bin-linear","log","pow","sqrt","time","utc"],fi=y(li),di=["quantile","quantize","threshold"],pi=y(di),hi=li.concat(["sequential","quantile","quantize","threshold"]),mi=y(hi),gi=["ordinal","bin-ordinal","point","band"],vi=y(gi),yi=y(["bin-linear","bin-ordinal"]);function bi(e){return e in vi}function xi(e){return e in yi}function Si(e){return e in mi}function Ei(e){return e in fi}function wi(e){return e in pi}var ki={textXRangeStep:90,rangeStep:21,pointPadding:.5,bandPaddingInner:.1,facetSpacing:16,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4};function Ci(e){return e&&!!e.name}function Oi(e){return e&&e.selection}var Ni={type:1,domain:1,range:1,rangeStep:1,scheme:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},Ai=he(Ni),Ti=he(E(Ni,["type","domain","range","rangeStep","scheme"])),_i=function(){for(var e={},t=0,n=Ir;t<n.length;t++)for(var r=n[t],i=0,o=de(Dt);i<o.length;i++)for(var a=o[i],u=0,s=ai;u<s.length;u++)for(var c=s[u],l=0,f=[!1,!0];l<f.length;l++){var d=f[l],p=Fi(r,a,d);Ii(r,c)&&zi(c,a,d)&&(e[p]=e[p]||[],e[p].push(c))}return e}();function Di(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":return ee(["sequential","ordinal","bin-ordinal","quantile","quantize","threshold"],e);case"interpolate":return ee(["linear","bin-linear","pow","log","sqrt","utc","time"],e);case"round":return Ei(e)||"band"===e||"point"===e;case"padding":return Ei(e)||ee(["point","band"],e);case"paddingOuter":case"rangeStep":return ee(["point","band"],e);case"paddingInner":return"band"===e;case"clamp":return Ei(e)||"sequential"===e;case"nice":return Ei(e)||"sequential"===e||"quantize"===e;case"exponent":return"pow"===e;case"base":return"log"===e;case"zero":return Si(e)&&!ee(["log","time","utc","bin-linear","threshold","quantile"],e)}throw new Error("Invalid scale property "+t+".")}function Ri(e,t){switch(t){case"interpolate":case"scheme":return Rr(e)?void 0:Ge.cannotUseScalePropertyWithNonColor(e);case"type":case"domain":case"range":case"base":case"exponent":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeStep":case"reverse":case"round":case"clamp":case"zero":return}throw new Error('Invalid scale property "'+t+'".')}function zi(e,t,n){return ee([Tt.ORDINAL,Tt.NOMINAL],t)?void 0===e||bi(e):t===Tt.TEMPORAL?ee([ri.TIME,ri.UTC,ri.SEQUENTIAL,void 0],e):t!==Tt.QUANTITATIVE||ee(n?[ri.BIN_LINEAR,ri.BIN_ORDINAL,ri.LINEAR]:[ri.LOG,ri.POW,ri.SQRT,ri.QUANTILE,ri.QUANTIZE,ri.THRESHOLD,ri.LINEAR,ri.SEQUENTIAL,void 0],e)}function Ii(e,t){switch(e){case Bn.X:case Bn.Y:return Ei(t)||ee(["band","point"],t);case Bn.SIZE:case Bn.STROKEWIDTH:case Bn.OPACITY:case Bn.FILLOPACITY:case Bn.STROKEOPACITY:return Ei(t)||wi(t)||ee(["band","point"],t);case Bn.COLOR:case Bn.FILL:case Bn.STROKE:return"band"!==t;case Bn.SHAPE:return"ordinal"===t}return!1}function Fi(e,t,n){var r=e+"_"+t;return n?r+"_bin":r}var Li=Object.freeze({get ScaleType(){return ri},SCALE_TYPES:ai,scaleCompatible:ui,scaleTypePrecedence:ci,CONTINUOUS_TO_CONTINUOUS_SCALES:li,CONTINUOUS_TO_DISCRETE_SCALES:di,CONTINUOUS_DOMAIN_SCALES:hi,DISCRETE_DOMAIN_SCALES:gi,TIME_SCALE_TYPES:["time","utc"],hasDiscreteDomain:bi,isBinScale:xi,hasContinuousDomain:Si,isContinuousToContinuous:Ei,isContinuousToDiscrete:wi,defaultScaleConfig:ki,isExtendedScheme:Ci,isSelectionDomain:Oi,SCALE_PROPERTIES:Ai,NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES:Ti,SCALE_TYPE_INDEX:_i,scaleTypeSupportProperty:Di,channelScalePropertyIncompatability:Ri,scaleTypeSupportDataType:zi,channelSupportScaleType:Ii,getSupportedScaleType:function(e,t,n){return _i[Fi(e,t,n)]}});function ji(e,t,n){return Ui=t||Mi,Pi=n||Qi,Zi(e.trim()).map($i)}var Ui,Pi,Mi="view",qi="[",Hi="]",Wi="{",Bi="}",Yi=":",Gi=",",Vi="@",Xi=">",Ki=/[[\]{}]/,Qi={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};function Ji(e,t,n,r,i){for(var o,a=0,u=e.length;t<u;++t){if(o=e[t],!a&&o===n)return t;i&&i.indexOf(o)>=0?--a:r&&r.indexOf(o)>=0&&++a}return t}function Zi(e){for(var t=[],n=0,r=e.length,i=0;i<r;)i=Ji(e,i,Gi,qi+Wi,Hi+Bi),t.push(e.substring(n,i).trim()),n=++i;if(0===t.length)throw"Empty event selector: "+e;return t}function $i(e){return"["===e[0]?function(e){var t,n,r=e.length,i=1;if((i=Ji(e,i,Hi,qi,Hi))===r)throw"Empty between selector: "+e;if(2!==(t=Zi(e.substring(1,i))).length)throw"Between selector must have two elements: "+e;if((e=e.slice(i+1).trim())[0]!==Xi)throw"Expected '>' after between selector: "+e;if(t=t.map($i),(n=$i(e.slice(1).trim())).between)return{between:t,stream:n};n.between=t;return n}(e):function(e){var t,n,r={source:Ui},i=[],o=[0,0],a=0,u=0,s=e.length,c=0;if(e[s-1]===Bi){if(!((c=e.lastIndexOf(Wi))>=0))throw"Unmatched right brace: "+e;try{o=function(e){var t=e.split(Gi);if(!e.length||t.length>2)throw e;return t.map(function(t){var n=+t;if(n!=n)throw e;return n})}(e.substring(c+1,s-1))}catch(t){throw"Invalid throttle specification: "+e}e=e.slice(0,c).trim(),s=e.length,c=0}if(!s)throw e;e[0]===Vi&&(a=++c);(t=Ji(e,c,Yi))<s&&(i.push(e.substring(u,t).trim()),u=c=++t);if((c=Ji(e,c,qi))===s)i.push(e.substring(u,s).trim());else if(i.push(e.substring(u,c).trim()),n=[],(u=++c)===s)throw"Unmatched left bracket: "+e;for(;c<s;){if((c=Ji(e,c,Hi))===s)throw"Unmatched left bracket: "+e;if(n.push(e.substring(u,c).trim()),c<s-1&&e[++c]!==qi)throw"Expected left bracket: "+e;u=++c}if(!(s=i.length)||Ki.test(i[s-1]))throw"Invalid event selector: "+e;s>1?(r.type=i[1],a?r.markname=i[0].slice(1):(l=i[0],Pi.hasOwnProperty(l)?r.marktype=i[0]:r.source=i[0])):r.type=i[0];var l;"!"===r.type.slice(-1)&&(r.consume=!0,r.type=r.type.slice(0,-1));null!=n&&(r.filter=n);o[0]&&(r.throttle=o[0]);o[1]&&(r.debounce=o[1]);return r}(e)}var eo="_vgsid_",to={single:{on:"click",fields:[eo],resolve:"global",empty:"all"},multi:{on:"click",fields:[eo],toggle:"event.shiftKey",resolve:"global",empty:"all"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global"}},no={zero:1,center:1,normalize:1};function ro(e){return!!no[e]}var io=[Nn,On,In,Tn,Ln,jn,An,_n,Dn],oo=[Nn,On];function ao(e,t,n){var r=qn(e)?e.type:e;if(!ee(io,r))return null;var o=function(e){var t=e.x,n=e.y;if(Yt(t)&&Yt(n))if("quantitative"===t.type&&"quantitative"===n.type){if(t.stack)return"x";if(n.stack)return"y";if(!!t.aggregate!=!!n.aggregate)return t.aggregate?"x":"y"}else{if("quantitative"===t.type)return"x";if("quantitative"===n.type)return"y"}else{if(Yt(t)&&"quantitative"===t.type)return"x";if(Yt(n)&&"quantitative"===n.type)return"y"}}(t);if(!o)return null;var a,u=t[o],s=Gt(u)?Zt(u,{}):void 0,c="x"===o?"y":"x",l=t[c],f=Gt(l)?Zt(l,{}):void 0,d=Pr.reduce(function(e,n){if(gf(t,n)){var r=t[n];(i(r)?r:[r]).forEach(function(t){var r=hn(t);if(!r.aggregate){var i=Gt(r)?Zt(r,{}):void 0;(!i||i!==f&&i!==s)&&e.push({channel:n,fieldDef:r})}})}return e},[]);return 0===d.length?null:(a=void 0!==u.stack?u.stack:ee(oo,r)?Oe(n,"zero"):n)&&ro(a)?(u.scale&&u.scale.type&&u.scale.type!==ri.LINEAR&&Ze(Ge.cannotStackNonLinearScale(u.scale.type)),gf(t,o===er?nr:rr)?(void 0!==u.stack&&Ze(Ge.cannotStackRangedMark(o)),null):(u.aggregate&&!ee(Le,u.aggregate)&&Ze(Ge.stackNonSummativeAggregate(u.aggregate)),{groupbyChannel:l?c:void 0,fieldChannel:o,impute:Pn(r),stackBy:d,offset:a})):null}var uo=Object.freeze({isStackOffset:ro,STACKABLE_MARKS:io,STACK_BY_DEFAULT_MARKS:oo,stack:ao});function so(e,t){return co(e,t)}function co(e,t){if(mo(e))return function(e,t){var n=e.spec,r=E(e,["spec"]);return S({},r,{spec:co(n,t)})}(e,t);if(vo(e))return function e(t,n,r,i){var o=t.layer,a=t.encoding,u=t.projection,s=E(t,["layer","encoding","projection"]);var c=lo({parentEncoding:r,encoding:a});var l=fo({parentProjection:i,projection:u});return S({},s,{layer:o.map(function(t){return vo(t)?e(t,n,c,l):po(t,n,c,l)})})}(e,t);if(yo(e))return function(e,t){var n=e.spec,r=E(e,["spec"]);return S({},r,{spec:co(n,t)})}(e,t);if(xo(e))return function(e,t){var n=e.vconcat,r=E(e,["vconcat"]);return S({},r,{vconcat:n.map(function(e){return co(e,t)})})}(e,t);if(So(e))return function(e,t){var n=e.hconcat,r=E(e,["hconcat"]);return S({},r,{hconcat:n.map(function(e){return co(e,t)})})}(e,t);if(go(e)){var n=gf(e.encoding,dr),r=gf(e.encoding,pr);return n||r?function(e,t){var n=e.encoding,r=n.row,i=n.column,o=E(n,["row","column"]),a=e.mark,u=e.width,s=e.projection,c=e.height,l=e.selection,f=(e.encoding,E(e,["mark","width","projection","height","selection","encoding"]));return S({},f,{facet:S({},r?{row:r}:{},i?{column:i}:{}),spec:po(S({},s?{projection:s}:{},{mark:a},u?{width:u}:{},c?{height:c}:{},{encoding:o},l?{selection:l}:{}),t)})}(e,t):po(e,t)}throw new Error(Ge.INVALID_SPEC)}function lo(e){var t=e.parentEncoding,n=e.encoding;if(t&&n){var r=de(t).reduce(function(e,t){return n[t]&&e.push(t),e},[]);r.length>0&&Ze(Ge.encodingOverridden(r))}var i=S({},t||{},n||{});return de(i).length>0?i:void 0}function fo(e){var t=e.parentProjection,n=e.projection;return t&&n&&Ze(Ge.projectionOverridden({parentProjection:t,projection:n})),n||t}function po(e,t,n,r){var i=e.encoding,a=e.projection,u=qn(e.mark)?e.mark.type:e.mark;if(n||r){var s=fo({parentProjection:r,projection:a}),c=lo({parentEncoding:n,encoding:i});return po(S({},e,s?{projection:s}:{},c?{encoding:c}:{}),t)}return function(e){return Wn(e.mark)}(e)?xf(i)?function(e){var t=gf(e.encoding,er),n=gf(e.encoding,tr),r=gf(e.encoding,nr),i=gf(e.encoding,rr);if(r&&!t||i&&!n){var o=me(e);return r&&!t&&(o.encoding.x=o.encoding.x2,delete o.encoding.x2),i&&!n&&(o.encoding.y=o.encoding.y2,delete o.encoding.y2),o}return e}(e):"line"===u&&(i.x2||i.y2)?(Ze(Ge.lineWithRange(!!i.x2,!!i.y2)),po(S({mark:"rule"},e),t,n,r)):Pn(u)?function(e,t){void 0===t&&(t={});var n,r=e.selection,i=e.projection,a=e.encoding,u=e.mark,s=E(e,["selection","projection","encoding","mark"]),c=qn(u)?u:{type:u},l=function(e,t,n){return"transparent"===e.point?{opacity:0}:e.point?o(e.point)?e.point:{}:void 0!==e.point?null:t.point||n.shape?o(t.point)?t.point:{}:null}(c,t[c.type],a),f="area"===c.type&&function(e,t){return e.line?!0===e.line?{}:e.line:void 0!==e.line?null:t.line?!0===t.line?{}:t.line:null}(c,t[c.type]);if(!l&&!f)return S({},e,{mark:ho(c)});var d=[S({},r?{selection:r}:{},{mark:ho(S({},c,"area"===c.type?{opacity:.7}:{})),encoding:J(a,["shape"])})],p=ao(c,a,t?t.stack:void 0),h=a;if(p){var m=p.fieldChannel,g=p.offset;h=S({},a,((n={})[m]=S({},a[m],g?{stack:g}:{}),n))}f&&d.push(S({},i?{projection:i}:{},{mark:S({type:"line"},Q(c,["clip","interpolate","tension"]),f),encoding:h}));l&&d.push(S({},i?{projection:i}:{},{mark:S({type:"point",opacity:1,filled:!0},Q(c,["clip"]),l),encoding:h}));return S({},s,{layer:d})}(e,t):e:Yf(e,t)}function ho(e){e.point,e.line;var t=E(e,["point","line"]);return de(t).length>1?t:t.type}function mo(e){return void 0!==e.facet}function go(e){return!!e.mark}function vo(e){return void 0!==e.layer}function yo(e){return void 0!==e.repeat}function bo(e){return xo(e)||So(e)}function xo(e){return void 0!==e.vconcat}function So(e){return void 0!==e.hconcat}function Eo(e,t){return t.forEach(function(t){var n=$(["field","type","value","timeUnit","bin","aggregate"].reduce(function(e,n){return void 0!==t[n]&&(e[n]=t[n]),e},{}));e[n]=e[n]||t}),e}function wo(e){if(mo(e)||yo(e))return function(e){return wo(e.spec)}(e);if(vo(e))return function(e){var t=[];return e.layer.map(function(e){t=t.concat(wo(e))}),t}(e);if(go(e))return function(e){var t=[];return Ef(e.encoding,function(e,n){t.push(e.field)}),t}(e);throw new Error(Ge.INVALID_SPEC)}var ko=Object.freeze({isFacetSpec:mo,isUnitSpec:go,isLayerSpec:vo,isRepeatSpec:yo,isConcatSpec:bo,isVConcatSpec:xo,isHConcatSpec:So,fieldDefs:function(e){return pe(function e(t,n){return void 0===n&&(n={}),vo(t)?t.layer.forEach(function(t){go(t)?Eo(n,Sf(t.encoding)):e(t,n)}):mo(t)?(Eo(n,Sf(t.facet)),e(t.spec,n)):yo(t)?e(t.spec,n):bo(t)?(xo(t)?t.vconcat:t.hconcat).forEach(function(t){return e(t,n)}):Eo(n,Sf(t.encoding)),n}(e))},isStacked:function(e,t){return t=t||e.config,!!Wn(e.mark)&&null!==ao(e.mark,e.encoding,t?t.stack:void 0)},usedFields:wo,normalize:so});function Co(e){var t=e.anchor,n=(e.frame,e.offset),r=e.orient,i=e.color,o=E(e,["anchor","frame","offset","orient","color"]);return{mark:S({},o,i?{fill:i}:{}),nonMark:S({},t?{anchor:t}:{},n?{offset:n}:{},r?{orient:r}:{})}}function Oo(e){return a(e)?{type:e}:e||{}}var No=["background","padding"];function Ao(e){return No.reduce(function(t,n){return e&&void 0!==e[n]&&(t[n]=e[n]),t},{})}function To(e){return void 0!==e.filter}function _o(e){return e&&void 0!==e.start&&void 0!==e.stop}function Do(e){return void 0!==e.lookup}function Ro(e){return void 0!==e.sample}function zo(e){return void 0!==e.window}function Io(e){return void 0!==e.flatten}function Fo(e){return void 0!==e.calculate}function Lo(e){return!!e.bin}function jo(e){return void 0!==e.impute}function Uo(e){return void 0!==e.timeUnit}function Po(e){return void 0!==e.aggregate}function Mo(e){return void 0!==e.stack}function qo(e){return void 0!==e.fold}function Ho(e){return e.map(function(e){return To(e)?{filter:function e(t,n){return X(t)?{not:e(t.not,n)}:V(t)?{and:t.and.map(function(t){return e(t,n)})}:G(t)?{or:t.or.map(function(t){return e(t,n)})}:n(t)}(e.filter,Tl)}:e})}var Wo=Object.freeze({isFilter:To,isImputeSequence:_o,isLookup:Do,isSample:Ro,isWindow:zo,isFlatten:Io,isCalculate:Fo,isBin:Lo,isImpute:jo,isTimeUnit:Uo,isAggregate:Po,isStack:Mo,isFold:qo,normalizeTransform:Ho});function Bo(e){return!!e.signal}function Yo(e){return!!e.step}function Go(e){return!i(e)&&("field"in e&&"data"in e)}var Vo=he({opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeMiterLimit:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,cursor:1,href:1,tooltip:1,cornerRadius:1});function Xo(e,t,n,r){void 0===r&&(r={header:!1});var o=e.combine(),a=o.orient,u=o.scale,s=o.title,c=o.zindex,l=E(o,["orient","scale","title","zindex"]);if(de(l).forEach(function(e){var n=qe[e];n&&n!==t&&"both"!==n&&delete l[e]}),"grid"===t){if(!l.grid)return;if(l.encode){var f=l.encode.grid;l.encode=S({},f?{grid:f}:{}),0===de(l.encode).length&&delete l.encode}return S({scale:u,orient:a},l,{domain:!1,labels:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:Oe(c,0)})}if(r.header||!e.mainExtracted){if(l.encode){for(var d=0,p=Me;d<p.length;d++){var h=p[d];e.hasAxisPart(h)||delete l.encode[h]}0===de(l.encode).length&&delete l.encode}var m=function(e,t){return i(e)?e.map(function(e){return fn(e,t)}).join(", "):e}(s,n);return S({scale:u,orient:a,grid:!1},m?{title:m}:{},l,{zindex:Oe(c,1)})}}var Ko={titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontWeight:"fontWeight",titleLimit:"limit",titlePadding:"offset"},Qo={labelAngle:"angle",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelLimit:"limit",labelPadding:"offset"},Jo=Object.keys(Ko),Zo=Object.keys(Qo),$o=Object.freeze({HEADER_TITLE_PROPERTIES_MAP:Ko,HEADER_LABEL_PROPERTIES_MAP:Qo,HEADER_TITLE_PROPERTIES:Jo,HEADER_LABEL_PROPERTIES:Zo});function ea(e){return!(!e||"count"!==e.op&&!e.field||!e.op)}function ta(e){return!!e&&i(e)}var na,ra,ia,oa,aa,ua=Object.freeze({isSortField:ea,isSortArray:ta}),sa=function(){function e(e,t){this.debugName=t,this._children=[],this._parent=null,e&&(this.parent=e)}return e.prototype.clone=function(){throw new Error("Cannot clone node")},e.prototype.hash=function(){return void 0===this._hash&&(this._hash=Ae()),this._hash},e.prototype.producedFields=function(){return{}},e.prototype.dependentFields=function(){return{}},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},set:function(e){this._parent=e,e.addChild(this)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),e.prototype.numChildren=function(){return this._children.length},e.prototype.addChild=function(e,t){this._children.indexOf(e)>-1?console.warn("Attempt to add the same child twice."):void 0!==t?this._children.splice(t,0,e):this._children.push(e)},e.prototype.removeChild=function(e){var t=this._children.indexOf(e);return this._children.splice(t,1),t},e.prototype.remove=function(){for(var e=this._parent.removeChild(this),t=0,n=this._children;t<n.length;t++){var r=n[t];r._parent=this._parent,this._parent.addChild(r,e++)}},e.prototype.insertAsParentOf=function(e){var t=e.parent;t.removeChild(this),this.parent=t,e.parent=this},e.prototype.swapWithParent=function(){for(var e=this._parent,t=e.parent,n=0,r=this._children;n<r.length;n++){r[n].parent=e}this._children=[],e.removeChild(this),e.parent.removeChild(e),this.parent=t,e.parent=this},e}(),ca=function(e){function t(t,n,r,i){var o=e.call(this,t,n)||this;return o.type=r,o.refCounts=i,o._source=o._name=n,!o.refCounts||o._name in o.refCounts||(o.refCounts[o._name]=0),o}return x(t,e),t.prototype.clone=function(){var e=new this.constructor;return e.debugName="clone_"+this.debugName,e._source=this._source,e._name="clone_"+this._name,e.type=this.type,e.refCounts=this.refCounts,e.refCounts[e._name]=0,e},t.prototype.getSource=function(){return this.refCounts[this._name]++,this._source},t.prototype.isRequired=function(){return!!this.refCounts[this._name]},t.prototype.setSource=function(e){this._source=e},t}(sa);function la(e){this.type=e}la.prototype.visit=function(e){var t,n,r;if(e(this))return 1;for(n=0,r=(t=function(e){switch(e.type){case"ArrayExpression":return e.elements;case"BinaryExpression":case"LogicalExpression":return[e.left,e.right];case"CallExpression":var t=e.arguments.slice();return t.unshift(e.callee),t;case"ConditionalExpression":return[e.test,e.consequent,e.alternate];case"MemberExpression":return[e.object,e.property];case"ObjectExpression":return e.properties;case"Property":return[e.key,e.value];case"UnaryExpression":return[e.argument];case"Identifier":case"Literal":case"RawCode":default:return[]}}(this)).length;n<r;++n)if(t[n].visit(e))return 1};var fa=1,da=2,pa=3,ha=4,ma=5,ga=6,va=7,ya=8;(na={})[fa]="Boolean",na[da]="<end>",na[pa]="Identifier",na[ha]="Keyword",na[ma]="Null",na[ga]="Numeric",na[va]="Punctuator",na[ya]="String",na[9]="RegularExpression";var ba="ArrayExpression",xa="BinaryExpression",Sa="CallExpression",Ea="ConditionalExpression",wa="Identifier",ka="Literal",Ca="LogicalExpression",Oa="MemberExpression",Na="ObjectExpression",Aa="Property",Ta="UnaryExpression",_a="Unexpected token %0",Da="Unexpected number",Ra="Unexpected string",za="Unexpected identifier",Ia="Unexpected reserved word",Fa="Unexpected end of input",La="Invalid regular expression",ja="Invalid regular expression: missing /",Ua="Octal literals are not allowed in strict mode.",Pa="Duplicate data property in object literal not allowed in strict mode",Ma="ILLEGAL",qa="Disabled.",Ha=new RegExp("[--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------]"),Wa=new RegExp("[--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------]");function Ba(e,t){if(!e)throw new Error("ASSERT: "+t)}function Ya(e){return e>=48&&e<=57}function Ga(e){return"0123456789abcdefABCDEF".indexOf(e)>=0}function Va(e){return"01234567".indexOf(e)>=0}function Xa(e){return 32===e||9===e||11===e||12===e||160===e||e>=5760&&[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(e)>=0}function Ka(e){return 10===e||13===e||8232===e||8233===e}function Qa(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||92===e||e>=128&&Ha.test(String.fromCharCode(e))}function Ja(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57||92===e||e>=128&&Wa.test(String.fromCharCode(e))}var Za={if:1,in:1,do:1,var:1,for:1,new:1,try:1,let:1,this:1,else:1,case:1,void:1,with:1,enum:1,while:1,break:1,catch:1,throw:1,const:1,yield:1,class:1,super:1,return:1,typeof:1,delete:1,switch:1,export:1,import:1,public:1,static:1,default:1,finally:1,extends:1,package:1,private:1,function:1,continue:1,debugger:1,interface:1,protected:1,instanceof:1,implements:1};function $a(){for(var e;ia<oa&&(Xa(e=ra.charCodeAt(ia))||Ka(e));)++ia}function eu(e){var t,n,r,i=0;for(n="u"===e?4:2,t=0;t<n;++t)ia<oa&&Ga(ra[ia])?(r=ra[ia++],i=16*i+"0123456789abcdef".indexOf(r.toLowerCase())):gu({},_a,Ma);return String.fromCharCode(i)}function tu(){var e,t,n,r;for(t=0,"}"===(e=ra[ia])&&gu({},_a,Ma);ia<oa&&Ga(e=ra[ia++]);)t=16*t+"0123456789abcdef".indexOf(e.toLowerCase());return(t>1114111||"}"!==e)&&gu({},_a,Ma),t<=65535?String.fromCharCode(t):(n=55296+(t-65536>>10),r=56320+(t-65536&1023),String.fromCharCode(n,r))}function nu(){var e,t;for(e=ra.charCodeAt(ia++),t=String.fromCharCode(e),92===e&&(117!==ra.charCodeAt(ia)&&gu({},_a,Ma),++ia,(e=eu("u"))&&"\\"!==e&&Qa(e.charCodeAt(0))||gu({},_a,Ma),t=e);ia<oa&&Ja(e=ra.charCodeAt(ia));)++ia,t+=String.fromCharCode(e),92===e&&(t=t.substr(0,t.length-1),117!==ra.charCodeAt(ia)&&gu({},_a,Ma),++ia,(e=eu("u"))&&"\\"!==e&&Ja(e.charCodeAt(0))||gu({},_a,Ma),t+=e);return t}function ru(){var e,t;return e=ia,{type:1===(t=92===ra.charCodeAt(ia)?nu():function(){var e,t;for(e=ia++;ia<oa;){if(92===(t=ra.charCodeAt(ia)))return ia=e,nu();if(!Ja(t))break;++ia}return ra.slice(e,ia)}()).length?pa:Za.hasOwnProperty(t)?ha:"null"===t?ma:"true"===t||"false"===t?fa:pa,value:t,start:e,end:ia}}function iu(){var e,t,n,r,i=ia,o=ra.charCodeAt(ia),a=ra[ia];switch(o){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:return++ia,{type:va,value:String.fromCharCode(o),start:i,end:ia};default:if(61===(e=ra.charCodeAt(ia+1)))switch(o){case 43:case 45:case 47:case 60:case 62:case 94:case 124:case 37:case 38:case 42:return ia+=2,{type:va,value:String.fromCharCode(o)+String.fromCharCode(e),start:i,end:ia};case 33:case 61:return ia+=2,61===ra.charCodeAt(ia)&&++ia,{type:va,value:ra.slice(i,ia),start:i,end:ia}}}return">>>="===(r=ra.substr(ia,4))?{type:va,value:r,start:i,end:ia+=4}:">>>"===(n=r.substr(0,3))||"<<="===n||">>="===n?{type:va,value:n,start:i,end:ia+=3}:a===(t=n.substr(0,2))[1]&&"+-<>&|".indexOf(a)>=0||"=>"===t?{type:va,value:t,start:i,end:ia+=2}:"<>=!+-*%&|^/".indexOf(a)>=0?{type:va,value:a,start:i,end:++ia}:void gu({},_a,Ma)}function ou(){var e,t,n;if(Ba(Ya((n=ra[ia]).charCodeAt(0))||"."===n,"Numeric literal must start with a decimal digit or a decimal point"),t=ia,e="","."!==n){if(e=ra[ia++],n=ra[ia],"0"===e){if("x"===n||"X"===n)return++ia,function(e){for(var t="";ia<oa&&Ga(ra[ia]);)t+=ra[ia++];return 0===t.length&&gu({},_a,Ma),Qa(ra.charCodeAt(ia))&&gu({},_a,Ma),{type:ga,value:parseInt("0x"+t,16),start:e,end:ia}}(t);if(Va(n))return function(e){for(var t="0"+ra[ia++];ia<oa&&Va(ra[ia]);)t+=ra[ia++];return(Qa(ra.charCodeAt(ia))||Ya(ra.charCodeAt(ia)))&&gu({},_a,Ma),{type:ga,value:parseInt(t,8),octal:!0,start:e,end:ia}}(t);n&&Ya(n.charCodeAt(0))&&gu({},_a,Ma)}for(;Ya(ra.charCodeAt(ia));)e+=ra[ia++];n=ra[ia]}if("."===n){for(e+=ra[ia++];Ya(ra.charCodeAt(ia));)e+=ra[ia++];n=ra[ia]}if("e"===n||"E"===n)if(e+=ra[ia++],"+"!==(n=ra[ia])&&"-"!==n||(e+=ra[ia++]),Ya(ra.charCodeAt(ia)))for(;Ya(ra.charCodeAt(ia));)e+=ra[ia++];else gu({},_a,Ma);return Qa(ra.charCodeAt(ia))&&gu({},_a,Ma),{type:ga,value:parseFloat(e),start:t,end:ia}}function au(){var e,t,n,r;return aa=null,$a(),e=ia,t=function(){var e,t,n,r;for(Ba("/"===(e=ra[ia]),"Regular expression literal must start with a slash"),t=ra[ia++],n=!1,r=!1;ia<oa;)if(t+=e=ra[ia++],"\\"===e)Ka((e=ra[ia++]).charCodeAt(0))&&gu({},ja),t+=e;else if(Ka(e.charCodeAt(0)))gu({},ja);else if(n)"]"===e&&(n=!1);else{if("/"===e){r=!0;break}"["===e&&(n=!0)}return r||gu({},ja),{value:t.substr(1,t.length-2),literal:t}}(),n=function(){var e,t,n;for(t="",n="";ia<oa&&Ja((e=ra[ia]).charCodeAt(0));)++ia,"\\"===e&&ia<oa?gu({},_a,Ma):(n+=e,t+=e);return n.search(/[^gimuy]/g)>=0&&gu({},La,n),{value:n,literal:t}}(),r=function(e,t){var n=e;t.indexOf("u")>=0&&(n=n.replace(/\\u\{([0-9a-fA-F]+)\}/g,function(e,t){if(parseInt(t,16)<=1114111)return"x";gu({},La)}).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"x"));try{return new RegExp(e,t)}catch(e){return null}}(t.value,n.value),{literal:t.literal+n.literal,value:r,regex:{pattern:t.value,flags:n.value},start:e,end:ia}}function uu(){var e;return $a(),ia>=oa?{type:da,start:ia,end:ia}:Qa(e=ra.charCodeAt(ia))?ru():40===e||41===e||59===e?iu():39===e||34===e?function(){var e,t,n,r,i="",o=!1;for(Ba("'"===(e=ra[ia])||'"'===e,"String literal must starts with a quote"),t=ia,++ia;ia<oa;){if((n=ra[ia++])===e){e="";break}if("\\"===n)if((n=ra[ia++])&&Ka(n.charCodeAt(0)))"\r"===n&&"\n"===ra[ia]&&++ia;else switch(n){case"u":case"x":"{"===ra[ia]?(++ia,i+=tu()):i+=eu(n);break;case"n":i+="\n";break;case"r":i+="\r";break;case"t":i+="\t";break;case"b":i+="\b";break;case"f":i+="\f";break;case"v":i+="\v";break;default:Va(n)?(0!==(r="01234567".indexOf(n))&&(o=!0),ia<oa&&Va(ra[ia])&&(o=!0,r=8*r+"01234567".indexOf(ra[ia++]),"0123".indexOf(n)>=0&&ia<oa&&Va(ra[ia])&&(r=8*r+"01234567".indexOf(ra[ia++]))),i+=String.fromCharCode(r)):i+=n}else{if(Ka(n.charCodeAt(0)))break;i+=n}}return""!==e&&gu({},_a,Ma),{type:ya,value:i,octal:o,start:t,end:ia}}():46===e?Ya(ra.charCodeAt(ia+1))?ou():iu():Ya(e)?ou():iu()}function su(){var e;return ia=(e=aa).end,aa=uu(),ia=e.end,e}function cu(){var e;e=ia,aa=uu(),ia=e}function lu(e,t,n){var r=new la("||"===e||"&&"===e?Ca:xa);return r.operator=e,r.left=t,r.right=n,r}function fu(e,t){var n=new la(Sa);return n.callee=e,n.arguments=t,n}function du(e){var t=new la(wa);return t.name=e,t}function pu(e){var t=new la(ka);return t.value=e.value,t.raw=ra.slice(e.start,e.end),e.regex&&("//"===t.raw&&(t.raw="/(?:)/"),t.regex=e.regex),t}function hu(e,t,n){var r=new la(Oa);return r.computed="["===e,r.object=t,r.property=n,r.computed||(n.member=!0),r}function mu(e,t,n){var r=new la(Aa);return r.key=t,r.value=n,r.kind=e,r}function gu(e,t){var n,r=Array.prototype.slice.call(arguments,2),i=t.replace(/%(\d)/g,function(e,t){return Ba(t<r.length,"Message reference must be in range"),r[t]});throw(n=new Error(i)).index=ia,n.description=i,n}function vu(e){e.type===da&&gu(e,Fa),e.type===ga&&gu(e,Da),e.type===ya&&gu(e,Ra),e.type===pa&&gu(e,za),e.type===ha&&gu(e,Ia),gu(e,_a,e.value)}function yu(e){var t=su();t.type===va&&t.value===e||vu(t)}function bu(e){return aa.type===va&&aa.value===e}function xu(e){return aa.type===ha&&aa.value===e}function Su(){var e=[];for(ia=aa.start,yu("[");!bu("]");)bu(",")?(su(),e.push(null)):(e.push(zu()),bu("]")||yu(","));return su(),function(e){var t=new la(ba);return t.elements=e,t}(e)}function Eu(){var e;return ia=aa.start,(e=su()).type===ya||e.type===ga?(e.octal&&gu(e,Ua),pu(e)):du(e.value)}function wu(){var e,t,n;return ia=aa.start,(e=aa).type===pa?(n=Eu(),yu(":"),mu("init",n,zu())):e.type!==da&&e.type!==va?(t=Eu(),yu(":"),mu("init",t,zu())):void vu(e)}function ku(){var e,t,n=[],r={},i=String;for(ia=aa.start,yu("{");!bu("}");)t="$"+((e=wu()).key.type===wa?e.key.name:i(e.key.value)),Object.prototype.hasOwnProperty.call(r,t)?gu({},Pa):r[t]=!0,n.push(e),bu("}")||yu(",");return yu("}"),function(e){var t=new la(Na);return t.properties=e,t}(n)}var Cu={if:1,this:1};function Ou(){var e,t,n;if(bu("("))return function(){var e;return yu("("),e=Iu(),yu(")"),e}();if(bu("["))return Su();if(bu("{"))return ku();if(e=aa.type,ia=aa.start,e===pa||Cu[aa.value])n=du(su().value);else if(e===ya||e===ga)aa.octal&&gu(aa,Ua),n=pu(su());else{if(e===ha)throw new Error(qa);e===fa?((t=su()).value="true"===t.value,n=pu(t)):e===ma?((t=su()).value=null,n=pu(t)):bu("/")||bu("/=")?(n=pu(au()),cu()):vu(su())}return n}function Nu(){var e=[];if(yu("("),!bu(")"))for(;ia<oa&&(e.push(zu()),!bu(")"));)yu(",");return yu(")"),e}function Au(){var e;return ia=aa.start,function(e){return e.type===pa||e.type===ha||e.type===fa||e.type===ma}(e=su())||vu(e),du(e.value)}function Tu(){var e;return yu("["),e=Iu(),yu("]"),e}function _u(){var e=function(){var e;for(e=Ou();;)if(bu("."))yu("."),e=hu(".",e,Au());else if(bu("("))e=fu(e,Nu());else{if(!bu("["))break;e=hu("[",e,Tu())}return e}();if(aa.type===va&&(bu("++")||bu("--")))throw new Error(qa);return e}function Du(){var e,t,n,r,i;if(aa.type!==va&&aa.type!==ha)t=_u();else{if(bu("++")||bu("--"))throw new Error(qa);if(bu("+")||bu("-")||bu("~")||bu("!"))e=su(),t=Du(),n=e.value,r=t,(i=new la(Ta)).operator=n,i.argument=r,i.prefix=!0,t=i;else{if(xu("delete")||xu("void")||xu("typeof"))throw new Error(qa);t=_u()}}return t}function Ru(e){var t=0;if(e.type!==va&&e.type!==ha)return 0;switch(e.value){case"||":t=1;break;case"&&":t=2;break;case"|":t=3;break;case"^":t=4;break;case"&":t=5;break;case"==":case"!=":case"===":case"!==":t=6;break;case"<":case">":case"<=":case">=":case"instanceof":case"in":t=7;break;case"<<":case">>":case">>>":t=8;break;case"+":case"-":t=9;break;case"*":case"/":case"%":t=11}return t}function zu(){var e,t;return e=function(){var e,t,n,r,i,o,a,u,s,c;if(e=aa,s=Du(),0===(i=Ru(r=aa)))return s;for(r.prec=i,su(),t=[e,aa],o=[s,r,a=Du()];(i=Ru(aa))>0;){for(;o.length>2&&i<=o[o.length-2].prec;)a=o.pop(),u=o.pop().value,s=o.pop(),t.pop(),n=lu(u,s,a),o.push(n);(r=su()).prec=i,o.push(r),t.push(aa),n=Du(),o.push(n)}for(n=o[c=o.length-1],t.pop();c>1;)t.pop(),n=lu(o[c-1].value,o[c-2],n),c-=2;return n}(),bu("?")&&(su(),t=zu(),yu(":"),e=function(e,t,n){var r=new la(Ea);return r.test=e,r.consequent=t,r.alternate=n,r}(e,t,zu())),e}function Iu(){var e=zu();if(bu(","))throw new Error(qa);return e}function Fu(e){var t=function(e){ia=0,oa=(ra=e).length,aa=null,cu();var t=Iu();if(aa.type!==da)throw new Error("Unexpect token after expression.");return t}(e),n={};return t.visit(function(e){"MemberExpression"===e.type&&function e(t){return"MemberExpression"===t.object.type?e(t.object):"datum"===t.object.name}(e)&&(n[function e(t){var n=[];return"Identifier"===t.type?[t.name]:"Literal"===t.type?[t.value]:("MemberExpression"===t.type&&(n=(n=n.concat(e(t.object))).concat(e(t.property))),n)}(e).slice(1).join(".")]=!0)}),n}var Lu=function(e){function t(t,n){var r=e.call(this,t)||this;return r.transform=n,r._dependentFields=Fu(r.transform.calculate),r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform))},t.parseAllForSortIndex=function(e,n){return n.forEachFieldDef(function(n,r){if(Xt(n)&&ta(n.sort)){var i=n.field,o=n.timeUnit,a=n.sort,u=a.map(function(e,t){return Al({field:i,timeUnit:o,equal:e})+" ? "+t+" : "}).join("")+a.length;e=new t(e,{calculate:u,as:ju(n,r,{forAs:!0})})}}),e},t.prototype.producedFields=function(){var e={};return e[this.transform.as]=!0,e},t.prototype.dependentFields=function(){return this._dependentFields},t.prototype.assemble=function(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}},t.prototype.hash=function(){return"Calculate "+$(this.transform)},t}(sa);function ju(e,t,n){return Zt(e,S({prefix:t,suffix:"sort_index"},n||{}))}var Uu=["row","column"],Pu=["header","footer"];function Mu(e,t){var n=e.component.layoutHeaders[t].title,r=e.config?e.config:void 0,i=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0;return{name:t+"-title",type:"group",role:t+"-title",title:S({text:n,offset:10},"row"===t?{orient:"left"}:{},{style:"guide-title"},Wu(r,i,Jo,Ko))}}function qu(e,t){for(var n=e.component.layoutHeaders[t],r=[],i=0,o=Pu;i<o.length;i++){var a=o[i];if(n[a])for(var u=0,s=n[a];u<s.length;u++){var c=s[u];r.push(Hu(e,t,a,n,c))}}return r}function Hu(e,t,n,r,o){var a,u;if(o){var s=null,c=r.facetFieldDef;if(c&&o.labels){var l=c.header,f=void 0===l?{}:l,d=f.format,p=f.labelAngle,h=e.config?e.config:void 0,m=S({},(90+(u=((u=p)%360+360)%360))%180==0?{}:u<90||270<u?{align:{value:"right"}}:135<=u&&u<225?{align:{value:"left"}}:{});s=S({text:rf(c,d,"parent",e.config),offset:10},"row"===t?{orient:"left"}:{},{style:"guide-label"},void 0!==p?{angle:p}:{},function(e){return 45<=(e=(e%360+360)%360)&&e<=135?{baseline:"top"}:{baseline:"middle"}}(p),Wu(h,c,Zo,Qo),de(m).length>0?{encode:{update:m}}:{})}var g=o.axes,v=g&&g.length>0;if(s||v){var y="row"===t?"height":"width";return S({name:e.getName(t+"_"+n),type:"group",role:t+"-"+n},r.facetFieldDef?{from:{data:e.getName(t+"_domain")},sort:function(e,t){var n=e.sort;return ea(n)?{field:Zt(n,{expr:"datum"}),order:n.order||"ascending"}:i(n)?{field:ju(e,t,{expr:"datum"}),order:"ascending"}:{field:Zt(e,{expr:"datum"}),order:n||"ascending"}}(c,t)}:{},s?{title:s}:{},o.sizeSignal?{encode:{update:(a={},a[y]=o.sizeSignal,a)}}:{},v?{axes:g}:{})}}return null}function Wu(e,t,n,r){for(var i={},o=0,a=n;o<a.length;o++){var u=a[o];e&&e.header&&e.header[u]&&(i[r[u]]=e.header[u]),t&&t.header&&t.header[u]&&(i[r[u]]=t.header[u])}return i}function Bu(e){return[].concat(Yu(e,"width"),Yu(e,"height"))}function Yu(e,t){var n="width"===t?"x":"y",r=e.component.layoutSize.get(t);if(!r||"merged"===r)return[];var i=e.getSizeSignalRef(t).signal;if("range-step"===r){var o=e.getScaleComponent(n);if(o){var a=o.get("type"),u=o.get("range");if(bi(a)&&Yo(u)){var s=e.scaleName(n);if(Dc(e.parent))if("independent"===e.parent.component.resolve.scale[n])return[Gu(s,u)];return[Gu(s,u),{name:i,update:Vu(s,o,"domain('"+s+"').length")}]}}throw new Error("layout size is range step although there is no rangeStep.")}return[{name:i,value:r}]}function Gu(e,t){return{name:e+"_step",value:t.step}}function Vu(e,t,n){var r=t.get("type"),i=t.get("padding"),o=Oe(t.get("paddingOuter"),i),a=t.get("paddingInner");return"bandspace("+n+", "+(a="band"===r?void 0!==a?a:i:1)+", "+o+") * "+e+"_step"}var Xu={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64},Ku={clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,direction:1,fillColor:1,format:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,strokeWidth:1,symbolFillColor:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,title:1,titleAlign:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,type:1,values:1,zindex:1},Qu=S({},Ku,{opacity:1,shape:1,stroke:1,fill:1,size:1,encode:1}),Ju=he(Ku),Zu=he(Qu),$u=Object.freeze({defaultLegendConfig:Xu,LEGEND_PROPERTIES:Ju,VG_LEGEND_PROPERTIES:Zu});function es(e,t){var n=e.scale[t],r=ee(qr,t)?"axis":"legend";return"independent"===n?("shared"===e[r][t]&&Ze(Ge.independentScaleMeansIndependentGuide(t)),"independent"):e[r][t]||"shared"}var ts=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.explicit=e,this.implicit=t}return e.prototype.clone=function(){return new e(me(this.explicit),me(this.implicit))},e.prototype.combine=function(){return S({},this.explicit,this.implicit)},e.prototype.get=function(e){return Oe(this.explicit[e],this.implicit[e])},e.prototype.getWithExplicit=function(e){return void 0!==this.explicit[e]?{explicit:!0,value:this.explicit[e]}:void 0!==this.implicit[e]?{explicit:!1,value:this.implicit[e]}:{explicit:!1,value:void 0}},e.prototype.setWithExplicit=function(e,t){void 0!==t.value&&this.set(e,t.value,t.explicit)},e.prototype.set=function(e,t,n){return delete this[n?"implicit":"explicit"][e],this[n?"explicit":"implicit"][e]=t,this},e.prototype.copyKeyFromSplit=function(e,t){void 0!==t.explicit[e]?this.set(e,t.explicit[e],!0):void 0!==t.implicit[e]&&this.set(e,t.implicit[e],!1)},e.prototype.copyKeyFromObject=function(e,t){void 0!==t[e]&&this.set(e,t[e],!0)},e.prototype.copyAll=function(e){for(var t=0,n=de(e.combine());t<n.length;t++){var r=n[t],i=e.getWithExplicit(r);this.setWithExplicit(r,i)}},e}();function ns(e){return{explicit:!0,value:e}}function rs(e){return{explicit:!1,value:e}}function is(e){return function(t,n,r,i){var o=e(t.value,n.value);return o>0?t:o<0?n:os(t,n,r,i)}}function os(e,t,n,r){return e.explicit&&t.explicit&&Ze(Ge.mergeConflictingProperty(n,r,e.value,t.value)),e}function as(e,t,n,r,i){return void 0===i&&(i=os),void 0===e||void 0===e.value?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:Z(e.value)===Z(t.value)?e:i(e,t,n,r)}var us=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t}(ts);function ss(e){return ls(e,function(e,t){return Math.max(e,t.value)})}function cs(e){return ls(e,function(e,t){return Oe(e,t.value)})}function ls(e,t){return Bt(e)?(i(e.condition)?e.condition:[e.condition]).reduce(t,e.value):Vt(e)?e.value:void 0}var fs=Object.freeze({symbols:function(e,t,n,r,o){if("gradient"!==o.get("type")){var a=S({},function(e,t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=tf(o,t.markDef,t.config);void 0!==a&&(e[o]={value:a})}return e}({},n,Vn),ql(n));switch(n.mark){case Nn:case Dn:case _n:a.shape={value:"square"};break;case Ln:case jn:a.shape={value:n.mark}}var u=n.markDef,s=n.encoding,c=u.filled,l=ss(s.opacity)||u.opacity;if(a.fill)if("fill"===r||c&&r===gr)delete a.fill;else if(a.fill.field)o.get("symbolFillColor")?delete a.fill:(a.fill={value:"black"},a.fillOpacity={value:l||1});else if(i(a.fill)){var f=cs(s.fill||s.color)||u.fill||c&&u.color;f&&(a.fill={value:f})}if(a.stroke)if("stroke"===r||!c&&r===gr)delete a.stroke;else if(a.stroke.field)delete a.stroke;else if(i(a.stroke)){var d=Oe(cs(s.stroke||s.color),u.stroke,c?u.color:void 0);d&&(a.stroke={value:d})}if(r!==hr){var p=cs(s.shape)||u.shape;p&&(a.shape={value:p})}return r!==wr&&l&&(a.opacity={value:l}),a=S({},a,t),de(a).length>0?a:void 0}},gradient:function(e,t,n,r,i){var o={};if("gradient"===i.get("type")){var a=ss(n.encoding.opacity)||n.markDef.opacity;a&&(o.opacity={value:a})}return o=S({},o,t),de(o).length>0?o:void 0},labels:function(e,t,n,r,i){var o=n.legend(r),a=n.config,u={};if(Sn(e)){var s=n.getScaleComponent(r).get("type")===ri.UTC,c=cf("datum.value",e.timeUnit,o.format,a.legend.shortTimeLabels,a.timeFormat,s);t=S({},c?{text:{signal:c}}:{},t)}return u=S({},u,t),de(u).length>0?u:void 0}});function ds(e,t,n,r){return{signal:"clamp("+e.getSizeSignalRef(t).signal+", "+n+", "+r+")"}}function ps(e){_c(e)?e.component.legends=function(e){var t=e.encoding;return[gr,vr,yr,Or,mr,hr,wr,kr,Cr].reduce(function(n,r){var i=t[r];return!e.legend(r)||!e.getScaleComponent(r)||Yt(i)&&r===hr&&i.type===Lt||(n[r]=function(e,t){for(var n=e.fieldDef(t),r=e.legend(t),i=new us({},function(e,t){var n;switch(t){case gr:var r=e.scaleName(gr);return e.markDef.filled?{fill:r}:{stroke:r};case vr:case yr:case Or:case mr:case hr:case wr:case kr:case Cr:return(n={})[t]=e.scaleName(t),n}}(e,t)),o=0,a=Ju;o<a.length;o++){var u=a[o],s=ms(u,r,t,e);if(void 0!==s){var c=hs(s,u,r,n);(c||void 0===e.config.legend[u])&&i.set(u,s,c)}}var l=r.encoding||{},f=["labels","legend","title","symbols","gradient"].reduce(function(r,o){var a=mf(l[o]||{},e),u=fs[o]?fs[o](n,a,e,t,i):a;return void 0!==u&&de(u).length>0&&(r[o]={update:u}),r},{});de(f).length>0&&i.set("encode",f,!!r.encoding);return i}(e,r)),n},{})}(e):e.component.legends=function(e){for(var t=e.component,n=t.legends,r=t.resolve,i=function(t){ps(t),de(t.component.legends).forEach(function(i){r.legend[i]=es(e.component.resolve,i),"shared"===r.legend[i]&&(n[i]=gs(n[i],t.component.legends[i]),n[i]||(r.legend[i]="independent",delete n[i]))})},o=0,a=e.children;o<a.length;o++){var u=a[o];i(u)}return de(n).forEach(function(t){for(var n=0,i=e.children;n<i.length;n++){var o=i[n];o.component.legends[t]&&"shared"===r.legend[t]&&delete o.component.legends[t]}}),n}(e)}function hs(e,t,n,r){switch(t){case"values":return!!n.values;case"title":if("title"===t&&e===r.title)return!0}return e===n[t]}function ms(e,t,n,r){var i=r.fieldDef(n);switch(e){case"format":return of(i,t.format,r.config);case"title":return cn(i,r.config,{allowDisabling:!0})||void 0;case"labelOverlap":return Oe(t.labelOverlap,function(e){if(ee(["quantile","threshold","log"],e))return"greedy"}(r.getScaleComponent(n).get("type")));case"gradientLength":var o=r.config.legend;return Oe(t.gradientLength,o.gradientLength,function(e,t,n){var r=n.gradientDirection,i=n.gradientHorizontalMaxLength,o=n.gradientHorizontalMinLength,a=n.gradientVerticalMaxLength,u=n.gradientVerticalMinLength;if("horizontal"===Oe(t.direction,r)){var s=Oe(t.orient,n.orient);return"top"===s||"bottom"===s?ds(e,"width",o,i):o}return ds(e,"height",u,a)}(r,t,o));case"values":return function(e,t){var n=e.values;if(n)return wn(t,n)}(t,i)}return t[e]}function gs(e,t){if(!e)return t.clone();var n=e.getWithExplicit("orient"),r=t.getWithExplicit("orient");if(!n.explicit||!r.explicit||n.value===r.value){for(var i=!1,o=function(n){var r=as(e.getWithExplicit(n),t.getWithExplicit(n),n,"legend",function(e,t){switch(n){case"title":return pf(e,t);case"type":return i=!0,rs("symbol")}return os(e,t,n,"legend")});e.setWithExplicit(n,r)},a=0,u=Zu;a<u.length;a++){o(u[a])}return i&&(((e.implicit||{}).encode||{}).gradient&&be(e.implicit,["encode","gradient"]),((e.explicit||{}).encode||{}).gradient&&be(e.explicit,["encode","gradient"])),e}}function vs(e){for(var t=e.component.legends,n={},r=0,i=de(t);r<i.length;r++){var o=i[r],a=e.getScaleComponent(o),u=Z(a.domains);if(n[u])for(var s=0,c=n[u];s<c.length;s++){gs(c[s],t[o])||n[u].push(t[o])}else n[u]=[t[o].clone()]}return ie(pe(n)).map(function(e){var t=e.combine();if(t.encode&&t.encode.symbols){var n=t.encode.symbols.update;!n.fill||"transparent"===n.fill.value||n.stroke||t.stroke||(n.stroke={value:"transparent"})}return t})}function ys(e){return Ic(e)||zc(e)||Rc(e)?function(e){return e.children.reduce(function(e,t){return e.concat(t.assembleProjections())},bs(e))}(e):bs(e)}function bs(e){var t=e.component.projection;if(!t||t.merged)return[];var n=t.combine(),r=n.name,i=E(n,["name"]),o={signal:"["+t.size.map(function(e){return e.signal}).join(", ")+"]"},a=t.data.reduce(function(t,n){var r=Bo(n)?n.signal:"data('"+e.lookupDataSource(n)+"')";return ee(t,r)||t.push(r),t},[]);if(a.length<=0)throw new Error("Projection's fit didn't find any data sources");return[S({name:r,size:o,fit:{signal:a.length>1?"["+a.join(", ")+"]":a[0]}},i)]}function xs(e){return!!e.url}function Ss(e){return!!e.values}function Es(e){return!!e.name&&!xs(e)&&!Ss(e)}var ws="main",ks="raw",Cs=Object.freeze({isUrlData:xs,isInlineData:Ss,isNamedData:Es,MAIN:ws,RAW:ks}),Os=["type","clipAngle","clipExtent","center","rotate","precision","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"],Ns=function(e){function t(t,n,r,i){var o=e.call(this,S({},n),{name:t})||this;return o.specifiedProjection=n,o.size=r,o.data=i,o.merged=!1,o}return x(t,e),t}(ts);function As(e){_c(e)?e.component.projection=function(e){var t=e.specifiedProjection,n=e.config;if(e.hasProjection){var r=[];return[[lr,sr],[fr,cr]].forEach(function(t){(e.channelHasField(t[0])||e.channelHasField(t[1]))&&r.push({signal:e.getName("geojson_"+r.length)})}),e.channelHasField(hr)&&e.fieldDef(hr).type===Lt&&r.push({signal:e.getName("geojson_"+r.length)}),0===r.length&&r.push(e.requestDataName(ws)),new Ns(e.projectionName(!0),S({},n.projection||{},t||{}),[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")],r)}return}(e):e.component.projection=function(e){if(0===e.children.length)return;var t,n=re(e.children,function(e){As(e);var n=e.component.projection;if(n){if(t){var r=function(e,t){var n=re(Os,function(n){return!e.explicit.hasOwnProperty(n)&&!t.explicit.hasOwnProperty(n)||!(!e.explicit.hasOwnProperty(n)||!t.explicit.hasOwnProperty(n)||Z(e.get(n))!==Z(t.get(n)))});if(Z(e.size)===Z(t.size)){if(n)return e;if(Z(e.explicit)===Z({}))return t;if(Z(t.explicit)===Z({}))return e}return null}(t,n);return r&&(t=r),!!r}return t=n,!0}return!0});if(t&&n){var r=e.projectionName(!0),i=new Ns(r,t.specifiedProjection,t.size,me(t.data));return e.children.forEach(function(e){e.component.projection&&(i.data=i.data.concat(e.component.projection.data),e.renameProjection(e.component.projection.get("name"),r),e.component.projection.merged=!0)}),i}return}(e)}function Ts(e){for(var t=0,n=e;t<n.length;t++){for(var r=n[t],i=0,o=r.children;i<o.length;i++){var a=o[i];if(a.parent!==r)return console.error("Dataflow graph is inconsistent.",parent,a),!1}if(!Ts(r.children))return!1}return!0}var _s=function(e){function t(t){var n=e.call(this,null)||this,r=(t=t||{name:"source"}).format?S({},J(t.format,["parse"])):{};if(Ss(t))n._data={values:t.values};else if(xs(t)){if(n._data={url:t.url},!r.type){var i=/(?:\.([^.]+))?$/.exec(t.url)[1];ee(["json","csv","tsv","dsv","topojson"],i)||(i="json"),r.type=i}}else Es(t)&&(n._data={});return t.name&&(n._name=t.name),r&&de(r).length>0&&(n._data.format=r),n}return x(t,e),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),t.prototype.hasName=function(){return!!this._name},Object.defineProperty(t.prototype,"dataName",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{set:function(e){throw new Error("Source nodes have to be roots.")},enumerable:!0,configurable:!0}),t.prototype.remove=function(){throw new Error("Source nodes are roots and cannot be removed.")},t.prototype.hash=function(){throw new Error("Cannot hash sources")},t.prototype.assemble=function(){return S({name:this._name},this._data,{transform:[]})},t}(sa),Ds=function(){function e(){this._mutated=!1}return e.prototype.setMutated=function(){this._mutated=!0},Object.defineProperty(e.prototype,"mutatedFlag",{get:function(){return this._mutated},enumerable:!0,configurable:!0}),e}(),Rs=function(e){function t(){var t=e.call(this)||this;return t._continue=!1,t}return x(t,e),t.prototype.setContinue=function(){this._continue=!0},Object.defineProperty(t.prototype,"continueFlag",{get:function(){return this._continue},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"flags",{get:function(){return{continueFlag:this.continueFlag,mutatedFlag:this.mutatedFlag}},set:function(e){var t=e.continueFlag,n=e.mutatedFlag;t&&this.setContinue(),n&&this.setMutated()},enumerable:!0,configurable:!0}),t.prototype.optimizeNextFromLeaves=function(e){if(e instanceof _s)return!1;var t=e.parent;return this.run(e).continueFlag&&this.optimizeNextFromLeaves(t),this.mutatedFlag},t}(Ds),zs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t}(Ds);var Is=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.dimensions=n,i.measures=r,i}return x(t,e),t.prototype.clone=function(){return new t(null,S({},this.dimensions),me(this.measures))},Object.defineProperty(t.prototype,"groupBy",{get:function(){return this.dimensions},enumerable:!0,configurable:!0}),t.makeFromEncoding=function(e,n){var r=!1;n.forEachFieldDef(function(e){e.aggregate&&(r=!0)});var i={},o={};return r?(n.forEachFieldDef(function(e,t){var r,a,u,s,c=e.aggregate,l=e.field;c?"count"===c?(i["*"]=i["*"]||{},i["*"].count=((r={})[Zt(e,{forAs:!0})]=!0,r)):(i[l]=i[l]||{},i[l][c]=((a={})[Zt(e,{forAs:!0})]=!0,a),Vr(t)&&"unaggregated"===n.scaleDomain(t)&&(i[l].min=((u={})[Zt({field:l,aggregate:"min"},{forAs:!0})]=!0,u),i[l].max=((s={})[Zt({field:l,aggregate:"max"},{forAs:!0})]=!0,s))):function(e,t,n){$r(n.bin)?(e[Zt(n,{})]=!0,e[Zt(n,{binSuffix:"end"})]=!0,hf(n,t)&&(e[Zt(n,{binSuffix:"range"})]=!0)):e[Zt(n)]=!0}(o,t,e)}),de(o).length+de(i).length===0?null:new t(e,o,i)):null},t.makeFromTransform=function(e,n){for(var r,i,o,a,u={},s={},c=0,l=n.aggregate;c<l.length;c++){var f=(g=l[c]).op,d=g.field,p=g.as;f&&("count"===f?(s["*"]=s["*"]||{},s["*"].count=((r={})[p]=!0,r||((i={})[Zt(g,{forAs:!0})]=!0,i))):(s[d]=s[d]||{},s[d][f]=((o={})[p]=!0,o||((a={})[Zt(g,{forAs:!0})]=!0,a))))}for(var h=0,m=n.groupby||[];h<m.length;h++){var g;u[g=m[h]]=!0}return de(u).length+de(s).length===0?null:new t(e,u,s)},t.prototype.merge=function(e){return se(this.dimensions,e.dimensions)?(function(e,t){var n;for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];for(var o in i)i.hasOwnProperty(o)&&(r in e?e[r][o]=S({},e[r][o],i[o]):e[r]=((n={})[o]=i[o],n))}}(this.measures,e.measures),!0):(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Je.debug.apply(Je,arguments)}("different dimensions, cannot merge"),!1)},t.prototype.addDimensions=function(e){var t=this;e.forEach(function(e){return t.dimensions[e]=!0})},t.prototype.dependentFields=function(){var e={};return de(this.dimensions).forEach(function(t){return e[t]=!0}),de(this.measures).forEach(function(t){return e[t]=!0}),e},t.prototype.producedFields=function(){for(var e={},t=0,n=de(this.measures);t<n.length;t++)for(var r=n[t],i=0,o=de(this.measures[r]);i<o.length;i++){var a=o[i];0===de(this.measures[r][a]).length?e[a+"_"+r]=!0:m(e,this.measures[r][a])}return e},t.prototype.hash=function(){return"Aggregate "+$({dimensions:this.dimensions,measures:this.measures})},t.prototype.assemble=function(){for(var e=[],t=[],n=[],r=0,i=de(this.measures);r<i.length;r++)for(var o=i[r],a=0,u=de(this.measures[o]);a<u.length;a++)for(var s=u[a],c=0,l=de(this.measures[o][s]);c<l.length;c++){var f=l[c];n.push(f),e.push(s),t.push(we(o))}return{type:"aggregate",groupby:de(this.dimensions),ops:e,fields:t,as:n}},t}(sa),Fs=function(e){function t(t,n,r,o){var a=e.call(this,t)||this;a.model=n,a.name=r,a.data=o;for(var u=0,s=[pr,dr];u<s.length;u++){var c=s[u],l=n.facet[c];if(l){var f=l.bin,d=l.sort;a[c]=S({name:n.getName(c+"_domain"),fields:[Zt(l)].concat($r(f)?[Zt(l,{binSuffix:"end"})]:[])},ea(d)?{sortField:d}:i(d)?{sortIndexField:ju(l,c)}:{})}}return a.childModel=n.child,a}return x(t,e),t.prototype.hash=function(){var e="Facet";return this.column&&(e+=" c:"+$(this.column)),this.row&&(e+=" r:"+$(this.row)),e},Object.defineProperty(t.prototype,"fields",{get:function(){return(this.column&&this.column.fields||[]).concat(this.row&&this.row.fields||[])},enumerable:!0,configurable:!0}),t.prototype.getSource=function(){return this.name},t.prototype.getChildIndependentFieldsWithStep=function(){for(var e={},t=0,n=["x","y"];t<n.length;t++){var r=n[t],i=this.childModel.component.scales[r];if(i&&!i.merged){var o=i.get("type"),a=i.get("range");if(bi(o)&&Yo(a)){var u=rc(ic(this.childModel,r));u?e[r]=u:Ze("Unknown field for ${channel}.  Cannot calculate view size.")}}}return e},t.prototype.assembleRowColumnData=function(e,t,n){var r="row"===e?"y":"x",i=[],o=[],a=[];n[r]&&(t?(i.push("distinct_"+n[r]),o.push("max")):(i.push(n[r]),o.push("distinct")),a.push("distinct_"+n[r]));var u=this[e],s=u.sortField,c=u.sortIndexField;if(s){var l=s.op,f=s.field;i.push(f),o.push(l),a.push(Zt(s,{forAs:!0}))}else c&&(i.push(c),o.push("max"),a.push(c));return{name:this[e].name,source:t||this.data,transform:[S({type:"aggregate",groupby:this[e].fields},i.length?{fields:i,ops:o,as:a}:{})]}},t.prototype.assemble=function(){var e=[],t=null,n=this.getChildIndependentFieldsWithStep();if(this.column&&this.row&&(n.x||n.y)){t="cross_"+this.column.name+"_"+this.row.name;var r=[].concat(n.x?[n.x]:[],n.y?[n.y]:[]),i=r.map(function(){return"distinct"});e.push({name:t,source:this.data,transform:[{type:"aggregate",groupby:this.column.fields.concat(this.row.fields),fields:r,ops:i}]})}for(var o=0,a=[pr,dr];o<a.length;o++){var u=a[o];this[u]&&e.push(this.assembleRowColumnData(u,t,n))}return e},t}(sa);var Ls=function(e){function t(t,n){var r=e.call(this,t)||this;return r._parse=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this._parse))},t.prototype.hash=function(){return"Parse "+$(this._parse)},t.makeExplicit=function(e,t,n){var r={},i=t.data;return i&&i.format&&i.format.parse&&(r=i.format.parse),this.makeWithAncestors(e,r,{},n)},t.makeImplicitFromFilterTransform=function(e,t,n){var r={};return function e(t,n){if(X(t))e(t.not,n);else if(V(t))for(var r=0,i=t.and;r<i.length;r++)e(i[r],n);else if(G(t))for(var o=0,a=t.or;o<a.length;o++)e(a[o],n);else n(t)}(t.filter,function(e){if(Cl(e)){var t=null;yl(e)?t=e.equal:wl(e)?t=e.range[0]:kl(e)&&(t=(e.oneOf||e.in)[0]),t&&(et(t)?r[e.field]="date":v(t)?r[e.field]="number":a(t)&&(r[e.field]="string")),e.timeUnit&&(r[e.field]="date")}}),0===de(r).length?null:this.makeWithAncestors(e,{},r,n)},t.makeImplicitFromEncoding=function(e,t,n){var r={};return(_c(t)||Dc(t))&&t.forEachFieldDef(function(e){Sn(e)?r[e.field]="date":xn(e)&&Fe(e.aggregate)?r[e.field]="number":Ce(e.field)>1?e.field in r||(r[e.field]="flatten"):Xt(e)&&ea(e.sort)&&Ce(e.sort.field)>1&&(e.sort.field in r||(r[e.sort.field]="flatten"))}),this.makeWithAncestors(e,{},r,n)},t.makeWithAncestors=function(e,n,r,i){for(var o=0,a=de(r);o<a.length;o++){var u=a[o];void 0!==(l=i.getWithExplicit(u)).value&&(l.explicit||l.value===r[u]||"derived"===l.value||"flatten"===r[u]?delete r[u]:Ze(Ge.differentParse(u,r[u],l.value)))}for(var s=0,c=de(n);s<c.length;s++){var l;u=c[s];void 0!==(l=i.get(u))&&(l===n[u]?delete n[u]:Ze(Ge.differentParse(u,n[u],l)))}var f=new ts(n,r);i.copyAll(f);for(var d={},p=0,h=de(f.combine());p<h.length;p++){var m=h[p],g=f.get(m);null!==g&&(d[m]=g)}return 0===de(d).length||i.parseNothing?null:new t(e,d)},Object.defineProperty(t.prototype,"parse",{get:function(){return this._parse},enumerable:!0,configurable:!0}),t.prototype.merge=function(e){this._parse=S({},this._parse,e.parse),e.remove()},t.prototype.assembleFormatParse=function(){for(var e={},t=0,n=de(this._parse);t<n.length;t++){var r=n[t],i=this._parse[r];1===Ce(r)&&(e[r]=i)}return e},t.prototype.producedFields=function(){return y(de(this._parse))},t.prototype.dependentFields=function(){return y(de(this._parse))},t.prototype.assembleTransforms=function(e){var t=this;return void 0===e&&(e=!1),de(this._parse).filter(function(t){return!e||Ce(t)>1}).map(function(e){var n=function(e,t){var n=Se(e);return"number"===t?"toNumber("+n+")":"boolean"===t?"toBoolean("+n+")":"string"===t?"toString("+n+")":"date"===t?"toDate("+n+")":"flatten"===t?n:0===t.indexOf("date:")?"timeParse("+n+","+t.slice(5,t.length)+")":0===t.indexOf("utc:")?"utcParse("+n+","+t.slice(4,t.length)+")":(Ze(Ge.unrecognizedParse(t)),null)}(e,t._parse[e]);return n?{type:"formula",expr:n,as:ke(e)}:null}).filter(function(e){return null!==e})},t}(sa);var js=function(e){function t(t,n){var r=e.call(this,t)||this;return r._stack=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this._stack))},t.makeFromTransform=function(e,n){var r=n.stack,o=n.groupby,u=n.as,s=n.offset,c=void 0===s?"zero":s,l=[],f=[];if(void 0!==n.sort)for(var d=0,p=n.sort;d<p.length;d++){var h=p[d];l.push(h.field),f.push(Oe(h.order,"ascending"))}return new t(e,{stackField:r,groupby:o,offset:c,sort:{field:l,order:f},facetby:[],as:function(e){return i(e)&&e.every(function(e){return a(e)})&&e.length>1}(u)?u:a(u)?[u,u+"_end"]:[n.stack+"_start",n.stack+"_end"]})},t.makeFromEncoding=function(e,n){var r,o=n.stack;if(!o)return null;o.groupbyChannel&&(r=n.fieldDef(o.groupbyChannel));var a,u=function(e){return e.stack.stackBy.reduce(function(e,t){var n=Zt(t.fieldDef);return n&&e.push(n),e},[])}(n),s=n.encoding.order;return a=i(s)||Yt(s)?lf(s):u.reduce(function(e,t){return e.field.push(t),e.order.push("descending"),e},{field:[],order:[]}),new t(e,{dimensionFieldDef:r,stackField:n.vgField(o.fieldChannel),facetby:[],stackby:u,sort:a,offset:o.offset,impute:o.impute,as:[n.vgField(o.fieldChannel,{suffix:"start",forAs:!0}),n.vgField(o.fieldChannel,{suffix:"end",forAs:!0})]})},Object.defineProperty(t.prototype,"stack",{get:function(){return this._stack},enumerable:!0,configurable:!0}),t.prototype.addDimensions=function(e){this._stack.facetby=this._stack.facetby.concat(e)},t.prototype.dependentFields=function(){var e={};e[this._stack.stackField]=!0,this.getGroupbyFields().forEach(function(t){return e[t]=!0}),this._stack.facetby.forEach(function(t){return e[t]=!0});var t=this._stack.sort.field;return i(t)?t.forEach(function(t){return e[t]=!0}):e[t]=!0,e},t.prototype.producedFields=function(){return this._stack.as.reduce(function(e,t){return e[t]=!0,e},{})},t.prototype.hash=function(){return"Stack "+$(this._stack)},t.prototype.getGroupbyFields=function(){var e=this._stack,t=e.dimensionFieldDef,n=e.impute,r=e.groupby;return t?t.bin?n?[Zt(t,{binSuffix:"mid"})]:[Zt(t,{}),Zt(t,{binSuffix:"end"})]:[Zt(t)]:r||[]},t.prototype.assemble=function(){var e=[],t=this._stack,n=t.facetby,r=t.dimensionFieldDef,i=t.stackField,o=t.stackby,a=t.sort,u=t.offset,s=t.impute,c=t.as;return s&&r&&(r.bin&&e.push({type:"formula",expr:"("+Zt(r,{expr:"datum"})+"+"+Zt(r,{expr:"datum",binSuffix:"end"})+")/2",as:Zt(r,{binSuffix:"mid",forAs:!0})}),e.push({type:"impute",field:i,groupby:o,key:Zt(r,{binSuffix:"mid"}),method:"value",value:0})),e.push({type:"stack",groupby:this.getGroupbyFields().concat(n),field:i,sort:a,as:c,offset:u}),e},t}(sa),Us=function(e){function t(t,n){var r=e.call(this,t)||this;return r.formula=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.formula))},t.makeFromEncoding=function(e,n){var r=n.reduceFieldDef(function(e,t){if(t.timeUnit){var n=Zt(t,{forAs:!0});e[n]={as:n,timeUnit:t.timeUnit,field:t.field}}return e},{});return 0===de(r).length?null:new t(e,r)},t.makeFromTransform=function(e,n){var r;return new t(e,((r={})[n.field]={as:n.as,timeUnit:n.timeUnit,field:n.field},r))},t.prototype.merge=function(e){this.formula=S({},this.formula,e.formula),e.remove()},t.prototype.producedFields=function(){var e={};return pe(this.formula).forEach(function(t){e[t.as]=!0}),e},t.prototype.dependentFields=function(){var e={};return pe(this.formula).forEach(function(t){e[t.field]=!0}),e},t.prototype.hash=function(){return"TimeUnit "+$(this.formula)},t.prototype.assemble=function(){return pe(this.formula).map(function(e){return{type:"formula",as:e.as,expr:Ct(e.timeUnit,e.field)}})},t}(sa),Ps=function(e){function t(t,n){var r=e.call(this,t)||this;return r.transform=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform))},t.prototype.addDimensions=function(e){this.transform.groupby=ue(this.transform.groupby.concat(e),function(e){return e})},t.prototype.dependentFields=function(){var e={};return this.transform.groupby.forEach(function(t){return e[t]=!0}),this.transform.sort.forEach(function(t){return e[t.field]=!0}),this.transform.window.map(function(e){return e.field}).filter(function(e){return void 0!==e}).forEach(function(t){return e[t]=!0}),e},t.prototype.producedFields=function(){var e=this,t={};return this.transform.window.forEach(function(n){return t[e.getDefaultName(n)]=!0}),t},t.prototype.getDefaultName=function(e){return e.as||Zt(e)},t.prototype.hash=function(){return"WindowTransform "+$(this.transform)},t.prototype.assemble=function(){for(var e=[],t=[],n=[],r=[],i=0,o=this.transform.window;i<o.length;i++){var a=o[i];t.push(a.op),n.push(this.getDefaultName(a)),r.push(void 0===a.param?null:a.param),e.push(void 0===a.field?null:a.field)}var u=this.transform.frame,s=this.transform.groupby,c=[],l=[];if(void 0!==this.transform.sort)for(var f=0,d=this.transform.sort;f<d.length;f++){var p=d[f];c.push(p.field),l.push(p.order||"ascending")}var h={field:c,order:l},m=this.transform.ignorePeers,g={type:"window",params:r,as:n,ops:t,fields:e,sort:h};return void 0!==m&&(g.ignorePeers=m),void 0!==s&&(g.groupby=s),void 0!==u&&(g.frame=u),g},t}(sa),Ms=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.run=function(e){var t=e.parent;if(e instanceof Ls){if(t instanceof _s)return this.flags;if(t.numChildren()>1)return this.setContinue(),this.flags;if(t instanceof Ls)this.setMutated(),t.merge(e);else{if(fe(t.producedFields(),e.dependentFields()))return this.setContinue(),this.flags;this.setMutated(),e.swapWithParent()}}return this.setContinue(),this.flags},t}(Rs),qs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.mergeNodes=function(e,t){for(var n=t.shift(),r=0,i=t;r<i.length;r++){var o=i[r];e.removeChild(o),o.parent=n,o.remove()}},t.prototype.run=function(e){for(var t=e.children.map(function(e){return e.hash()}),n={},r=0;r<t.length;r++)void 0===n[t[r]]?n[t[r]]=[e.children[r]]:n[t[r]].push(e.children[r]);for(var i=0,o=de(n);i<o.length;i++){var a=o[i];n[a].length>1&&(this.setMutated(),this.mergeNodes(e,n[a]))}for(var u=0,s=e.children;u<s.length;u++){var c=s[u];this.run(c)}return this.mutatedFlag},t}(zs),Hs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.run=function(e){return e instanceof ca||e.numChildren()>0||e instanceof Fs?this.flags:(this.setMutated(),e.remove(),this.flags)},t}(Rs),Ws=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.fields={},t}return x(t,e),t.prototype.run=function(e){var t=this;if(this.setContinue(),e instanceof Us){var n=e.producedFields();de(n).every(function(e){return!!t.fields[e]})?(this.setMutated(),e.remove()):this.fields=S({},this.fields,n)}return this.flags},t}(Rs);function Bs(e){if(e instanceof Fs)if(1!==e.numChildren()||e.children[0]instanceof ca){var t=e.model.component.data.main;!function e(t){if(t instanceof ca&&t.type===ws&&1===t.numChildren()){var n=t.children[0];n instanceof Fs||(n.swapWithParent(),e(t))}}(t);for(var n=(a=e,function e(t){if(!(t instanceof Fs)){var n=t.clone();if(n instanceof ca){var r=Xs+n.getSource();n.setSource(r),a.model.component.data.outputNodes[r]=n}else(n instanceof Is||n instanceof js||n instanceof Ps)&&n.addDimensions(a.fields);return ie(t.children.map(e)).forEach(function(e){return e.parent=n}),[n]}return ie(t.children.map(e))}),r=0,i=ie(e.children.map(n));r<i.length;r++){i[r].parent=t}}else{var o=e.children[0];(o instanceof Is||o instanceof js||o instanceof Ps)&&o.addDimensions(e.fields),o.swapWithParent(),Bs(e)}else e.children.map(Bs);var a}var Ys=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.run=function(e){e instanceof ca&&!e.isRequired()&&(this.setMutated(),e.remove());for(var t=0,n=e.children;t<n.length;t++){var r=n[t];this.run(r)}return this.mutatedFlag},t}(zs),Gs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.run=function(e){var t=e.parent,n=t.children.filter(function(e){return e instanceof Ls});if(n.length>1){for(var r={},i=0,o=n;i<o.length;i++)for(var a=(p=o[i]).parse,u=0,s=de(a);u<s.length;u++){var c=s[u];void 0===r[c]?r[c]=a[c]:r[c]!==a[c]&&delete r[c]}if(0!==de(r).length){this.setMutated();for(var l=new Ls(t,r),f=0,d=n;f<d.length;f++){for(var p=d[f],h=0,m=de(r);h<m.length;h++){var g=m[h];delete p.parse[g]}t.removeChild(p),p.parent=l,0===de(p.parse).length&&p.remove()}}}return this.setContinue(),this.flags},t}(Rs),Vs=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.run=function(e){for(var t=e.parent,n={},r=0,i=t.children.filter(function(e){return e instanceof Is});r<i.length;r++){var o=i[r],a=$(de(o.groupBy).sort());a in n||(n[a]=[]),n[a].push(o)}for(var u=0,s=de(n);u<s.length;u++){var c=n[s[u]];if(c.length>1)for(var l=c.pop(),f=0,d=c;f<d.length;f++){o=d[f];l.merge(o)&&(t.removeChild(o),o.parent=l,o.remove(),this.setMutated())}}return this.setContinue(),this.flags},t}(Rs),Xs="scale_",Ks=5;function Qs(e){var t=[];return e.forEach(function e(n){0===n.numChildren()?t.push(n):n.children.forEach(e)}),t}function Js(e){return e}function Zs(e,t,n){return t.map(function(t){var n=new e;return n instanceof Rs?n.optimizeNextFromLeaves(t):n.run(t)}).some(Js)||n}function $s(e){var t=e.sources,n=!1;return n=Zs(Ys,t,n),t=t.filter(function(e){return e.numChildren()>0}),n=Zs(Hs,Qs(t),n),t=t.filter(function(e){return e.numChildren()>0}),n=Zs(Ms,Qs(t),n),n=Zs(Ws,Qs(t),n),n=Zs(Gs,Qs(t),n),n=Zs(Vs,Qs(t),n),n=Zs(qs,t,n),e.sources=t,n}function ec(e){_c(e)?function(e){var t=e.specifiedScales,n=e.component.scales;de(n).forEach(function(r){var i=t[r],o=i?i.domain:void 0,a=function(e,t){var n=e.getScaleComponent(t).get("type"),r=function(e,t,n,r){if("unaggregated"===e){var i=nc(t,n),o=i.valid,a=i.reason;if(!o)return void Ze(a)}else if(void 0===e&&r.useUnaggregatedDomain){var o=nc(t,n).valid;if(o)return"unaggregated"}return e}(e.scaleDomain(t),e.fieldDef(t),n,e.config.scale);r!==e.scaleDomain(t)&&(e.specifiedScales[t]=S({},e.specifiedScales[t],{domain:r}));if("x"===t&&e.channelHasField("x2"))return e.channelHasField("x")?tc(n,r,e,"x").concat(tc(n,r,e,"x2")):tc(n,r,e,"x2");if("y"===t&&e.channelHasField("y2"))return e.channelHasField("y")?tc(n,r,e,"y").concat(tc(n,r,e,"y2")):tc(n,r,e,"y2");return tc(n,r,e,t)}(e,r),u=n[r];if(u.domains=a,Oi(o)&&u.set("domainRaw",{signal:sl+$(o)},!0),e.component.data.isFaceted){for(var s=e;!Dc(s)&&s.parent;)s=s.parent;var c=s.component.resolve.scale[r];if("shared"===c)for(var l=0,f=a;l<f.length;l++){var d=f[l];Go(d)&&(d.data=Xs+d.data.replace(Xs,""))}}})}(e):function(e){for(var t=0,n=e.children;t<n.length;t++){var r=n[t];ec(r)}var i=e.component.scales;de(i).forEach(function(t){for(var n,r=null,o=0,a=e.children;o<a.length;o++){var u=a[o],s=u.component.scales[t];if(s){n=void 0===n?s.domains:n.concat(s.domains);var c=s.get("domainRaw");r&&c&&r.signal!==c.signal&&Ze("The same selection must be used to override scale domains in a layered view."),r=c}}i[t].domains=n,r&&i[t].set("domainRaw",r,!0)})}(e)}function tc(e,t,n,r){var i=n.fieldDef(r);if(t&&"unaggregated"!==t&&!Oi(t)){var o=i.type,a=i.timeUnit;return"temporal"===o||a?function(e,t,n){return e.map(function(e){return{signal:"{data: "+En(e,{timeUnit:n,type:t})+"}"}})}(t,o,a):[t]}var u=n.stack;if(u&&r===u.fieldChannel)return"normalize"===u.offset?[[0,1]]:[{data:c=n.requestDataName(ws),field:n.vgField(r,{suffix:"start"})},{data:c,field:n.vgField(r,{suffix:"end"})}];var s=Vr(r)?function(e,t,n){if(!bi(n))return;var r=e.fieldDef(t),i=r.sort;if(ta(i))return{op:"min",field:ju(r,t),order:"ascending"};if(ea(i))return S({},i,i.field?{field:we(i.field)}:{});if("descending"===i)return{op:"min",field:e.vgField(t),order:"descending"};if(ee(["ascending",void 0],i))return!0;return}(n,r,e):void 0;if("unaggregated"===t){var c=n.requestDataName(ws),l=i.field;return[{data:c,field:Zt({field:l,aggregate:"min"})},{data:c,field:Zt({field:l,aggregate:"max"})}]}if($r(i.bin)){if(xi(e)){var f=n.getName(Zr(i.bin)+"_"+i.field+"_bins");return[{signal:"sequence("+f+".start, "+f+".stop + "+f+".step, "+f+".step)"}]}return bi(e)?[{data:ge(s)?n.requestDataName(ws):n.requestDataName(ks),field:n.vgField(r,hf(i,r)?{binSuffix:"range"}:{}),sort:!0!==s&&ea(s)?s:{field:n.vgField(r,{}),op:"min"}}]:"x"===r||"y"===r?ti(i.bin)&&i.bin.extent?[i.bin.extent]:[{data:c=n.requestDataName(ws),field:n.vgField(r,{})},{data:c,field:n.vgField(r,{binSuffix:"end"})}]:[{data:n.requestDataName(ws),field:n.vgField(r,{})}]}return s?[{data:ge(s)?n.requestDataName(ws):n.requestDataName(ks),field:n.vgField(r),sort:s}]:[{data:n.requestDataName(ws),field:n.vgField(r)}]}function nc(e,t){return e.aggregate?Ue[e.aggregate]?"quantitative"===e.type&&"log"===t?{valid:!1,reason:Ge.unaggregatedDomainWithLogScale(e)}:{valid:!0}:{valid:!1,reason:Ge.unaggregateDomainWithNonSharedDomainOp(e.aggregate)}:{valid:!1,reason:Ge.unaggregateDomainHasNoEffectForRawField(e)}}function rc(e){if(Go(e)&&a(e.field))return e.field;if(function(e){return!i(e)&&"fields"in e&&!("data"in e)}(e)){for(var t=void 0,n=0,r=e.fields;n<r.length;n++){var o=r[n];if(Go(o)&&a(o.field))if(t){if(t!==o.field)return Ze("Detected faceted independent scales that union domain of multiple fields from different data sources.  We will use the first field.  The result view size may be incorrect."),t}else t=o.field}return Ze("Detected faceted independent scales that union domain of identical fields from different source detected.  We will assume that this is the same field from a different fork of the same data source.  However, if this is not case, the result view size maybe incorrect."),t}return function(e){return!i(e)&&"fields"in e&&"data"in e}(e)?(Ze("Detected faceted independent scales that union domain of multiple fields from the same data source.  We will use the first field.  The result view size may be incorrect."),a(t=e.fields[0])?t:void 0):void 0}function ic(e,t){return function(e){var t=ue(e.map(function(e){return Go(e)?(e.sort,E(e,["sort"])):e}),$),n=ue(e.map(function(e){if(Go(e)){var t=e.sort;return void 0===t||ge(t)||("count"===t.op&&delete t.field,"ascending"===t.order&&delete t.order),t}}).filter(function(e){return void 0!==e}),$);if(1===t.length){if(Go(a=e[0])&&n.length>0){var r=n[0];return n.length>1&&(Ze(Ge.MORE_THAN_ONE_SORT),r=!0),S({},a,{sort:r})}return a}var i,o=ue(n.map(function(e){return ge(e)?e:"count"===e.op?e:(Ze(Ge.domainSortDropped(e)),!0)}),$);1===o.length?i=o[0]:o.length>1&&(Ze(Ge.MORE_THAN_ONE_SORT),i=!0);var a,u=ue(e.map(function(e){return Go(e)?e.data:null}),function(e){return e});return 1===u.length&&null!==u[0]?a=S({data:u[0],fields:t.map(function(e){return e.field})},i?{sort:i}:{}):S({fields:t},i?{sort:i}:{})}(e.component.scales[t].domains.map(function(t){return Go(t)&&(t.data=e.lookupDataSource(t.data)),t}))}function oc(e){return de(e.component.scales).reduce(function(t,n){var r=e.component.scales[n];if(r.merged)return t;var o=r.combine(),a=o.domainRaw,s=o.range,c=o.name,l=o.type,f=(o.domainRaw,o.range,E(o,["name","type","domainRaw","range"]));return s=function(e,t,n,r){if("x"===r||"y"===r){if(Yo(e))return{step:{signal:t+"_step"}};if(i(e)&&2===e.length){var o=e[0],a=e[1];if(0===o&&Bo(a))return[0,{signal:n.getSizeName(a.signal)}];if(Bo(o)&&0===a)return[{signal:n.getSizeName(o.signal)},0]}}return e}(s,c,e,n),a&&function(e){return e.signal.indexOf(sl)>=0}(a)&&(a=function(e,t){var n=JSON.parse(t.signal.replace(sl,"")),r=ve(n.selection),i=n.encoding,o=n.field,a=e.component.selection&&e.component.selection[r];if(!a){if(a=e.getSelectionComponent(r,n.selection),i||o){if(i&&!o){var s=a.project.filter(function(e){return e.channel===i});!s.length||s.length>1?(o=a.project[0].field,Ze((s.length?"Multiple ":"No ")+"matching "+u(i)+" encoding found for selection "+u(n.selection)+'. Using "field": '+u(o)+".")):o=s[0].field}}else o=a.project[0].field,a.project.length>1&&Ze('A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": '+u(o)+".");return{signal:Se(o,r)}}Ze('Use "bind": "scales" to setup a binding for scales and selections within the same view.');return{signal:"null"}}(e,a)),t.push(S({name:c,type:l,domain:ic(e,n)},a?{domainRaw:a}:{},{range:s},f)),t},[])}var ac=function(e){function t(t,n){var r=e.call(this,{},{name:t})||this;return r.merged=!1,r.domains=[],r.setWithExplicit("type",n),r}return x(t,e),t}(ts),uc=["shortTimeLabels"],sc=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength"],cc={width:200,height:200};function lc(e){return e&&!!e.scheme}var fc={padding:5,timeFormat:"%b %d, %Y",countTitle:"Number of Records",invalidValues:"filter",view:cc,mark:Qn,area:{},bar:Jn,circle:{},geoshape:{},line:{},point:{},rect:{},rule:{color:"black"},square:{},text:{color:"black"},tick:Zn,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:ki,projection:{},axis:{},axisX:{},axisY:{minExtent:30},axisLeft:{},axisRight:{},axisTop:{},axisBottom:{},axisBand:{},legend:Xu,selection:to,style:{},title:{}};function dc(e){return oe(me(fc),e)}var pc=["view"].concat(Mn),hc=["padding","numberFormat","timeFormat","countTitle","stack","scale","selection","invalidValues","overlay"],mc=S({view:["width","height"]},Kn);function gc(e){e=me(e);for(var t=0,n=hc;t<n.length;t++){delete e[a=n[t]]}if(e.axis)for(var r=0,i=uc;r<i.length;r++){var a=i[r];delete e.axis[a]}if(e.legend){for(var u=0,s=uc;u<s.length;u++){a=s[u];delete e.legend[a]}for(var c=0,l=sc;c<l.length;c++){a=l[c];delete e.legend[a]}}if(e.mark)for(var f=0,d=Xn;f<d.length;f++){a=d[f];delete e.mark[a]}for(var p=0,h=pc;p<h.length;p++){for(var m=h[p],g=0,v=Xn;g<v.length;g++){a=v[g];delete e[m][a]}var y=mc[m];if(y)for(var b=0,x=y;b<x.length;b++){a=x[b];delete e[m][a]}vc(e,m)}for(var S=0,E=Bf();S<E.length;S++){delete e[E[S]]}for(var a in vc(e,"title","group-title"),e)o(e[a])&&0===de(e[a]).length&&delete e[a];return de(e).length>0?e:void 0}function vc(e,t,n,r){var i="title"===t?Co(e.title).mark:r?e[t][r]:e[t];"view"===t&&(n="cell");var o=S({},i,e.style[t]);de(o).length>0&&(e.style[n||t]=o),r||delete e[t]}var yc=Object.freeze({defaultViewConfig:cc,isVgScheme:lc,defaultConfig:fc,initConfig:dc,stripAndRedirectConfig:gc}),bc=["range","rangeStep","scheme"];function xc(e){_c(e)?function(e){var t=e.component.scales;Gr.forEach(function(n){var r=t[n];if(r){var i=e.getScaleComponent(n),o=e.specifiedScales[n],a=e.fieldDef(n),u="x"===n?"width":"y"===n?"height":void 0,s=u?!!e.component.layoutSize.get(u):void 0,c=i.get("type"),l=ee(["point","band"],c)||!!o.rangeStep;u&&e.fit&&!s&&l&&(Ze(Ge.CANNOT_FIX_RANGE_STEP_WITH_FIT),s=!0);var f=function(e){var t=[],n=e.getScaleComponent("x"),r=n&&n.get("range");r&&Yo(r)&&v(r.step)&&t.push(r.step);var i=e.getScaleComponent("y"),o=i&&i.get("range");o&&Yo(o)&&v(o.step)&&t.push(o.step);return t}(e),d=function(e,t,n,r,i,o,a,u,s,c){for(var l=u||null===r.rangeStep,f=0,d=bc;f<d.length;f++){var p=d[f];if(void 0!==r[p]){var h=Di(t,p),m=Ri(e,p);if(h)if(m)Ze(m);else switch(p){case"range":return ns(r[p]);case"scheme":return ns(Sc(r[p]));case"rangeStep":var g=r[p];if(null!==g){if(!u)return ns({step:g});Ze(Ge.rangeStepDropped(e))}}else Ze(Ge.scalePropertyNotWorkWithScaleType(t,p,e))}}return rs(function(e,t,n,r,i,o,a,u,s,c){switch(e){case er:case tr:if(ee(["point","band"],t)&&!s)if(e===er&&"text"===o){if(r.scale.textXRangeStep)return{step:r.scale.textXRangeStep}}else if(r.scale.rangeStep)return{step:r.scale.rangeStep};return e===tr&&Si(t)?[{signal:a},0]:[0,{signal:a}];case mr:var l=function(e,t,n){if(t)return 0;switch(e){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(Ge.incompatibleChannel("size",e))}(o,i,r),f=function(e,t,n){var r=n.scale;switch(e){case"bar":case"tick":return void 0!==n.scale.maxBandSize?n.scale.maxBandSize:wc(t,n.scale)-1;case"line":case"trail":case"rule":return n.scale.maxStrokeWidth;case"text":return n.scale.maxFontSize;case"point":case"square":case"circle":if(n.scale.maxSize)return n.scale.maxSize;var i=wc(t,r);return(i-2)*(i-2)}throw new Error(Ge.incompatibleChannel("size",e))}(o,u,r);return wi(t)?function(e,t,n){for(var r=[],i=(t-e)/(n-1),o=0;o<n;o++)r.push(e+o*i);return r}(l,f,Ec(t,r,c,e)):[l,f];case Or:return[r.scale.minStrokeWidth,r.scale.maxStrokeWidth];case hr:return"symbol";case gr:case vr:case yr:if("ordinal"===t)return"nominal"===n?"category":"ordinal";if(wi(t)){var d=Ec(t,r,c,e);return r.range&&lc(r.range.ordinal)?S({},r.range.ordinal,{count:d}):{scheme:"blues",count:d}}return Ei(t)?["#f7fbff","#0e427f"]:"rect"===o||"geoshape"===o?"heatmap":"ramp";case wr:case kr:case Cr:return[r.scale.minOpacity,r.scale.maxOpacity]}throw new Error("Scale range undefined for channel "+e)}(e,t,n,i,o,a,s,c,l,r.domain))}(n,c,a.type,o,e.config,r.get("zero"),e.mark,s,e.getName(u),f);r.setWithExplicit("range",d)}})}(e):Cc(e,"range")}function Sc(e){if(Ci(e)){var t={scheme:e.name};return e.count&&(t.count=e.count),e.extent&&(t.extent=e.extent),t}return{scheme:e}}function Ec(e,t,n,r){switch(e){case"quantile":return t.scale.quantileCount;case"quantize":return t.scale.quantizeCount;case"threshold":return void 0!==n&&i(n)?n.length+1:(Ze(Ge.domainRequiredForThresholdScale(r)),3)}}function wc(e,t){return e.length>0?Math.min.apply(null,e):t.rangeStep?t.rangeStep:21}function kc(e,t){_c(e)?function(e,t){var n=e.component.scales;de(n).forEach(function(r){var i=e.specifiedScales[r],o=n[r],a=e.getScaleComponent(r),u=e.fieldDef(r),s=e.config,c=i[t],l=a.get("type"),f=Di(l,t),d=Ri(r,t);if(void 0!==c&&(f?d&&Ze(d):Ze(Ge.scalePropertyNotWorkWithScaleType(l,t,r))),f&&void 0===d)if(void 0!==c)o.copyKeyFromObject(t,i);else{var p=function(e,t,n,r,i,o,a,u,s){var c=s.scale;switch(e){case"interpolate":return function(e,t){if(ee([gr,vr,yr],e)&&Ei(t))return"hcl";return}(t,r);case"nice":return function(e,t,n){if(n.bin||ee([ri.TIME,ri.UTC],e))return;return!!ee([er,tr],t)||void 0}(r,t,n);case"padding":return function(e,t,n,r,i,o){if(ee([er,tr],e)){if(Ei(t)){if(void 0!==n.continuousPadding)return n.continuousPadding;var a=i.type,u=i.orient;if("bar"===a&&!r.bin&&("vertical"===u&&"x"===e||"horizontal"===u&&"y"===e))return o.continuousBandSize}if(t===ri.POINT)return n.pointPadding}return}(t,r,c,n,u,s.bar);case"paddingInner":return function(e,t,n){if(void 0!==e)return;if(ee([er,tr],t))return n.bandPaddingInner;return}(i,t,c);case"paddingOuter":return function(e,t,n,r,i){if(void 0!==e)return;if(ee([er,tr],t)&&n===ri.BAND)return void 0!==i.bandPaddingOuter?i.bandPaddingOuter:r/2;return}(i,t,r,o,c);case"reverse":return function(e,t){if(Si(e)&&"descending"===t)return!0;return}(r,n.sort);case"zero":return function(e,t,n,r,i){if(n&&"unaggregated"!==n)return!1;if("size"===e&&"quantitative"===t.type&&!wi(i))return!0;if(!t.bin&&ee([er,tr],e)){var o=r.orient,a=r.type;return!ee(["bar","area","line","trail"],a)||!("horizontal"===o&&"y"===e||"vertical"===o&&"x"===e)}return!1}(t,n,a,u,r)}return c[e]}(t,r,u,a.get("type"),a.get("padding"),a.get("paddingInner"),i.domain,e.markDef,s);void 0!==p&&o.set(t,p,!1)}})}(e,t):Cc(e,t)}function Cc(e,t){for(var n=e.component.scales,r=0,i=e.children;r<i.length;r++){var o=i[r];"range"===t?xc(o):kc(o,t)}de(n).forEach(function(r){for(var i,o=0,a=e.children;o<a.length;o++){var u=a[o].component.scales[r];if(u)i=as(i,u.getWithExplicit(t),t,"scale",is(function(e,n){switch(t){case"range":return e.step&&n.step?e.step-n.step:0}return 0}))}n[r].setWithExplicit(t,i)})}function Oc(e,t,n,r,o){var a=function(e,t,n,r,o){switch(t.type){case"nominal":case"ordinal":if(Rr(e)||"discrete"===Qr(e))return"shape"===e&&"ordinal"===t.type&&Ze(Ge.discreteChannelCannotEncode(e,"ordinal")),"ordinal";if(ee(["x","y"],e)){if(ee(["rect","bar","rule"],n))return"band";if("bar"===n)return"band"}return"point";case"temporal":return Rr(e)?"sequential":"discrete"===Qr(e)?(Ze(Ge.discreteChannelCannotEncode(e,"temporal")),"ordinal"):"time";case"quantitative":if(Rr(e)){if($r(t.bin))return"bin-ordinal";var a=r||{},u=a.domain,s=void 0===u?void 0:u,c=a.range,l=void 0===c?void 0:c;return s&&i(s)&&s.length>2&&l&&i(l)&&l.length>2?"linear":"sequential"}return"discrete"===Qr(e)?(Ze(Ge.discreteChannelCannotEncode(e,"quantitative")),"ordinal"):$r(t.bin)&&"x"!==e&&"y"!==e?"bin-linear":"linear";case"geojson":return}throw new Error(Ge.invalidFieldType(t.type))}(t,n,r,e),u=e.type;return Vr(t)?void 0!==u?Ii(t,u)?zi(u,n.type,n.bin)?u:(Ze(Ge.scaleTypeNotWorkWithFieldDef(u,a)),a):(Ze(Ge.scaleTypeNotWorkWithChannel(t,u,a)),a):a:null}function Nc(e){_c(e)?e.component.scales=function(e){var t=e.encoding,n=e.config,r=e.mark;return Gr.reduce(function(i,o){var a,u,s=t[o];if(Yt(s)&&r===Fn&&o===hr&&s.type===Lt)return i;if(Yt(s)?(a=s,u=s.scale):Wt(s)?(a=s.condition,u=s.condition.scale):o===er?a=hn(t.x2):o===tr&&(a=hn(t.y2)),a&&null!==u&&!1!==u){var c=Oc(u=u||{},o,a,r,n.scale);i[o]=new ac(e.scaleName(o+"",!0),{value:c,explicit:u.type===c})}return i},{})}(e):e.component.scales=function(e){for(var t=e.component.scales={},n={},r=e.component.resolve,i=function(t){Nc(t),de(t.component.scales).forEach(function(i){if(r.scale[i]=r.scale[i]||function(e,t){if(Ic(t)||Dc(t))return"shared";if(zc(t)||Rc(t))return ee(qr,e)?"independent":"shared";throw new Error("invalid model type for resolve")}(i,e),"shared"===r.scale[i]){var o=n[i],a=t.component.scales[i].getWithExplicit("type");o?ui(o.value,a.value)?n[i]=as(o,a,"type","scale",Ac):(r.scale[i]="independent",delete n[i]):n[i]=a}})},o=0,a=e.children;o<a.length;o++){var u=a[o];i(u)}return de(n).forEach(function(r){var i=e.scaleName(r,!0),o=n[r];t[r]=new ac(i,o);for(var a=0,u=e.children;a<u.length;a++){var s=u[a],c=s.component.scales[r];c&&(s.renameScale(c.get("name"),i),c.merged=!0)}}),t}(e)}var Ac=is(function(e,t){return ci(e)-ci(t)});var Tc=function(){function e(){this.nameMap={}}return e.prototype.rename=function(e,t){this.nameMap[e]=t},e.prototype.has=function(e){return void 0!==this.nameMap[e]},e.prototype.get=function(e){for(;this.nameMap[e]&&e!==this.nameMap[e];)e=this.nameMap[e];return e},e}();function _c(e){return e&&"unit"===e.type}function Dc(e){return e&&"facet"===e.type}function Rc(e){return e&&"repeat"===e.type}function zc(e){return e&&"concat"===e.type}function Ic(e){return e&&"layer"===e.type}var Fc=function(){function e(e,t,n,r,i,o){var u,s,c,l,f,d,p,h,m=this;this.children=[],this.correctDataNames=function(e){return e.from&&e.from.data&&(e.from.data=m.lookupDataSource(e.from.data)),e.from&&e.from.facet&&e.from.facet.data&&(e.from.facet.data=m.lookupDataSource(e.from.facet.data)),e},this.parent=t,this.config=r,this.repeater=i,this.name=e.name||n,this.title=a(e.title)?{text:e.title}:e.title,this.scaleNameMap=t?t.scaleNameMap:new Tc,this.projectionNameMap=t?t.projectionNameMap:new Tc,this.layoutSizeNameMap=t?t.layoutSizeNameMap:new Tc,this.data=e.data,this.description=e.description,this.transforms=Ho(e.transform||[]),this.layout=go(e)||vo(e)?void 0:(s=(u=e||{}).align,c=void 0===s?void 0:s,l=u.center,f=void 0===l?void 0:l,d=u.bounds,p=void 0===d?void 0:d,h=u.spacing,{align:c,bounds:p,center:f,spacing:void 0===h?void 0:h}),this.component={data:{sources:t?t.component.data.sources:[],outputNodes:t?t.component.data.outputNodes:{},outputNodeRefCounts:t?t.component.data.outputNodeRefCounts:{},isFaceted:mo(e)||t&&t.component.data.isFaceted&&!e.data},layoutSize:new ts,layoutHeaders:{row:{},column:{}},mark:null,resolve:S({scale:{},axis:{},legend:{}},o?me(o):{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}return Object.defineProperty(e.prototype,"width",{get:function(){return this.getSizeSignalRef("width")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.getSizeSignalRef("height")},enumerable:!0,configurable:!0}),e.prototype.initSize=function(e){var t=e.width,n=e.height;t&&this.component.layoutSize.set("width",t,!0),n&&this.component.layoutSize.set("height",n,!0)},e.prototype.parse=function(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSize(),this.parseSelection(),this.parseProjection(),this.parseData(),this.parseAxisAndHeader(),this.parseLegend(),this.parseMarkGroup()},e.prototype.parseScale=function(){!function(e){Nc(e),ec(e);for(var t=0,n=Ti;t<n.length;t++)kc(e,n[t]);xc(e)}(this)},e.prototype.parseProjection=function(){As(this)},e.prototype.renameTopLevelLayoutSize=function(){"width"!==this.getName("width")&&this.renameLayoutSize(this.getName("width"),"width"),"height"!==this.getName("height")&&this.renameLayoutSize(this.getName("height"),"height")},e.prototype.parseLegend=function(){ps(this)},e.prototype.assembleGroupStyle=function(){if("unit"===this.type||"layer"===this.type)return"cell"},e.prototype.assembleLayoutSize=function(){if("unit"===this.type||"layer"===this.type)return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},e.prototype.assembleLayout=function(){if(this.layout){var e=this.layout,t=e.align,n=e.bounds,r=e.center,i=e.spacing,o=void 0===i?{}:i;return S({padding:v(o)?o:{row:o.row||10,column:o.column||10}},this.assembleDefaultLayout(),t?{align:t}:{},n?{bounds:n}:{},r?{center:r}:{})}},e.prototype.assembleDefaultLayout=function(){return{}},e.prototype.assembleHeaderMarks=function(){for(var e=this.component.layoutHeaders,t=[],n=0,r=Uu;n<r.length;n++){e[a=r[n]].title&&t.push(Mu(this,a))}for(var i=0,o=Uu;i<o.length;i++){var a=o[i];t=t.concat(qu(this,a))}return t},e.prototype.assembleAxes=function(){return e=this.component.axes,t=this.config,n=e.x,r=void 0===n?[]:n,i=e.y,o=void 0===i?[]:i,r.map(function(e){return Xo(e,"main",t)}).concat(r.map(function(e){return Xo(e,"grid",t)}),o.map(function(e){return Xo(e,"main",t)}),o.map(function(e){return Xo(e,"grid",t)})).filter(function(e){return e});var e,t,n,r,i,o},e.prototype.assembleLegends=function(){return vs(this)},e.prototype.assembleProjections=function(){return ys(this)},e.prototype.assembleTitle=function(){var e=this.title||{},t=e.encoding,n=E(e,["encoding"]),r=S({},Co(this.config.title).nonMark,n,t?{encode:{update:t}}:{});if(r.text)return ee(["unit","layer"],this.type)||(r.anchor&&"start"!==r.anchor&&Ze(Ge.cannotSetTitleAnchor(this.type)),r.anchor="start"),ee(["middle",void 0],r.anchor)&&void 0===r.frame&&(r.frame="group"),de(r).length>0?r:void 0},e.prototype.assembleGroup=function(e){void 0===e&&(e=[]);var t={};(e=e.concat(this.assembleSelectionSignals())).length>0&&(t.signals=e);var n=this.assembleLayout();n&&(t.layout=n),t.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());var r=!this.parent||Dc(this.parent)?function e(t){return Ic(t)||zc(t)||Rc(t)?t.children.reduce(function(t,n){return t.concat(e(n))},oc(t)):oc(t)}(this):[];r.length>0&&(t.scales=r);var i=this.assembleAxes();i.length>0&&(t.axes=i);var o=this.assembleLegends();return o.length>0&&(t.legends=o),t},e.prototype.hasDescendantWithFieldOnChannel=function(e){for(var t=0,n=this.children;t<n.length;t++){var r=n[t];if(_c(r)){if(r.channelHasField(e))return!0}else if(r.hasDescendantWithFieldOnChannel(e))return!0}return!1},e.prototype.getName=function(e){return ve((this.name?this.name+"_":"")+e)},e.prototype.requestDataName=function(e){var t=this.getName(e),n=this.component.data.outputNodeRefCounts;return n[t]=(n[t]||0)+1,t},e.prototype.getSizeSignalRef=function(e){if(Dc(this.parent)){var t="width"===e?"x":"y",n=this.component.scales[t];if(n&&!n.merged){var r=n.get("type"),i=n.get("range");if(bi(r)&&Yo(i)){var o=n.get("name"),a=rc(ic(this,t));return a?{signal:Vu(o,n,Zt({aggregate:"distinct",field:a},{expr:"datum"}))}:(Ze("Unknown field for ${channel}.  Cannot calculate view size."),null)}}}return{signal:this.layoutSizeNameMap.get(this.getName(e))}},e.prototype.lookupDataSource=function(e){var t=this.component.data.outputNodes[e];return t?t.getSource():e},e.prototype.getSizeName=function(e){return this.layoutSizeNameMap.get(e)},e.prototype.renameLayoutSize=function(e,t){this.layoutSizeNameMap.rename(e,t)},e.prototype.renameScale=function(e,t){this.scaleNameMap.rename(e,t)},e.prototype.renameProjection=function(e,t){this.projectionNameMap.rename(e,t)},e.prototype.scaleName=function(e,t){return t?this.getName(e):Lr(e)&&Vr(e)&&this.component.scales[e]||this.scaleNameMap.has(this.getName(e))?this.scaleNameMap.get(this.getName(e)):void 0},e.prototype.projectionName=function(e){return e?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0},e.prototype.getScaleComponent=function(e){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale().  Make sure you have called parseScale or use parseUnitModelWithScale().");var t=this.component.scales[e];return t&&!t.merged?t:this.parent?this.parent.getScaleComponent(e):void 0},e.prototype.getSelectionComponent=function(e,t){var n=this.component.selection[e];if(!n&&this.parent&&(n=this.parent.getSelectionComponent(e,t)),!n)throw new Error(Ge.selectionNotFound(t));return n},e}(),Lc=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return x(t,e),t.prototype.vgField=function(e,t){void 0===t&&(t={});var n=this.fieldDef(e);if(n)return Zt(n,t)},t.prototype.reduceFieldDef=function(e,t,n){return wf(this.getMapping(),function(t,n,r){var i=hn(n);return i?e(t,i,r):t},t,n)},t.prototype.forEachFieldDef=function(e,t){Ef(this.getMapping(),function(t,n){var r=hn(t);r&&e(r,n)},t)},t}(Fc),jc="_fields",Uc={has:function(e){var t=e;return void 0!==t.fields||void 0!==t.encodings},parse:function(e,t,n){var r={},i={},o=n.project||(n.project=[]);n.fields={},t.fields&&o.push.apply(o,t.fields.map(function(e){return{field:e,type:"E"}}));for(var a=0,u=t.encodings||[];a<u.length;a++){var s=u[a],c=e.fieldDef(s);if(c){var l=c.field;if(c.timeUnit&&(r[l=e.vgField(s)]={as:l,field:c.field,timeUnit:c.timeUnit}),!i[l]){var f="E";if("interval"===n.type){var d=e.getScaleComponent(s).get("type");Si(d)&&!xi(d)&&(f="R")}else c.bin&&(f="R-RE");o.push(i[l]={field:l,channel:s,type:f})}n.fields[s]=l}else Ze(Ge.cannotProjectOnChannelWithoutField(s))}de(r).length&&(n.timeUnit=new Us(null,r))},signals:function(e,t,n){var r=t.name+al+jc;return n.filter(function(e){return e.name===r}).length?n:n.concat({name:r,update:""+JSON.stringify(t.project)})}},Pc={has:function(e){return"interval"===e.type&&"global"===e.resolve&&e.bind&&"scales"===e.bind},parse:function(e,t,n){for(var r=ve(n.name),i=n.scales=[],o=0,a=n.project;o<a.length;o++){var u=a[o],s=u.channel;if(Vr(s)){var c=e.getScaleComponent(s),l=c?c.get("type"):void 0;if(c&&Si(l)&&!xi(l)){if(c.set("domainRaw",{signal:Se(u.field,r)},!0),i.push(s),e.repeater&&e.repeater.row===e.repeater.column)e.getScaleComponent(s===er?tr:er).set("domainRaw",{signal:Se(u.field,r)},!0)}else Ze(Ge.SCALE_BINDINGS_CONTINUOUS)}}},topLevelSignals:function(e,t,n){var r=t.scales.filter(function(e){return!n.filter(function(n){return n.name===gl(t,e,"data")}).length}).map(function(e){return{channel:e,signal:gl(t,e,"data")}});if(!e.parent||!r.length)return n;var i=n.filter(function(e){return e.name===t.name})[0],o=i.update;if(o.indexOf(cl)>=0)i.update="{"+r.map(function(e){return u(t.fields[e.channel])+": "+e.signal}).join(", ")+"}";else for(var a=0,s=r;a<s.length;a++){var c=s[a],l=", "+u(t.fields[c.channel])+": "+c.signal;o.indexOf(l)<0&&(i.update=o.substring(0,o.length-1)+l+"}")}return n.concat(r.map(function(e){return{name:e.signal}}))},signals:function(e,t,n){if(e.parent)for(var r=function(e){var r=n.filter(function(n){return n.name===gl(t,e,"data")})[0];r.push="outer",delete r.value,delete r.update},i=0,o=t.scales;i<o.length;i++){r(o[i])}return n}};function Mc(e,t){return"domain("+u(e.scaleName(t))+")"}var qc="_scale_trigger",Hc={signals:function(e,t){var n=t.name,r=n+al+jc,i=Pc.has(t),o=[],a=[],s=[];if(t.translate&&!i){var c="!event.item || event.item.mark.name !== "+u(n+"_brush");Bc(t,function(e,t){var n=t.between[0].filter||(t.between[0].filter=[]);n.indexOf(c)<0&&n.push(c)})}for(var l=0,f=t.project;l<f.length;l++){var d=f[l].channel;if(d===er||d===tr){var p=Wc(e,t,d),h=gl(t,d,"data"),m=gl(t,d,"visual"),g=u(e.scaleName(d)),v=Si(e.getScaleComponent(d).get("type"))?"+":"";o.push.apply(o,p),a.push(h),s.push({scaleName:e.scaleName(d),expr:"(!isArray("+h+") || ("+v+"invert("+g+", "+m+")[0] === "+v+h+"[0] && "+v+"invert("+g+", "+m+")[1] === "+v+h+"[1]))"})}else Ze("Interval selections only support x and y encoding channels.")}return i||o.push({name:n+qc,update:s.map(function(e){return e.expr}).join(" && ")+" ? "+(n+qc)+" : {}"}),o.concat({name:n+al,on:[{events:a.map(function(e){return{signal:e}}),update:a.join(" && ")+" ? {unit: "+hl(e)+", fields: "+r+", values: ["+a.join(", ")+"]} : null"}]})},modifyExpr:function(e,t){return t.name+al+", "+("global"===t.resolve?"true":"{unit: "+hl(e)+"}")},marks:function(e,t,n){var r=t.name,i=vl(t),o=i.xi,a=i.yi,s="data("+u(t.name+ol)+")";if(Pc.has(t))return n;var c={x:null!==o?{signal:r+"_x[0]"}:{value:0},y:null!==a?{signal:r+"_y[0]"}:{value:0},x2:null!==o?{signal:r+"_x[1]"}:{field:{group:"width"}},y2:null!==a?{signal:r+"_y[1]"}:{field:{group:"height"}}};if("global"===t.resolve)for(var l=0,f=de(c);l<f.length;l++){var d=f[l];c[d]=[S({test:s+".length && "+s+"[0].unit === "+hl(e)},c[d]),{value:0}]}var p=t.mark,h=p.fill,m=p.fillOpacity,g=E(p,["fill","fillOpacity"]),v=de(g).reduce(function(e,t){return e[t]=[{test:[null!==o&&r+"_x[0] !== "+r+"_x[1]",null!=a&&r+"_y[0] !== "+r+"_y[1]"].filter(function(e){return e}).join(" && "),value:g[t]},{value:null}],e},{});return[{name:r+"_brush_bg",type:"rect",clip:!0,encode:{enter:{fill:{value:h},fillOpacity:{value:m}},update:c}}].concat(n,{name:r+"_brush",type:"rect",clip:!0,encode:{enter:{fill:{value:"transparent"}},update:S({},c,v)}})}};function Wc(e,t,n){var r=gl(t,n,"visual"),i=gl(t,n,"data"),o=Pc.has(t),a=u(e.scaleName(n)),s=e.getScaleComponent(n),c=s?s.get("type"):void 0,l=e.getSizeSignalRef(n===er?"width":"height").signal,f=n+"(unit)",d=Bc(t,function(e,t){return e.concat({events:t.between[0],update:"["+f+", "+f+"]"},{events:t,update:"["+r+"[0], clamp("+f+", 0, "+l+")]"})});return d.push({events:{signal:t.name+qc},update:Si(c)&&!xi(c)?"[scale("+a+", "+i+"[0]), scale("+a+", "+i+"[1])]":"[0, 0]"}),o?[{name:i,on:[]}]:[{name:r,value:[],on:d},{name:i,on:[{events:{signal:r},update:r+"[0] === "+r+"[1] ? null : invert("+a+", "+r+")"}]}]}function Bc(e,t){return e.events.reduce(function(e,n){return n.between?t(e,n):(Ze(n+" is not an ordered event stream for interval selections"),e)},[])}var Yc={has:function(e){return"interval"!==e.type&&e.nearest},marks:function(e,t,n){var r=vl(t),i=r.x,o=r.y,a=e.mark;if(Pn(a))return Ze(Ge.nearestNotSupportForContinuous(a)),n;var u={name:e.getName("voronoi"),type:"path",from:{data:e.getName("marks")},encode:{enter:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0}}},transform:[{type:"voronoi",x:{expr:i||!i&&!o?"datum.datum.x || 0":"0"},y:{expr:o||!i&&!o?"datum.datum.y || 0":"0"},size:[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]}]},s=0,c=!1;return n.forEach(function(t,n){var r=t.name||"";r===e.component.mark[0].name?s=n:r.indexOf("voronoi")>=0&&(c=!0)}),c||n.splice(s+1,0,u),n}};function Gc(e,t){var n=t.name,r=n+al+jc,i=t.project,o=Yc.has(t)?"(item().isVoronoi ? datum.datum : datum)":"datum",a=i.map(function(t){var n=e.fieldDef(t.channel);return n&&n.bin?"["+Se(e.vgField(t.channel,{}),o)+", "+Se(e.vgField(t.channel,{binSuffix:"end"}),o)+"]":""+Se(t.field,o)}).join(", ");return[{name:n+al,value:{},on:[{events:t.events,update:"datum && item().mark.marktype !== 'group' ? {unit: "+hl(e)+", fields: "+r+", values: ["+a+"]} : null",force:!0}]}]}var Vc={signals:Gc,modifyExpr:function(e,t){return t.name+al+", "+("global"===t.resolve?"null":"{unit: "+hl(e)+"}")}},Xc={signals:Gc,modifyExpr:function(e,t){return t.name+al+", "+("global"===t.resolve?"true":"{unit: "+hl(e)+"}")}},Kc="_translate_anchor",Qc="_translate_delta",Jc={has:function(e){return"interval"===e.type&&e.translate},signals:function(e,t,n){var r=t.name,i=Pc.has(t),o=r+Kc,a=vl(t),u=a.x,s=a.y,c=ji(t.translate,"scope");return i||(c=c.map(function(e){return e.between[0].markname=r+"_brush",e})),n.push({name:o,value:{},on:[{events:c.map(function(e){return e.between[0]}),update:"{x: x(unit), y: y(unit)"+(null!==u?", extent_x: "+(i?Mc(e,er):"slice("+gl(t,"x","visual")+")"):"")+(null!==s?", extent_y: "+(i?Mc(e,tr):"slice("+gl(t,"y","visual")+")"):"")+"}"}]},{name:r+Qc,value:{},on:[{events:c,update:"{x: "+o+".x - x(unit), y: "+o+".y - y(unit)}"}]}),null!==u&&Zc(e,t,er,"width",n),null!==s&&Zc(e,t,tr,"height",n),n}};function Zc(e,t,n,r,i){var o=t.name,a=Pc.has(t),u=i.filter(function(e){return e.name===gl(t,n,a?"data":"visual")})[0],s=o+Kc,c=o+Qc,l=e.getSizeSignalRef(r).signal,f=e.getScaleComponent(n),d=f.get("type"),p=s+".extent_"+n,h=(a?"log"===d?"panLog":"pow"===d?"panPow":"panLinear":"panLinear")+"("+p+", "+(""+(a&&n===er?"-":"")+c+"."+n+" / "+(a?""+l:"span("+p+")"))+(a&&"pow"===d?", "+(f.get("exponent")||1):"")+")";u.on.push({events:{signal:c},update:a?h:"clampRange("+h+", 0, "+l+")"})}var $c="_zoom_anchor",el="_zoom_delta",tl={has:function(e){return"interval"===e.type&&e.zoom},signals:function(e,t,n){var r=t.name,i=Pc.has(t),o=r+el,a=vl(t),s=a.x,c=a.y,l=u(e.scaleName(er)),f=u(e.scaleName(tr)),d=ji(t.zoom,"scope");return i||(d=d.map(function(e){return e.markname=r+"_brush",e})),n.push({name:r+$c,on:[{events:d,update:i?"{"+[l?"x: invert("+l+", x(unit))":"",f?"y: invert("+f+", y(unit))":""].filter(function(e){return!!e}).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:o,on:[{events:d,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),null!==s&&nl(e,t,"x","width",n),null!==c&&nl(e,t,"y","height",n),n}};function nl(e,t,n,r,i){var o=t.name,a=Pc.has(t),u=i.filter(function(e){return e.name===gl(t,n,a?"data":"visual")})[0],s=e.getSizeSignalRef(r).signal,c=e.getScaleComponent(n),l=c.get("type"),f=a?Mc(e,n):u.name,d=o+el,p=(a?"log"===l?"zoomLog":"pow"===l?"zoomPow":"zoomLinear":"zoomLinear")+"("+f+", "+(""+o+$c+"."+n)+", "+d+(a&&"pow"===l?", "+(c.get("exponent")||1):"")+")";u.on.push({events:{signal:d},update:a?p:"clampRange("+p+", 0, "+s+")"})}var rl={project:Uc,toggle:{has:function(e){return"multi"===e.type&&e.toggle},signals:function(e,t,n){return n.concat({name:t.name+"_toggle",value:!1,on:[{events:t.events,update:t.toggle}]})},modifyExpr:function(e,t,n){var r=t.name+al,i=t.name+"_toggle";return i+" ? null : "+r+", "+("global"===t.resolve?i+" ? null : true, ":i+" ? null : {unit: "+hl(e)+"}, ")+i+" ? "+r+" : null"}},scales:Pc,translate:Jc,zoom:tl,inputs:{has:function(e){return"single"===e.type&&"global"===e.resolve&&e.bind&&"scales"!==e.bind},topLevelSignals:function(e,t,n){for(var r=t.name,i=t.project,o=t.bind,a=Yc.has(t)?"(item().isVoronoi ? datum.datum : datum)":"datum",u=function(e){var i=ve(r+"_"+e.field);n.filter(function(e){return e.name===i}).length||n.unshift({name:i,value:"",on:[{events:t.events,update:"datum && item().mark.marktype !== 'group' ? "+Se(e.field,a)+" : null"}],bind:o[e.field]||o[e.channel]||o})},s=0,c=i;s<c.length;s++){u(c[s])}return n},signals:function(e,t,n){var r=t.name,i=t.project,o=n.filter(function(e){return e.name===r+al})[0],a=r+al+jc,u=i.map(function(e){return ve(r+"_"+e.field)}),s=u.map(function(e){return e+" !== null"}).join(" && ");return u.length&&(o.update=s+" ? {fields: "+a+", values: ["+u.join(", ")+"]} : null"),delete o.value,delete o.on,n}},nearest:Yc};function il(e,t){for(var n in rl)rl[n].has(e)&&t(rl[n])}var ol="_store",al="_tuple",ul="_modify",sl="_selection_domain_",cl="vlSelectionResolve";function ll(e,t){return dl(e,function(n,r){t=r.marks?r.marks(e,n,t):t,il(n,function(r){r.marks&&(t=r.marks(e,n,t))})}),t}function fl(e,t,n){var r=[];var i=ye(t,function(t){var i=ve(t),o=e.getSelectionComponent(i,t),a=u(i+ol);if(o.timeUnit){var s=n||e.component.data.raw,c=o.timeUnit.clone();s.parent?c.insertAsParentOf(s):s.parent=c}return"none"!==o.empty&&r.push(a),"vlSelectionTest("+a+", datum"+("global"===o.resolve?")":", "+u(o.resolve)+")")});return(r.length?"!("+r.map(function(e){return"length(data("+e+"))"}).join(" || ")+") || ":"")+"("+i+")"}function dl(e,t){var n=e.component.selection;for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];t(i,pl(i.type))}}function pl(e){switch(e){case"single":return Xc;case"multi":return Vc;case"interval":return Hc}return null}function hl(e){var t=u(e.name),n=function(e){for(var t=e.parent;t&&!Dc(t);)t=t.parent;return t}(e);return n&&(t+=(n.facet.row?" + '_' + ("+Se(n.vgField("row"),"facet")+")":"")+(n.facet.column?" + '_' + ("+Se(n.vgField("column"),"facet")+")":"")),t}function ml(e){var t=!1;return dl(e,function(e){t=t||e.project.some(function(e){return e.field===eo})}),t}function gl(e,t,n){var r=e._signalNames||(e._signalNames={});if(r[t]&&r[t][n])return r[t][n];r[t]=r[t]||{};for(var i=ve(e.name+"_"+("visual"===n?t:e.fields[t])),o=i,a=1;r[o];)o=i+"_"+a++;return r[o]=r[t][n]=o}function vl(e){var t=null,n=null,r=null,i=null;return e.project.forEach(function(e,o){e.channel===er?(t=e,n=o):e.channel===tr&&(r=e,i=o)}),{x:t,xi:n,y:r,yi:i}}function yl(e){return e&&!!e.field&&void 0!==e.equal}function bl(e){return e&&!!e.field&&void 0!==e.lt}function xl(e){return e&&!!e.field&&void 0!==e.lte}function Sl(e){return e&&!!e.field&&void 0!==e.gt}function El(e){return e&&!!e.field&&void 0!==e.gte}function wl(e){return!!(e&&e.field&&i(e.range)&&2===e.range.length)}function kl(e){return e&&!!e.field&&(i(e.oneOf)||i(e.in))}function Cl(e){return kl(e)||yl(e)||wl(e)||bl(e)||Sl(e)||xl(e)||El(e)}function Ol(e,t,n){return ye(t,function(t){return a(t)?t:function(e){return e&&e.selection}(t)?fl(e,t.selection,n):Al(t)})}function Nl(e,t){return En(e,{timeUnit:t,time:!0})}function Al(e,t){void 0===t&&(t=!0);var n=e.field,r=e.timeUnit,i=r?"time("+Ct(r,n)+")":Zt(e,{expr:"datum"});if(yl(e))return i+"==="+Nl(e.equal,r);if(bl(e))return i+"<"+Nl(a=e.lt,r);if(Sl(e))return i+">"+Nl(o=e.gt,r);if(xl(e))return i+"<="+Nl(a=e.lte,r);if(El(e))return i+">="+Nl(o=e.gte,r);if(kl(e))return"indexof(["+function(e,t){return e.map(function(e){return Nl(e,t)})}(e.oneOf,r).join(",")+"], "+i+") !== -1";if(function(e){return e&&!!e.field&&void 0!==e.valid}(e))return e.valid?i+"!==null&&!isNaN("+i+")":i+"===null||isNaN("+i+")";if(wl(e)){var o=e.range[0],a=e.range[1];if(null!==o&&null!==a&&t)return"inrange("+i+", ["+Nl(o,r)+", "+Nl(a,r)+"])";var u=[];return null!==o&&u.push(i+" >= "+Nl(o,r)),null!==a&&u.push(i+" <= "+Nl(a,r)),u.length>0?u.join(" && "):"true"}throw new Error("Invalid field predicate: "+JSON.stringify(e))}function Tl(e){return Cl(e)&&e.timeUnit?S({},e,{timeUnit:At(e.timeUnit)}):e}function _l(e,t){var n=t[e+"Offset"];if(n)return n}function Dl(e,t,n,r){return Rl(e,t,{binSuffix:"start"===n?void 0:"end"},r?{offset:r}:{})}function Rl(e,t,n,r){var i=S({},t?{scale:t}:{},{field:Zt(e,n)});return r?S({},i,r):i}function zl(e,t){return void 0===t&&(t=!0),{scale:e,band:t}}function Il(e,t,n){return{signal:'scale("'+e+'", ('+Zt(t,{expr:"datum"})+" + "+(void 0!==n?Zt(n,{expr:"datum"}):Zt(t,{binSuffix:"end",expr:"datum"}))+") / 2)"}}function Fl(e,t,n,r,i,o,a){if(t){if(Yt(t)){if($r(t.bin))return ee([er,tr],e)&&t.type===Rt?o&&o.impute?Rl(t,r,{binSuffix:"mid"}):Il(r,t):Rl(t,r,hf(t,e)?{binSuffix:"range"}:{});if(ei(t.bin)){if(Yt(n))return Il(r,t,n);var u=e===er?nr:rr;Ze(Ge.channelRequiredForBinned(u))}if(i){var s=i.get("type");if(bi(s))return"band"===s?Rl(t,r,{binSuffix:"range"},{band:.5}):Rl(t,r,{binSuffix:"range"})}return Rl(t,r,{})}if(Vt(t)){var c=t.value;return ee(["x","x2"],e)&&"width"===c?{field:{group:"width"}}:ee(["y","y2"],e)&&"height"===c?{field:{group:"height"}}:{value:c}}}return"function"==typeof a?a():a}function Ll(e,t){for(var n=[],r={},i=0,o=e;i<o.length;i++){var a=o[i],s=cn(a,t,{allowDisabling:!1}),c=jl(a,t).signal;r[s]||n.push(u(s)+": "+c),r[s]=!0}return n.length?{signal:"{"+n.join(", ")+"}"}:void 0}function jl(e,t){if(e){if(Vt(e))return{value:e.value};if(Yt(e))return rf(e,dn(e),"datum",t)}}function Ul(e){return S({},e,{mult:.5})}function Pl(e,t,n,r,o){return function(){if(a(e)){if(n){var u=r.get("type");if(ee([ri.LOG,ri.TIME,ri.UTC],u))"bar"!==o&&"area"!==o||Ze(Ge.nonZeroScaleUsedWithLengthMark(o,t,{scaleType:u}));else{if(function(e){if(!1!==e.get("zero"))return!0;var t=e.domains;return!!i(t)&&ne(t,function(e){return i(e)&&2===e.length&&e[0]<=0&&e[1]>=0})}(r))return{scale:n,value:0};"bar"!==o&&"area"!==o||Ze(Ge.nonZeroScaleUsedWithLengthMark(o,t,{zeroFalse:!1===r.explicit.zero}))}}return"zeroOrMin"===e?"x"===t?{value:0}:{field:{group:"height"}}:"x"===t?{field:{group:"width"}}:{value:0}}return e}}function Ml(e){return"transparent"!==e&&null!=e}function ql(e){var t,n,r=e.markDef,i=e.encoding,o=e.config,a=r.filled,u=r.type,s={fill:tf("fill",r,o),stroke:tf("stroke",r,o),color:tf("color",r,o)},c=ee(["bar","point","circle","square","geoshape"],u)?"transparent":void 0,l=Oe(r.fill,s.fill,c),f=Oe(r.stroke,s.stroke),d=a?"fill":"stroke",p=S({},l?{fill:{value:l}}:{},f?{stroke:{value:f}}:{});return i.fill||i.stroke?(r.color&&Ze(Ge.droppingColor("property",{fill:"fill"in i,stroke:"stroke"in i})),S({},Gl("fill",e,{defaultValue:Oe(l,c)}),Gl("stroke",e,{defaultValue:f}))):i.color?S({},p,Gl("color",e,{vgChannel:d,defaultValue:Oe(r[d],r.color,s[d],s.color,a?c:void 0)})):Ml(r.fill)||Ml(r.stroke)?(r.color&&Ze(Ge.droppingColor("property",{fill:"fill"in r,stroke:"stroke"in r})),p):r.color?S({},p,((t={})[d]={value:r.color},t)):Ml(s.fill)||Ml(s.stroke)?p:s.color?S({},c?{fill:{value:"transparent"}}:{},((n={})[d]={value:s.color},n)):{}}function Hl(e,t){var n=ql(e),r=n.fill,u=n.stroke;return S({},function(e,t){return Vo.reduce(function(n,r){return void 0!==e[r]&&"ignore"!==t[r]&&(n[r]={value:e[r]}),n},{})}(e.markDef,t),Wl(e,"fill",r),Wl(e,"stroke",u),Gl("opacity",e),Gl("fillOpacity",e),Gl("strokeOpacity",e),Gl("strokeWidth",e),function(e){var t=e.encoding,n=e.markDef,r=e.config,u=t.tooltip;return i(u)?{tooltip:Ll(u,r)}:Vl(e,u,"tooltip",function(i){var u=jl(i,e.config);if(u)return u;var s=Oe(n.tooltip,tf("tooltip",n,r));return a(s)?{value:s}:o(s)?"encoding"===s.content?Ll(Sf(t),r):{signal:"datum"}:void 0})}(e),Xl(e,"href"))}function Wl(e,t,n){var r,o,a,u=e.config,s=e.mark;if(u.invalidValues&&n&&!Pn(s)){var c=Bl(e,{invalid:!0,channels:Gr});if(c)return(r={})[t]=[{test:c,value:null}].concat(null!=(a=n)?i(a)?a:[a]:[]),r}return n?((o={})[t]=n,o):{}}function Bl(e,t){var n=t.invalid,r=void 0!==n&&n,i=t.channels.reduce(function(t,n){var r=e.getScaleComponent(n);if(r){var i=r.get("type"),o=e.vgField(n,{expr:"datum"});o&&Si(i)&&(t[o]=!0)}return t},{}),o=de(i);if(o.length>0){var a=r?"||":"&&";return o.map(function(e){return e+" "+(r?"===":"!==")+" null "+a+" "+(r?"":"!")+"isNaN("+e+")"}).join(" "+a+" ")}}function Yl(e){if("filter"===e.config.invalidValues){var t=Bl(e,{channels:["x","y"]});if(t)return{defined:{signal:t}}}return{}}function Gl(e,t,n){void 0===n&&(n={});var r=t.markDef,i=t.encoding,o=n.vgChannel,a=void 0===o?e:o,u=n.defaultValue,s=void 0===u?r[a]:u,c=n.defaultRef||(void 0!==s?{value:s}:void 0),l=i[e];return Vl(t,l,a,function(n){return Fl(e,n,void 0,t.scaleName(e),t.getScaleComponent(e),null,c)})}function Vl(e,t,n,r){var o,a,u=t&&t.condition,s=r(t);if(u){var c=(i(u)?u:[u]).map(function(t){var n=r(t),i=Pt(t)?fl(e,t.selection):Ol(e,t.test);return S({test:i},n)});return(o={})[n]=c.concat(void 0!==s?[s]:[]),o}return void 0!==s?((a={})[n]=s,a):{}}function Xl(e,t){void 0===t&&(t="text");var n=e.encoding[t];return Vl(e,n,t,function(t){return jl(t,e.config)})}function Kl(e,t,n){var r,i,o,a=n.scaleName(t),u="x"===t?"width":"height";if(n.encoding.size||void 0!==n.markDef.size)if(n.markDef.orient){var s=((r={})[t+"c"]=Rl(e,a,{},{band:.5}),r);if(hn(n.encoding.size))return S({},s,Gl("size",n,{vgChannel:u}));if(Vt(n.encoding.size))return S({},s,Gl("size",n,{vgChannel:u}));if(void 0!==n.markDef.size)return S({},s,((i={})[u]={value:n.markDef.size},i))}else Ze(Ge.cannotApplySizeToNonOrientedMark(n.markDef.type));return(o={})[t]=Rl(e,a,{binSuffix:"range"}),o[u]=zl(a),o}function Ql(e,t,n,r){var i="x"===e?"width":"height";return S({},Zl(e,t,n,"x"===e?"xc":"yc"),Gl("size",t,{defaultRef:r,vgChannel:i}))}function Jl(e,t,n,r,i,o){var a,u,s={x:o?i:0,x2:o?0:i,y:o?0:i,y2:o?i:0},c=n===er?nr:rr;return $r(e.bin)?((a={})[c]=Dl(e,r,"start",s[n+"2"]),a[n]=Dl(e,r,"end",s[n]),a):ei(e.bin)&&Yt(t)?((u={})[c]=Rl(e,r,{},{offset:s[n+"2"]}),u[n]=Rl(t,r,{},{offset:s[n]}),u):void Ze(Ge.channelRequiredForBinned(c))}function Zl(e,t,n,r){var i,o=t.encoding,a=t.mark,u=t.stack,s=o[e],c=o[e===er?nr:rr],l=t.scaleName(e),f=t.getScaleComponent(e),d=_l(e,t.markDef),p=s||!o.latitude&&!o.longitude?S({},function(e,t,n,r,i,o,a){return Yt(t)&&o&&e===o.fieldChannel?Rl(t,r,{suffix:"end"}):Fl(e,t,n,r,i,o,a)}(e,s,c,l,f,u,Pl(n,e,l,f,a)),d?{offset:d}:{}):{field:t.getName(e)};return(i={})[r||e]=p,i}function $l(e,t,n){var r,i=e.encoding,o=e.mark,a=e.stack,u="x2"===n?"x":"y",s=i[u],c=e.scaleName(u),l=e.getScaleComponent(u),f=_l(n,e.markDef),d=s||!i.latitude&&!i.longitude?S({},function(e,t,n,r,i,o,a){return Yt(t)&&o&&e.charAt(0)===o.fieldChannel.charAt(0)?Rl(t,r,{suffix:"start"}):Fl(e,n,void 0,r,i,o,a)}(n,s,i[n],c,l,a,Pl(t,u,c,l,o)),f?{offset:f}:{}):{field:e.getName(n)};return(r={})[n]=d,r}function ef(e){return[].concat(e.type,e.style||[])}function tf(e,t,n,r){var i=(void 0===r?{}:r).skipGeneralMarkConfig,o=void 0!==i&&i;return Oe(nf(e,t,n.style),n[t.type][e],o?void 0:n.mark[e])}function nf(e,t,n){for(var r,i=0,o=ef(t);i<o.length;i++){var a=n[o[i]],u=e;a&&void 0!==a[u]&&(r=a[u])}return r}function rf(e,t,n,r){var i=of(e,t,r);if($r(e.bin))return{signal:sf(Zt(e,{expr:n}),Zt(e,{expr:n,binSuffix:"end"}),i,r)};if("quantitative"===e.type)return{signal:""+af(Zt(e,{expr:n,binSuffix:"range"}),i)};if(Sn(e)){var o=Xt(e)&&e.scale&&e.scale.type===ri.UTC;return{signal:cf(Zt(e,{expr:n}),e.timeUnit,t,r.text.shortTimeLabels,r.timeFormat,o,!0)}}return{signal:"''+"+Zt(e,{expr:n})}}function of(e,t,n){if(!Sn(e))return t||(e.type===Rt?n.numberFormat:void 0)}function af(e,t){return"format("+e+', "'+(t||"")+'")'}function uf(e,t,n){return af(e,t||n.numberFormat)}function sf(e,t,n,r){return e+" === null || isNaN("+e+') ? "null" : '+uf(e,n,r)+' + " - " + '+uf(t,n,r)}function cf(e,t,n,r,i,o,a){return void 0===a&&(a=!1),!t||n?(n=n||i)||a?(o?"utc":"time")+"Format("+e+", '"+n+"')":void 0:Nt(t,e,r,o)}function lf(e,t){return(i(e)?e:[e]).reduce(function(e,n){return e.field.push(Zt(n,t)),e.order.push(n.sort||"ascending"),e},{field:[],order:[]})}function ff(e,t){var n=e.slice();return t.forEach(function(e){for(var t=0,r=n;t<r.length;t++){var i=r[t];if(Z(i)===Z(e))return}n.push(e)}),n}function df(e,t){return e!==t&&t?e?e+", "+t:t:e}function pf(e,t){if(i(e.value)&&i(t.value))return{explicit:e.explicit,value:ff(e.value,t.value)};if(!i(e.value)&&!i(t.value))return{explicit:e.explicit,value:df(e.value,t.value)};throw new Error("It should never reach here")}function hf(e,t){return $r(e.bin)?Vr(t)&&ee(["ordinal","nominal"],e.type):(console.warn("Only use this method with binned field defs"),!1)}function mf(e,t){return de(e).reduce(function(n,r){var i=e[r];return S({},n,Vl(t,i,r,function(e){return{value:e.value}}))},{})}function gf(e,t){var n=e&&e[t];return!!n&&(i(n)?ne(n,function(e){return!!e.field}):Yt(n)||Wt(n))}function vf(e){return ne(Ir,function(t){if(gf(e,t)){var n=e[t];if(i(n))return ne(n,function(e){return!!e.aggregate});var r=hn(n);return r&&!!r.aggregate}return!1})}function yf(e,t){var n=[],r=[],i=[],o=[],a={};return Ef(e,function(u,s){var c=u.field,l=u.aggregate,f=u.timeUnit,d=u.bin,p=E(u,["field","aggregate","timeUnit","bin"]);if(Yt(u)&&(l||f||d)){var h=ln(u),m=h&&h.title,g=Zt(u,{forAs:!0}),v=S({},m?[]:{title:cn(u,t,{allowDisabling:!0})},p,{field:g}),y=s===Bn.X||s===Bn.Y;if(l&&Re(l)){var b={op:l,as:g};c&&(b.field=c),o.push(b)}else if($r(d)){if(r.push({bin:d,field:c,as:g}),n.push(Zt(u,{binSuffix:"end"})),hf(u,s)&&n.push(Zt(u,{binSuffix:"range"})),y){var x={field:g+"_end",type:Tt.QUANTITATIVE};a[s+"2"]=x}v.bin="binned",v.type=Tt.QUANTITATIVE}else if(f){i.push({timeUnit:f,field:c,as:g});var w=Ot(f,t.axis.shortTimeLabels).join(" ");Br(s)?v.legend=S({format:w},v.legend):y?v.axis=S({format:w},v.axis):"text"!==s&&"tooltip"!==s||(v.format=v.format||w)}l||n.push(g),a[s]=v}else Yt(u)?(n.push(c),a[s]=e[s]):a[s]=e[s]}),{bins:r,timeUnits:i,aggregate:o,groupby:n,encoding:a}}function bf(e,t){return de(e).reduce(function(n,r){if(!Lr(r))return Ze(Ge.invalidEncodingChannel(r)),n;if(!Xr(e,r,t))return Ze(Ge.incompatibleChannel(r,t)),n;if("size"===r&&"line"===t){var o=hn(e[r]);if(o&&o.aggregate)return Ze(Ge.LINE_WITH_VARYING_SIZE),n}if("color"===r&&("fill"in e||"stroke"in e))return Ze(Ge.droppingColor("encoding",{fill:"fill"in e,stroke:"stroke"in e})),n;var a=e[r];if("detail"===r||"order"===r&&!i(a)&&!Vt(a)||"tooltip"===r&&i(a))a&&(n[r]=(i(a)?a:[a]).reduce(function(e,t){return Yt(t)?e.push(gn(t,r)):Ze(Ge.emptyFieldDef(t,r)),e},[]));else{if(!Yt(a)&&!Vt(a)&&!Ht(a))return Ze(Ge.emptyFieldDef(a,r)),n;n[r]=mn(a,r)}return n},{})}function xf(e){return e&&(!!e.x&&!!e.x2||!!e.y&&!!e.y2)}function Sf(e){var t=[];return Ir.forEach(function(n){if(gf(e,n)){var r=e[n];(i(r)?r:[r]).forEach(function(e){Yt(e)?t.push(e):Wt(e)&&t.push(e.condition)})}}),t}function Ef(e,t,n){if(e)for(var r=function(r){i(e[r])?e[r].forEach(function(e){t.call(n,e,r)}):t.call(n,e[r],r)},o=0,a=de(e);o<a.length;o++){r(a[o])}}function wf(e,t,n,r){return e?de(e).reduce(function(n,o){var a=e[o];return i(a)?a.reduce(function(e,n){return t.call(r,e,n,o)},n):t.call(r,n,a,o)},n):n}var kf=Object.freeze({channelHasField:gf,isAggregate:vf,extractTransformsFromEncoding:yf,normalizeEncoding:bf,isRanged:xf,fieldDefs:Sf,forEach:Ef,reduce:wf});function Cf(e,t,n,r,i){var o=n.scale,u=n.axis;return function(s,c,l,f,d){var p,h;void 0===f&&(f=void 0),void 0===d&&(d={});var m=u&&void 0!==u.title?void 0:void 0!==n.title?n.title:n.field;return Of(e,s,i,{mark:c,encoding:S((p={},p[t]=S({field:l+"_"+n.field,type:n.type},m?{title:m}:{},o?{scale:o}:{},u?{axis:u}:{}),p),a(f)?(h={},h[t+"2"]={field:f+"_"+n.field,type:n.type},h):{},r,d)})}}function Of(e,t,n,r){var i=e.clip,o=e.color,a=e.opacity,u=e.type;return e[t]||void 0===e[t]&&n[t]?[S({},r,{mark:S({},n[t],i?{clip:i}:{},o?{color:o}:{},a?{opacity:a}:{},qn(r.mark)?r.mark:{type:r.mark},{style:u+"-"+t},g(e[t])?{}:e[t])})]:[]}function Nf(e,t,n){var r,i,o,a,u,s=e.encoding;return r=s[u="vertical"===t?"y":"x"],i=s[u+"2"],o=s[u+"Error"],a=s[u+"Error2"],{continuousAxisChannelDef:Af(r,n),continuousAxisChannelDef2:Af(i,n),continuousAxisChannelDefError:Af(o,n),continuousAxisChannelDefError2:Af(a,n),continuousAxis:u}}function Af(e,t){if(Yt(e)&&e&&e.aggregate){var n=e.aggregate,r=E(e,["aggregate"]);return n!==t&&Ze(Ge.errorBarContinuousAxisHasCustomizedAggregate(n,t)),r}return e}function Tf(e,t){var n=e.mark,r=e.encoding;if(Yt(r.x)&&en(r.x)){if(Yt(r.y)&&en(r.y)){if(void 0===r.x.aggregate&&r.y.aggregate===t)return"vertical";if(void 0===r.y.aggregate&&r.x.aggregate===t)return"horizontal";if(r.x.aggregate===t&&r.y.aggregate===t)throw new Error("Both x and y cannot have aggregate");return qn(n)&&n.orient?n.orient:"vertical"}return"horizontal"}if(Yt(r.y)&&en(r.y))return"vertical";throw new Error("Need a valid continuous axis for "+t+"s")}function _f(e,t,n){return S({},e,{encoding:wf(e.encoding,function(e,r,i){return t.indexOf(i)>-1?e[i]=r:Ze(Ge.incompatibleChannel(i,n)),e},{})})}var Df="boxplot",Rf=de({box:1,median:1,outliers:1,rule:1,ticks:1}),zf=["x","y","color","detail","opacity","size"];function If(e){return[{op:"q1",field:e,as:"lower_box_"+e},{op:"q3",field:e,as:"upper_box_"+e}]}var Ff="errorbar",Lf=de({ticks:1,rule:1});function jf(e,t){var n=e.encoding;if(function(e){return(Yt(e.x)||Yt(e.y))&&!Yt(e.x2)&&!Yt(e.y2)&&!Yt(e.xError)&&!Yt(e.xError2)&&!Yt(e.yError)&&!Yt(e.yError2)}(n))return{orient:Tf(e,t),inputType:"raw"};var r=function(e){return Yt(e.x2)||Yt(e.y2)}(n),i=function(e){return Yt(e.xError)||Yt(e.xError2)||Yt(e.yError)||Yt(e.yError2)}(n),o=n.x,a=n.y;if(r){if(i)throw new Error(t+" cannot be both type aggregated-upper-lower and aggregated-error");var u=n.x2,s=n.y2;if(Yt(u)&&Yt(s))throw new Error(t+" cannot have both x2 and y2");if(Yt(u)){if(en(u)&&Yt(o)&&en(o))return{orient:"horizontal",inputType:"aggregated-upper-lower"};throw new Error("Both x and x2 have to be quantitative in "+t)}if(en(s)&&Yt(a)&&en(a))return{orient:"vertical",inputType:"aggregated-upper-lower"};throw new Error("Both y and y2 have to be quantitative in "+t)}var c=n.xError,l=n.xError2,f=n.yError,d=n.yError2;if(Yt(l)&&!Yt(c))throw new Error(t+" cannot have xError2 without xError");if(Yt(d)&&!Yt(f))throw new Error(t+" cannot have yError2 without yError");if(Yt(c)&&Yt(f))throw new Error(t+" cannot have both xError and yError with both are quantiative");if(Yt(c)){if(en(c)&&Yt(o)&&en(o)&&(!Yt(l)||en(l)))return{orient:"horizontal",inputType:"aggregated-error"};throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}if(en(f)&&Yt(a)&&en(a)&&(!Yt(d)||en(d)))return{orient:"vertical",inputType:"aggregated-error"};throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}var Uf=["x","y","x2","y2","xError","yError","xError2","yError2","color","detail","opacity"];function Pf(e,t,n){var r=(e=_f(e,Uf,t)).mark,i=e.encoding,o=e.selection,a=(e.projection,E(e,["mark","encoding","selection","projection"])),u=qn(r)?r:{type:r};o&&Ze(Ge.selectionNotSupported(t));var s=jf(e,t),c=s.orient,l=s.inputType,f=Nf(e,c,t),d=f.continuousAxisChannelDef,p=f.continuousAxisChannelDef2,h=f.continuousAxisChannelDefError,m=f.continuousAxisChannelDefError2,g=f.continuousAxis,v=function(e,t,n,r,i,o,a,u){var s=[],c=[],l=t.field;if("raw"===o){var f=e.center?e.center:e.extent?"iqr"===e.extent?"median":"mean":u.errorbar.center,d=e.extent?e.extent:"mean"===f?"stderr":"iqr";"median"===f!=("iqr"===d)&&Ze(Ge.errorBarCenterIsUsedWithWrongExtent(f,d,a)),"stderr"===d||"stdev"===d?(s=[{op:d,field:l,as:"extent_"+l},{op:f,field:l,as:"center_"+l}],c=[{calculate:"datum.center_"+l+" + datum.extent_"+l,as:"upper_"+l},{calculate:"datum.center_"+l+" - datum.extent_"+l,as:"lower_"+l}]):(e.center&&e.extent&&Ze(Ge.errorBarCenterIsNotNeeded(e.extent,a)),s=[{op:"ci"===d?"ci0":"q1",field:l,as:"lower_"+l},{op:"ci"===d?"ci1":"q3",field:l,as:"upper_"+l}])}else(e.center||e.extent)&&Ze(Ge.errorBarCenterAndExtentAreNotNeeded(e.center,e.extent)),"aggregated-upper-lower"===o?c=[{calculate:"datum."+l,as:"lower_"+l},{calculate:"datum."+n.field,as:"upper_"+l}]:"aggregated-error"===o&&(c=[{calculate:"datum."+l+" + datum."+r.field,as:"upper_"+l}],i?c.push({calculate:"datum."+l+" + datum."+i.field,as:"lower_"+l}):c.push({calculate:"datum."+l+" - datum."+r.field,as:"lower_"+l}));return{postAggregateCalculates:c,errorBarSpecificAggregate:s}}(u,d,p,h,m,l,t,n),y=v.errorBarSpecificAggregate,b=v.postAggregateCalculates,x=g,S=(i[x],g+"2"),w=(i[S],g+"Error"),k=(i[w],g+"Error2"),C=(i[k],yf(E(i,["symbol"==typeof x?x:x+"","symbol"==typeof S?S:S+"","symbol"==typeof w?w:w+"","symbol"==typeof k?k:k+""]),n)),O=C.bins,N=C.timeUnits,A=C.aggregate,T=C.groupby,_=C.encoding,D=A.concat(y),R="raw"!==l?[]:T;return{transform:(a.transform||[]).concat(O,N,D.length?[{aggregate:D,groupby:R}]:[],b),groupby:R,continuousAxisChannelDef:d,continuousAxis:g,encodingWithoutContinuousAxis:_,ticksOrient:"vertical"===c?"horizontal":"vertical",markDef:u,outerSpec:a}}var Mf="errorband",qf=de({band:1,borders:1});var Hf={};function Wf(e,t,n){Hf[e]={normalizer:t,parts:n}}function Bf(){return de(Hf)}function Yf(e,t){var n=qn(e.mark)?e.mark.type:e.mark;if(n in Hf)return(0,Hf[n].normalizer)(e,t);throw new Error('Invalid mark type "'+n+'"')}Wf(Df,function(e,t){var n,r=(e=_f(e,zf,Df)).mark,i=(e.encoding,e.selection),a=(e.projection,E(e,["mark","encoding","selection","projection"])),u=qn(r)?r:{type:r};i&&Ze(Ge.selectionNotSupported("boxplot"));var s=u.extent||t.boxplot.extent,c=Oe(u.size,t.boxplot.size),l=!v(s),f=function(e,t,n){var r=Tf(e,Df),i=Nf(e,r,Df),o=i.continuousAxisChannelDef,a=i.continuousAxis,u=o.field,s=!v(t),c=If(u).concat([{op:"median",field:u,as:"mid_box_"+u},{op:"min",field:u,as:(s?"lower_whisker_":"min_")+u},{op:"max",field:u,as:(s?"upper_whisker_":"max_")+u}]),l=s?[]:[{calculate:"datum.upper_box_"+u+" - datum.lower_box_"+u,as:"iqr_"+u},{calculate:"min(datum.upper_box_"+u+" + datum.iqr_"+u+" * "+t+", datum.max_"+u+")",as:"upper_whisker_"+u},{calculate:"max(datum.lower_box_"+u+" - datum.iqr_"+u+" * "+t+", datum.min_"+u+")",as:"lower_whisker_"+u}],f=e.encoding,d=a,p=(f[d],yf(E(f,["symbol"==typeof d?d:d+""]),n)),h=p.bins,m=p.timeUnits,g=p.aggregate,y=p.groupby,b=p.encoding,x="vertical"===r?"horizontal":"vertical";return{transform:h.concat(m,[{aggregate:g.concat(c),groupby:y}],l),groupby:y,continuousAxisChannelDef:o,continuousAxis:a,encodingWithoutContinuousAxis:b,tickOrient:x}}(e,s,t),d=f.transform,p=f.continuousAxisChannelDef,h=f.continuousAxis,m=f.groupby,g=f.encodingWithoutContinuousAxis,y=f.tickOrient,b=(g.color,g.size),x=E(g,["color","size"]),w=function(e){return Cf(u,h,p,e,t.boxplot)},k=w(x),C=w(g),O=w(S({},x,b?{size:b}:{})),N={type:"tick",color:"black",opacity:1,orient:y},A=S({type:"bar"},c?{size:c}:{}),T=S({type:"tick"},o(t.boxplot.median)&&t.boxplot.median.color?{color:t.boxplot.median.color}:{},c?{size:c}:{},{orient:y}),_=k("rule","rule","lower_whisker","lower_box").concat(k("rule","rule","upper_box","upper_whisker"),k("ticks",N,"lower_whisker"),k("ticks",N,"upper_whisker"),C("box",A,"lower_box","upper_box"),O("median",T,"mid_box")),D=[];if(!l){var R="datum.lower_box_"+p.field,z="datum.upper_box_"+p.field,I="("+z+" - "+R+")",F=R+" - "+s+" * "+I,L=z+" + "+s+" * "+I,j="datum."+p.field;D=Of(u,"outliers",t.boxplot,{transform:[{window:If(p.field),frame:[null,null],groupby:m},{filter:"("+j+" < "+F+") || ("+j+" > "+L+")"}],mark:"point",encoding:S((n={},n[h]={field:p.field,type:p.type},n),x)})}return D.length>0?S({},a,{layer:[{transform:d,layer:_}].concat(D)}):S({},a,{transform:(a.transform||[]).concat(d),layer:_})},Rf),Wf(Ff,function(e,t){var n=Pf(e,Ff,t),r=n.transform,i=n.continuousAxisChannelDef,o=n.continuousAxis,a=n.encodingWithoutContinuousAxis,u=n.ticksOrient,s=n.markDef,c=n.outerSpec,l=Cf(s,o,i,a,t.errorbar),f={type:"tick",orient:u};return S({},c,{transform:r,layer:l("ticks",f,"lower").concat(l("ticks",f,"upper"),l("rule","rule","lower","upper"))})},Lf),Wf(Mf,function(e,t){var n=Pf(e,Mf,t),r=n.transform,i=n.continuousAxisChannelDef,o=n.continuousAxis,a=n.encodingWithoutContinuousAxis,u=n.markDef,s=n.outerSpec,c=Cf(u,o,i,a,t.errorband),l=void 0!==e.encoding.x&&void 0!==e.encoding.y,f={type:l?"area":"rect"},d={type:l?"line":"rule"},p=S({},u.interpolate?{interpolate:u.interpolate}:{},u.tension&&u.interpolate?{interpolate:u.tension}:{});return l?(f=S({},f,p),d=S({},d,p)):u.interpolate?Ze(Ge.errorBand1DNotSupport("interpolate")):u.tension&&Ze(Ge.errorBand1DNotSupport("tension")),S({},s,{transform:r,layer:c("band",f,"lower","upper").concat(c("borders",d,"lower"),c("borders",d,"upper"))})},qf);var Gf=Object.freeze({add:Wf,remove:function(e){delete Hf[e]},getAllCompositeMarks:Bf,getCompositeMarkParts:function(e){if(e in Hf)return Hf[e].parts;throw new Error("Unregistered composite mark "+e)},normalize:Yf});function Vf(e,t,n){var r;r=function(e){return"as"in e}(e)?a(e.as)?[e.as,e.as+"_end"]:[e.as[0],e.as[1]]:[Zt(e,{forAs:!0}),Zt(e,{binSuffix:"end",forAs:!0})];var i=vn(t,void 0)||{},o=function(e,t){return Zr(e)+"_"+t}(i,e.field),u=function(e,t){return{signal:e.getName(t+"_bins"),extentSignal:e.getName(t+"_extent")}}(n,o),s=u.signal,c=u.extentSignal;return{key:o,binComponent:S({bin:i,field:e.field,as:r},s?{signal:s}:{},c?{extentSignal:c}:{})}}var Xf=function(e){function t(t,n){var r=e.call(this,t)||this;return r.bins=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.bins))},t.makeFromEncoding=function(e,n){var r=n.reduceFieldDef(function(e,t,r){if($r(t.bin)){var i=Vf(t,t.bin,n),o=i.key,a=i.binComponent;e[o]=S({},a,e[o],function(e,t,n,r){if(hf(t,n)){var i=_c(e)&&(e.axis(n)||e.legend(n))||{},o=Zt(t,{expr:"datum"}),a=Zt(t,{expr:"datum",binSuffix:"end"});return{formulaAs:Zt(t,{binSuffix:"range",forAs:!0}),formula:sf(o,a,i.format,r)}}return{}}(n,t,r,n.config))}return e},{});return 0===de(r).length?null:new t(e,r)},t.makeFromTransform=function(e,n,r){var i,o=Vf(n,n.bin,r),a=o.key,u=o.binComponent;return new t(e,((i={})[a]=u,i))},t.prototype.merge=function(e){this.bins=S({},this.bins,e.bins),e.remove()},t.prototype.producedFields=function(){var e={};return pe(this.bins).forEach(function(t){t.as.forEach(function(t){return e[t]=!0})}),e},t.prototype.dependentFields=function(){var e={};return pe(this.bins).forEach(function(t){e[t.field]=!0}),e},t.prototype.hash=function(){return"Bin "+$(this.bins)},t.prototype.assemble=function(){return ie(pe(this.bins).map(function(e){var t=[],n=S({type:"bin",field:e.field,as:e.as,signal:e.signal},e.bin);return!e.bin.extent&&e.extentSignal&&(t.push({type:"extent",field:e.field,signal:e.extentSignal}),n.extent={signal:e.extentSignal}),t.push(n),e.formula&&t.push({type:"formula",expr:e.formula,as:e.formulaAs}),t}))},t}(sa),Kf=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.model=n,i.filter=r,i.expr=Ol(i.model,i.filter,i),i._dependentFields=Fu(i.expr),i}return x(t,e),t.prototype.clone=function(){return new t(null,this.model,me(this.filter))},t.prototype.dependentFields=function(){return this._dependentFields},t.prototype.assemble=function(){return{type:"filter",expr:this.expr}},t.prototype.hash=function(){return"Filter "+this.expr},t}(sa),Qf=function(e){function t(t,n){var r=e.call(this,t)||this;r.transform=n,r.transform=me(n);var i=r.transform,o=i.flatten,a=i.as,u=void 0===a?[]:a;return r.transform.as=o.map(function(e,t){return u[t]||e}),r}return x(t,e),t.prototype.clone=function(){return new t(this.parent,me(this.transform))},t.prototype.producedFields=function(){var e=this;return this.transform.flatten.reduce(function(t,n,r){return t[e.transform.as[r]]=!0,t},{})},t.prototype.hash=function(){return"FlattenTransform "+$(this.transform)},t.prototype.assemble=function(){var e=this.transform;return{type:"flatten",fields:e.flatten,as:e.as}},t}(sa),Jf=function(e){function t(t,n){var r=e.call(this,t)||this;r.transform=n,r.transform=me(n);var i=r.transform.as||[void 0,void 0];return r.transform.as=[i[0]||"key",i[1]||"value"],r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform))},t.prototype.producedFields=function(){return this.transform.as.reduce(function(e,t){return e[t]=!0,e},{})},t.prototype.hash=function(){return"FoldTransform "+$(this.transform)},t.prototype.assemble=function(){var e=this.transform;return{type:"fold",fields:e.fold,as:e.as}},t}(sa),Zf=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.fields=n,o.geojson=r,o.signal=i,o}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.fields),this.geojson,this.signal)},t.parseAll=function(e,n){var r=0;if([[lr,sr],[fr,cr]].forEach(function(i){var o=i.map(function(e){return n.channelHasField(e)?n.fieldDef(e).field:void 0});(o[0]||o[1])&&(e=new t(e,o,null,n.getName("geojson_"+r++)))}),n.channelHasField(hr)){var i=n.fieldDef(hr);i.type===Lt&&(e=new t(e,null,i.field,n.getName("geojson_"+r++)))}return e},t.prototype.assemble=function(){return S({type:"geojson"},this.fields?{fields:this.fields}:{},this.geojson?{geojson:this.geojson}:{},{signal:this.signal})},t}(sa),$f=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.projection=n,o.fields=r,o.as=i,o}return x(t,e),t.prototype.clone=function(){return new t(null,this.projection,me(this.fields),me(this.as))},t.parseAll=function(e,n){return n.projectionName()?([[lr,sr],[fr,cr]].forEach(function(r){var i=r.map(function(e){return n.channelHasField(e)?n.fieldDef(e).field:void 0}),o=r[0]===fr?"2":"";(i[0]||i[1])&&(e=new t(e,n.projectionName(),i,[n.getName("x"+o),n.getName("y"+o)]))}),e):e},t.prototype.assemble=function(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}},t}(sa),ed=function(e){function t(t){return e.call(this,t)||this}return x(t,e),t.prototype.clone=function(){return new t(null)},t.prototype.producedFields=function(){var e;return(e={})[eo]=!0,e},t.prototype.assemble=function(){return{type:"identifier",as:eo}},t}(sa);function td(e,t,n,r){if(void 0!==e.size)return{value:e.size};var i=tf("size",e,r,{skipGeneralMarkConfig:!0});if(void 0!==i)return{value:i};if(n){var o=n.get("type");if("point"!==o&&"band"!==o)return{value:r.bar.continuousBandSize};if(void 0!==r.bar.discreteBandSize)return{value:r.bar.discreteBandSize};if(o!==ri.POINT)return zl(t);var a=n.get("range");if(Yo(a)&&v(a.step))return{value:a.step-1};Ze(Ge.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL)}return{value:Oe(r.bar.discreteBandSize,r.scale.rangeStep?r.scale.rangeStep-1:void 0,20)}}function nd(e,t){var n=e.config,r=e.markDef,i=e.width,o=e.height;return S({},Hl(e,{size:"include",orient:"ignore"}),Zl("x",e,Ul(i)),Zl("y",e,Ul(o)),Gl("size",e,{defaultValue:tf("size",r,n)}),function(e,t,n){if(n)return{shape:{value:n}};return Gl("shape",e,{defaultValue:tf("shape",e.markDef,t)})}(e,n,t))}var rd={area:{vgMark:"area",encodeEntry:function(e){return S({},Hl(e,{size:"ignore",orient:"include"}),Zl("x",e,"zeroOrMin"),Zl("y",e,"zeroOrMin"),$l(e,"zeroOrMin","horizontal"===e.markDef.orient?"x2":"y2"),Yl(e))}},bar:{vgMark:"rect",encodeEntry:function(e){return S({},Hl(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.config,n=e.encoding,r=e.markDef,i=e.width,o=r.orient,a=n.size,u=n.x,s=n.x2,c=e.scaleName(er),l=e.getScaleComponent(er);if(Yt(u)&&ei(u.bin))return Jl(u,s,er,c,Oe(r.binSpacing,t.bar.binSpacing),l.get("reverse"));if("horizontal"===o||s)return S({},Zl("x",e,"zeroOrMin"),$l(e,"zeroOrMin","x2"));if(Yt(u)){var f=l.get("type");if($r(u.bin)&&!a&&!bi(f))return Jl(u,void 0,er,e.scaleName("x"),Oe(r.binSpacing,t.bar.binSpacing),l.get("reverse"));if(f===ri.BAND)return Kl(u,"x",e)}return Ql("x",e,S({},Ul(i)),td(r,c,l,t))}(e),function(e){var t=e.config,n=e.encoding,r=e.height,i=e.markDef,o=i.orient,a=n.size,u=n.y,s=n.y2,c=e.scaleName(tr),l=e.getScaleComponent(tr);if(Yt(u)&&ei(u.bin))return Jl(u,s,tr,c,Oe(i.binSpacing,t.bar.binSpacing),l.get("reverse"));if("vertical"===o||s)return S({},Zl("y",e,"zeroOrMin"),$l(e,"zeroOrMin","y2"));if(Yt(u)){var f=l.get("type");if($r(u.bin)&&!a&&!bi(f))return Jl(u,void 0,tr,e.scaleName("y"),Oe(i.binSpacing,t.bar.binSpacing),l.get("reverse"));if(f===ri.BAND)return Kl(u,"y",e)}return Ql("y",e,Ul(r),td(i,c,l,t))}(e))}},circle:{vgMark:"symbol",encodeEntry:function(e){return nd(e,"circle")}},geoshape:{vgMark:"shape",encodeEntry:function(e){return S({},Hl(e,{size:"ignore",orient:"ignore"}))},postEncodingTransform:function(e){var t=e.encoding.shape;return[S({type:"geoshape",projection:e.projectionName()},t&&Yt(t)&&t.type===Lt?{field:Zt(t,{expr:"datum"})}:{})]}},line:{vgMark:"line",encodeEntry:function(e){var t=e.width,n=e.height;return S({},Hl(e,{size:"ignore",orient:"ignore"}),Zl("x",e,Ul(t)),Zl("y",e,Ul(n)),Gl("size",e,{vgChannel:"strokeWidth"}),Yl(e))}},point:{vgMark:"symbol",encodeEntry:function(e){return nd(e)}},rect:{vgMark:"rect",encodeEntry:function(e){return S({},Hl(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.encoding.x,n=e.encoding.x2,r=e.getScaleComponent(er),i=r?r.get("type"):void 0,o=e.scaleName(er);if(Yt(t)&&($r(t.bin)||ei(t.bin)))return Jl(t,n,er,o,0,r.get("reverse"));if(Yt(t)&&r&&bi(i)){if(i===ri.BAND)return Kl(t,"x",e);throw new Error(Ge.scaleTypeNotWorkWithMark(zn,i))}return S({},Zl("x",e,"zeroOrMax"),$l(e,"zeroOrMin","x2"))}(e),function(e){var t=e.encoding.y,n=e.encoding.y2,r=e.getScaleComponent(tr),i=r?r.get("type"):void 0,o=e.scaleName(tr);if(Yt(t)&&($r(t.bin)||ei(t.bin)))return Jl(t,n,tr,o,0,r.get("reverse"));if(Yt(t)&&r&&bi(i)){if(i===ri.BAND)return Kl(t,"y",e);throw new Error(Ge.scaleTypeNotWorkWithMark(zn,i))}return S({},Zl("y",e,"zeroOrMax"),$l(e,"zeroOrMin","y2"))}(e))}},rule:{vgMark:"rule",encodeEntry:function(e){var t=e.markDef,n=e.width,r=e.height,i=t.orient;return e.encoding.x||e.encoding.y||e.encoding.latitude||e.encoding.longitude?S({},Hl(e,{size:"ignore",orient:"ignore"}),Zl("x",e,"horizontal"===i?"zeroOrMin":Ul(n)),Zl("y",e,"vertical"===i?"zeroOrMin":Ul(r)),"vertical"!==i?$l(e,"zeroOrMax","x2"):{},"horizontal"!==i?$l(e,"zeroOrMax","y2"):{},Gl("size",e,{vgChannel:"strokeWidth",defaultValue:t.size})):{}}},square:{vgMark:"symbol",encodeEntry:function(e){return nd(e,"square")}},text:{vgMark:"text",encodeEntry:function(e){var t=e.config,n=(e.encoding,e.width),r=e.height,i=e.markDef,o=Oe(i.fontSize,i.size,nf("fontSize",i,t.style),nf("size",i,t.style),t[i.type].fontSize,t[i.type].size);return S({},Hl(e,{size:"ignore",orient:"ignore"}),Zl("x",e,Ul(n)),Zl("y",e,Ul(r)),Xl(e),Gl("size",e,{defaultValue:o,vgChannel:"fontSize"}),function(e,t){var n;if(void 0!==t)return(n={})[e]={value:t},n}("align",function(e,t,n){if(void 0===(e.align||tf("align",e,n)))return"center";return}(e.markDef,0,t)))}},tick:{vgMark:"rect",encodeEntry:function(e){var t,n=e.config,r=e.markDef,i=e.width,o=e.height,a=r.orient,u="horizontal"===a?"width":"height",s="horizontal"===a?"height":"width";return S({},Hl(e,{size:"ignore",orient:"ignore"}),Zl("x",e,Ul(i),"xc"),Zl("y",e,Ul(o),"yc"),Gl("size",e,{defaultValue:function(e){var t=e.config,n=e.markDef,r=n.orient,i=e.getScaleComponent("horizontal"===r?"x":"y");if(void 0!==n.size)return n.size;if(void 0!==t.tick.bandSize)return t.tick.bandSize;var o=i?i.get("range"):void 0,a=o&&Yo(o)?o.step:t.scale.rangeStep;if("number"!=typeof a)throw new Error("Function does not handle non-numeric rangeStep");return a/1.5}(e),vgChannel:u}),((t={})[s]={value:Oe(r.thickness,n.tick.thickness)},t))}},trail:{vgMark:"trail",encodeEntry:function(e){var t=e.width,n=e.height;return S({},Hl(e,{size:"include",orient:"ignore"}),Zl("x",e,Ul(t)),Zl("y",e,Ul(n)),Gl("size",e),Yl(e))}}};function id(e){return ee([An,On,Rn],e.mark)?function(e){var t=ud(e.mark,e.encoding),n=ad(e,{fromPrefix:t.length>0?od:""});return t.length>0?[{name:e.getName("pathgroup"),type:"group",from:{facet:{name:od+e.requestDataName(ws),data:e.requestDataName(ws),groupby:t}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:n}]:n}(e):ad(e)}var od="faceted_path_";function ad(e,t){void 0===t&&(t={fromPrefix:""});var n=e.mark,r=Oe(e.markDef.clip,function(e){var t=e.getScaleComponent("x"),n=e.getScaleComponent("y");return!!(t&&t.get("domainRaw")||n&&n.get("domainRaw"))}(e)),o=ef(e.markDef),a=e.encoding.key,u=function(e){var t=e.encoding,n=e.stack,r=e.mark,o=e.markDef,a=t.order;if(i(a)||!Vt(a)){if((i(a)||Yt(a))&&!n)return lf(a,{expr:"datum"});if(Pn(r)){var u=t["horizontal"===o.orient?"y":"x"];if(Yt(u)){var s=u.sort;return{field:ea(s)?Zt({aggregate:vf(e.encoding)?s.op:void 0,field:s.field},{expr:"datum"}):Zt(u,{binSuffix:e.stack&&e.stack.impute?"mid":void 0,expr:"datum"}),order:"descending"}}}}}(e),s=rd[n].postEncodingTransform?rd[n].postEncodingTransform(e):null;return[S({name:e.getName("marks"),type:rd[n].vgMark},r?{clip:!0}:{},o?{style:o}:{},a?{key:{field:a.field}}:{},u?{sort:u}:{},{from:{data:t.fromPrefix+e.requestDataName(ws)},encode:{update:rd[n].encodeEntry(e)}},s?{transform:s}:{})]}function ud(e,t){return de(t).reduce(function(n,r){switch(r){case"x":case"y":case"order":case"href":case"x2":case"y2":case"xError":case"yError":case"xError2":case"yError2":case"latitude":case"longitude":case"latitude2":case"longitude2":case"text":case"shape":case"tooltip":return n;case"detail":case"key":var o=t[r];return(i(o)||Yt(o))&&(i(o)?o:[o]).forEach(function(e){e.aggregate||n.push(Zt(e,{}))}),n;case"size":if("trail"===e)return n;case"color":case"fill":case"stroke":case"opacity":case"fillOpacity":case"strokeOpacity":case"strokeWidth":var a=hn(t[r]);return a&&!a.aggregate&&n.push(Zt(a,{})),n;default:throw new Error("Bug: Channel "+r+" unimplemented for line mark")}},[])}var sd=function(e){function t(t,n){var r=e.call(this,t)||this;return r.transform=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform))},t.prototype.producedFields=function(){var e;return(e={})[this.transform.impute]=!0,e},t.prototype.processSequence=function(e){var t=e.start,n=void 0===t?0:t,r=e.stop,i=e.step;return{signal:"sequence("+[n,r].concat(i?[i]:[]).join(",")+")"}},t.makeFromTransform=function(e,n){return new t(e,n)},t.makeFromEncoding=function(e,n){var r=n.encoding,i=r.x,o=r.y;if(Yt(i)&&Yt(o)){var a=i.impute?i:o.impute?o:void 0;if(void 0===a)return;var u=i.impute?o:o.impute?i:void 0,s=a.impute,c=s.method,l=s.value,f=s.frame,d=s.keyvals,p=ud(n.mark,r);return new t(e,S({impute:a.field,key:u.field},c?{method:c}:{},void 0!==l?{value:l}:{},f?{frame:f}:{},void 0!==d?{keyvals:d}:{},p.length?{groupby:p}:{}))}return null},t.prototype.hash=function(){return"Impute "+$(this.transform)},t.prototype.assemble=function(){var e,t=this.transform,n=t.impute,r=t.key,i=t.keyvals,o=t.method,a=t.groupby,u=t.value,s=t.frame,c=void 0===s?[null,null]:s,l=S({type:"impute",field:n,key:r},i?{keyvals:_o(i)?this.processSequence(i):i}:{},{method:"value"},a?{groupby:a}:{},{value:null});o&&"value"!==o?e=[S({type:"window",as:["imputed_"+n+"_value"],ops:[o],fields:[n],frame:c,ignorePeers:!1},a?{groupby:a}:{}),{type:"formula",expr:"datum."+n+" === null ? datum.imputed_"+n+"_value : datum."+n,as:n}]:e=[{type:"formula",expr:"datum."+n+" === null ? "+u+" : datum."+n,as:n}];return[l].concat(e)},t}(sa),cd=function(e){function t(t,n,r){void 0===t&&(t={}),void 0===n&&(n={}),void 0===r&&(r=!1);var i=e.call(this,t,n)||this;return i.explicit=t,i.implicit=n,i.parseNothing=r,i}return x(t,e),t.prototype.clone=function(){var t=e.prototype.clone.call(this);return t.parseNothing=this.parseNothing,t},t}(ts),ld=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.transform=n,i.secondary=r,i}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform),this.secondary)},t.make=function(e,n,r,i){var o=n.component.data.sources,a=kd(r.from.data,o);a||(a=new _s(r.from.data),o.push(a));var u=n.getName("lookup_"+i),s=new ca(a,u,"lookup",n.component.data.outputNodeRefCounts);return n.component.data.outputNodes[u]=s,new t(e,r,s.getSource())},t.prototype.producedFields=function(){return y(this.transform.from.fields||(this.transform.as instanceof Array?this.transform.as:[this.transform.as]))},t.prototype.hash=function(){return"Lookup "+$({transform:this.transform,secondary:this.secondary})},t.prototype.assemble=function(){var e;if(this.transform.from.fields)e=S({values:this.transform.from.fields},this.transform.as?{as:this.transform.as instanceof Array?this.transform.as:[this.transform.as]}:{});else{var t=this.transform.as;a(t)||(Ze(Ge.NO_FIELDS_NEEDS_AS),t="_lookup"),e={as:[t]}}return S({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},e,this.transform.default?{default:this.transform.default}:{})},t}(sa),fd=function(e){function t(t,n){var r=e.call(this,t)||this;return r.transform=n,r}return x(t,e),t.prototype.clone=function(){return new t(null,me(this.transform))},t.prototype.hash=function(){return"SampleTransform "+$(this.transform)},t.prototype.assemble=function(){return{type:"sample",size:this.transform.sample}},t}(sa);function dd(e){var t=0;return function n(r,i){r instanceof _s&&(xs(r.data)||(e.push(i),i={name:null,source:i.name,transform:[]}));if(r instanceof Ls&&(r.parent instanceof _s&&!i.source?(i.format=S({},i.format||{},{parse:r.assembleFormatParse()}),i.transform=i.transform.concat(r.assembleTransforms(!0))):i.transform=i.transform.concat(r.assembleTransforms())),r instanceof Fs)return i.name||(i.name="data_"+t++),!i.source||i.transform.length>0?(e.push(i),r.data=i.name):r.data=i.source,void r.assemble().forEach(function(t){return e.push(t)});(r instanceof Kf||r instanceof Lu||r instanceof $f||r instanceof Zf||r instanceof Is||r instanceof ld||r instanceof Ps||r instanceof Jf||r instanceof Qf||r instanceof ed||r instanceof fd)&&i.transform.push(r.assemble()),(r instanceof Xf||r instanceof Us||r instanceof sd||r instanceof js)&&(i.transform=i.transform.concat(r.assemble())),r instanceof ca&&(i.source&&0===i.transform.length?r.setSource(i.source):r.parent instanceof ca?r.setSource(i.name):(i.name||(i.name="data_"+t++),r.setSource(i.name),1===r.numChildren()&&(e.push(i),i={name:null,source:i.name,transform:[]})));switch(r.numChildren()){case 0:r instanceof ca&&(!i.source||i.transform.length>0)&&e.push(i);break;case 1:n(r.children[0],i);break;default:i.name||(i.name="data_"+t++);var o=i.name;!i.source||i.transform.length>0?e.push(i):o=i.source,r.children.forEach(function(e){n(e,{name:null,source:o,transform:[]})})}}}function pd(e){md(e);var t=e.component.layoutSize;t.setWithExplicit("width",gd(e,"width")),t.setWithExplicit("height",gd(e,"height"))}var hd=pd;function md(e){for(var t=0,n=e.children;t<n.length;t++){n[t].parseLayoutSize()}}function gd(e,t){for(var n,r="width"===t?"x":"y",i=e.component.resolve,o=0,a=e.children;o<a.length;o++){var u=(f=a[o]).component.layoutSize.getWithExplicit(t),s=i.scale[r];if("independent"===s&&"range-step"===u.value){n=void 0;break}if(n){if("independent"===s&&n.value!==u.value){n=void 0;break}n=as(n,u,t,"")}else n=u}if(n){for(var c=0,l=e.children;c<l.length;c++){var f=l[c];e.renameLayoutSize(f.getName(t),e.getName(t)),f.component.layoutSize.set(t,"merged",!1)}return n}return{explicit:!1,value:void 0}}function vd(e,t){var n="width"===t?"x":"y",r=e.config,i=e.getScaleComponent(n);if(i){var o=i.get("type"),a=i.get("range");return bi(o)&&Yo(a)?"range-step":r.view[t]}return e.hasProjection?r.view[t]:"width"===t&&"text"===e.mark?r.scale.textXRangeStep:r.scale.rangeStep||ki.rangeStep}function yd(e,t){return Mt(e.field)?e.field.repeat in t?S({},e,{field:t[e.field.repeat]}):void Ze(Ge.noSuchRepeatedValue(e.field.repeat)):e}function bd(e,t){if(void 0!==(e=yd(e,t))){if(e.sort&&ea(e.sort)){var n=yd(e.sort,t);e=S({},e,n?{sort:n}:{})}return e}}function xd(e,t){if(!Yt(e)){if(Wt(e)){if(n=bd(e.condition,t))return S({},e,{condition:n});e.condition;return E(e,["condition"])}return e}var n;return(n=bd(e,t))?n:Ht(e)?{condition:e.condition}:void 0}function Sd(e,t){var n={};for(var r in e)if(e.hasOwnProperty(r)){var o=e[r];if(i(o))n[r]=o.map(function(e){return xd(e,t)}).filter(function(e){return e});else{var a=xd(o,t);a&&(n[r]=a)}}return n}function Ed(e,t,n){return Zt(t,S({suffix:"by_"+Zt(e)},n||{}))}var wd=function(e){function t(t,n,r,i,o){var a=e.call(this,t,n,r,o,i,t.resolve)||this;a.type="facet",a.child=Md(t.spec,a,a.getName("child"),void 0,i,o,!1),a.children=[a.child];var u=function(e,t){return Sd(e,t)}(t.facet,i);return a.facet=a.initFacet(u),a}return x(t,e),t.prototype.initFacet=function(e){return wf(e,function(e,t,n){return ee([dr,pr],n)?void 0===t.field?(Ze(Ge.emptyFieldDef(t,n)),e):(e[n]=mn(t,n),e):(Ze(Ge.incompatibleChannel(n,"facet")),e)},{})},t.prototype.channelHasField=function(e){return!!this.facet[e]},t.prototype.fieldDef=function(e){return this.facet[e]},t.prototype.parseData=function(){this.component.data=Cd(this),this.child.parseData()},t.prototype.parseLayoutSize=function(){md(this)},t.prototype.parseSelection=function(){this.child.parseSelection(),this.component.selection=this.child.component.selection},t.prototype.parseMarkGroup=function(){this.child.parseMarkGroup()},t.prototype.parseAxisAndHeader=function(){this.child.parseAxisAndHeader(),this.parseHeader("column"),this.parseHeader("row"),this.mergeChildAxis("x"),this.mergeChildAxis("y")},t.prototype.parseHeader=function(e){if(this.channelHasField(e)){var t=this.facet[e],n=cn(t,this.config,{allowDisabling:!0});this.child.component.layoutHeaders[e].title&&(n+=" / "+this.child.component.layoutHeaders[e].title,this.child.component.layoutHeaders[e].title=null),this.component.layoutHeaders[e]={title:n,facetFieldDef:t,header:[this.makeHeaderComponent(e,!0)]}}},t.prototype.makeHeaderComponent=function(e,t){var n="row"===e?"height":"width";return{labels:t,sizeSignal:this.child.component.layoutSize.get(n)?this.child.getSizeSignalRef(n):void 0,axes:[]}},t.prototype.mergeChildAxis=function(e){var t,n=this.child;if(n.component.axes[e]){var r=this.component,i=r.layoutHeaders,o=r.resolve;if(o.axis[e]=es(o,e),"shared"===o.axis[e])for(var a="x"===e?"column":"row",u=i[a],s=0,c=n.component.axes[e];s<c.length;s++){var l=c[s],f="top"===(t=l.get("orient"))||"left"===t?"header":"footer";u[f]=u[f]||[this.makeHeaderComponent(a,!1)];var d=Xo(l,"main",this.config,{header:!0});u[f][0].axes.push(d),l.mainExtracted=!0}}},t.prototype.assembleSelectionTopLevelSignals=function(e){return this.child.assembleSelectionTopLevelSignals(e)},t.prototype.assembleSelectionSignals=function(){return this.child.assembleSelectionSignals(),[]},t.prototype.assembleSelectionData=function(e){return this.child.assembleSelectionData(e)},t.prototype.getHeaderLayoutMixins=function(){var e=this,t={};return["row","column"].forEach(function(n){["header","footer"].forEach(function(r){var i=e.component.layoutHeaders[n],o=i[r];if(o&&o[0]){var a="row"===n?"height":"width",u="header"===r?"headerBand":"footerBand";e.child.component.layoutSize.get(a)||(t[u]=t[u]||{},t[u][n]=.5),i.title&&(t.offset=t.offset||{},t.offset["row"===n?"rowTitle":"columnTitle"]=10)}})}),t},t.prototype.assembleDefaultLayout=function(){var e=this.channelHasField("column")?this.columnDistinctSignal():1;return S({},this.getHeaderLayoutMixins(),{columns:e,bounds:"full",align:"all"})},t.prototype.assembleLayoutSignals=function(){return this.child.assembleLayoutSignals()},t.prototype.columnDistinctSignal=function(){if(!(this.parent&&this.parent instanceof t))return{signal:"length(data('"+this.getName("column_domain")+"'))"}},t.prototype.assembleGroup=function(n){return this.parent&&this.parent instanceof t?S({},this.channelHasField("column")?{encode:{update:{columns:{field:Zt(this.facet.column,{prefix:"distinct"})}}}}:{},e.prototype.assembleGroup.call(this,n)):e.prototype.assembleGroup.call(this,n)},t.prototype.getCardinalityAggregateForChild=function(){var e=[],n=[],r=[];if(this.child instanceof t){if(this.child.channelHasField("column")){var i=Zt(this.child.facet.column);e.push(i),n.push("distinct"),r.push("distinct_"+i)}}else for(var o=0,a=["x","y"];o<a.length;o++){var u=a[o],s=this.child.component.scales[u];if(s&&!s.merged){var c=s.get("type"),l=s.get("range");if(bi(c)&&Yo(l))(i=rc(ic(this.child,u)))?(e.push(i),n.push("distinct"),r.push("distinct_"+i)):Ze("Unknown field for ${channel}.  Cannot calculate view size.")}}return{fields:e,ops:n,as:r}},t.prototype.assembleFacet=function(){var e=this,t=this.component.data.facetRoot,n=t.name,r=t.data,o=this.facet,a=o.row,u=o.column,s=this.getCardinalityAggregateForChild(),c=s.fields,l=s.ops,f=s.as,d=[];["row","column"].forEach(function(t){var n=e.facet[t];if(n){d.push(Zt(n));var r=n.sort;if(ea(r)){var o=r.field,s=r.op,p=Ed(n,r);a&&u?(c.push(p),l.push("max"),f.push(p)):(c.push(o),l.push(s),f.push(p))}else if(i(r)){p=ju(n,t);c.push(p),l.push("max"),f.push(p)}}});var p=!!a&&!!u;return S({name:n,data:r,groupby:d},p||c.length?{aggregate:S({},p?{cross:p}:{},c.length?{fields:c,ops:l,as:f}:{})}:{})},t.prototype.headerSortFields=function(e){var t=this.facet[e];return t?ea(t.sort)?[Ed(t,t.sort,{expr:"datum"})]:i(t.sort)?[ju(t,e,{expr:"datum"})]:[Zt(t,{expr:"datum"})]:[]},t.prototype.headerSortOrder=function(e){var t=this.facet[e];if(t){var n=t.sort;return[(ea(n)?n.order:!i(n)&&n)||"ascending"]}return[]},t.prototype.assembleMarks=function(){var e=this.child,t=function(e){var t=[],n=dd(t);return e.children.forEach(function(t){return n(t,{source:e.name,name:null,transform:[]})}),t}(this.component.data.facetRoot),n=e.assembleLayoutSize(),r=e.assembleTitle(),i=e.assembleGroupStyle();return[S({name:this.getName("cell"),type:"group"},r?{title:r}:{},i?{style:i}:{},{from:{facet:this.assembleFacet()},sort:{field:this.headerSortFields("row").concat(this.headerSortFields("column")),order:this.headerSortOrder("row").concat(this.headerSortOrder("column"))}},t.length>0?{data:t}:{},n?{encode:{update:n}}:{},e.assembleGroup(function(e,t){if(e.component.selection&&de(e.component.selection).length){var n=u(e.getName("cell"));t.unshift({name:"facet",value:{},on:[{events:ji("mousemove","scope"),update:"isTuple(facet) ? facet : group("+n+").datum"}]})}return t}(this,[])))]},t.prototype.getMapping=function(){return this.facet},t}(Lc);function kd(e,t){for(var n=0,r=t;n<r.length;n++){var i=r[n],o=i.data;if(Ss(e)&&Ss(o)){var a=e.values,u=o.values;if(K(a,u))return i}else if(xs(e)&&xs(o)){if(e.url===o.url)return i}else if(Es(e)&&e.name===i.dataName)return i}return null}function Cd(e){var t=function(e,t){if(e.data||!e.parent){var n=kd(e.data,t);if(n)return n.data.format=oe({},e.data.format,n.data.format),n;var r=new _s(e.data);return t.push(r),r}return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main}(e,e.component.data.sources),n=e.component.data,r=n.outputNodes,i=n.outputNodeRefCounts,o=e.parent?e.parent.component.data.ancestorParse.clone():new cd;e.data&&e.data.format&&null===e.data.format.parse&&(o.parseNothing=!0),t=Ls.makeExplicit(t,e,o)||t,ml(e)&&(_c(e)||Ic(e))&&(t=new ed(t));var a=e.parent&&Ic(e.parent);(_c(e)||Dc(e))&&a&&(t=Xf.makeFromEncoding(t,e)||t),e.transforms.length>0&&(t=function(e,t,n){var r=0;return t.transforms.forEach(function(i){var o,a,u=void 0;if(Fo(i))a=e=new Lu(e,i),u="derived";else if(To(i))a=e=Ls.makeImplicitFromFilterTransform(e,i,n)||e,e=new Kf(e,t,i.filter);else if(Lo(i))a=e=Xf.makeFromTransform(e,i,t),u="number";else if(Uo(i))a=e=Us.makeFromTransform(e,i),u="date",void 0===n.getWithExplicit(i.field).value&&(e=new Ls(e,((o={})[i.field]=u,o)),n.set(i.field,u,!1));else if(Po(i))a=e=Is.makeFromTransform(e,i),u="number",ml(t)&&(e=new ed(e));else if(Do(i))a=e=ld.make(e,t,i,r++),u="derived";else if(zo(i))a=e=new Ps(e,i),u="number";else if(Mo(i))a=e=js.makeFromTransform(e,i),u="derived";else if(qo(i))a=e=new Jf(e,i),u="derived";else if(Io(i))a=e=new Qf(e,i),u="derived";else if(Ro(i))e=new fd(e,i);else{if(!jo(i))return void Ze(Ge.invalidTransformIgnored(i));a=e=sd.makeFromTransform(e,i),u="derived"}if(a&&void 0!==u)for(var s=0,c=de(a.producedFields());s<c.length;s++){var l=c[s];n.set(l,u,!1)}}),e}(t,e,o)),t=Ls.makeImplicitFromEncoding(t,e,o)||t,_c(e)&&(t=Zf.parseAll(t,e),t=$f.parseAll(t,e)),(_c(e)||Dc(e))&&(a||(t=Xf.makeFromEncoding(t,e)||t),t=Us.makeFromEncoding(t,e)||t,t=Lu.parseAllForSortIndex(t,e));var u=e.getName(ks),s=new ca(t,u,ks,i);if(r[u]=s,t=s,_c(e)){var c=Is.makeFromEncoding(t,e);c&&(t=c,ml(e)&&(t=new ed(t))),t=sd.makeFromEncoding(t,e)||t,t=js.makeFromEncoding(t,e)||t}var l=e.getName(ws),f=new ca(t,l,ws,i);r[l]=f,t=f;var d=null;if(Dc(e)){var p=e.getName("facet");t=function(e,t){var n=t.row,r=t.column;if(n&&r){for(var i=null,o=0,a=[n,r];o<a.length;o++){var u=a[o];if(ea(u.sort)){var s=u.sort,c=s.field,l=s.op;e=i=new Ps(e,{window:[{op:l,field:c,as:Ed(u,u.sort,{forAs:!0})}],groupby:[Zt(u)],frame:[null,null]})}}return i}return null}(t=Lu.parseAllForSortIndex(t,e),e.facet)||t,d=new Fs(t,e,p,f.getSource()),r[p]=d,t=d}return S({},e.component.data,{outputNodes:r,outputNodeRefCounts:i,raw:s,main:f,facetRoot:d,ancestorParse:o})}var Od=function(e){function t(t,n,r,i,o,a){return e.call(this,t,n,r,i,o,a)||this}return x(t,e),t.prototype.parseData=function(){this.component.data=Cd(this),this.children.forEach(function(e){e.parseData()})},t.prototype.parseSelection=function(){var e=this;this.component.selection={};for(var t=function(t){t.parseSelection(),de(t.component.selection).forEach(function(n){e.component.selection[n]=t.component.selection[n]})},n=0,r=this.children;n<r.length;n++){t(r[n])}},t.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},t.prototype.parseAxisAndHeader=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseAxisAndHeader()}},t.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},t.prototype.assembleSelectionSignals=function(){return this.children.forEach(function(e){return e.assembleSelectionSignals()}),[]},t.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Bu(this))},t.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},t.prototype.assembleMarks=function(){return this.children.map(function(e){var t=e.assembleTitle(),n=e.assembleGroupStyle(),r=e.assembleLayoutSize();return S({type:"group",name:e.getName("group")},t?{title:t}:{},n?{style:n}:{},r?{encode:{update:r}}:{},e.assembleGroup())})},t}(Fc),Nd=function(e){function t(t,n,r,i,o){var a=e.call(this,t,n,r,o,i,t.resolve)||this;return a.type="concat",t.resolve&&t.resolve.axis&&("shared"===t.resolve.axis.x||"shared"===t.resolve.axis.y)&&Ze(Ge.CONCAT_CANNOT_SHARE_AXIS),a.isVConcat=xo(t),a.children=(xo(t)?t.vconcat:t.hconcat).map(function(e,t){return Md(e,a,a.getName("concat_"+t),void 0,i,o,!1)}),a}return x(t,e),t.prototype.parseLayoutSize=function(){!function(e){md(e);var t=e.component.layoutSize,n=e.isVConcat?"width":"height";t.setWithExplicit(n,gd(e,n))}(this)},t.prototype.parseAxisGroup=function(){return null},t.prototype.assembleDefaultLayout=function(){return S({},this.isVConcat?{columns:1}:{},{bounds:"full",align:"each"})},t}(Od);var Ad=function(e){function t(t,n,r){void 0===t&&(t={}),void 0===n&&(n={}),void 0===r&&(r=!1);var i=e.call(this)||this;return i.explicit=t,i.implicit=n,i.mainExtracted=r,i}return x(t,e),t.prototype.clone=function(){return new t(me(this.explicit),me(this.implicit),this.mainExtracted)},t.prototype.hasAxisPart=function(e){return"axis"===e||("grid"===e||"title"===e?!!this.get(e):!(!1===(t=this.get(e))||null===t));var t},t}(ts);function Td(e,t,n,r,i){void 0===r&&(r="");for(var o=0,a=("band"===i?["axisBand"]:[]).concat(["x"===n?"axisX":"axisY","axis"+r.substr(0,1).toUpperCase()+r.substr(1),"axis"]);o<a.length;o++){var u=a[o];if(t[u]&&void 0!==t[u][e])return t[u][e]}}function _d(e){switch(e){case er:return"bottom";case tr:return"left"}throw new Error(Ge.INVALID_CHANNEL_FOR_AXIS)}function Dd(e){return qr.reduce(function(t,n){return e.component.scales[n]&&e.axis(n)&&(t[n]=[function(e,t){var n=t.axis(e),r=new Ad;Ve.forEach(function(i){var o=function(e,t,n,r){var i=r.fieldDef(n),o=function(e,t,n,r){if(void 0!==t.labelAngle)return(t.labelAngle%360+360)%360;var i=Td("labelAngle",e.config,n,_d(n),e.getScaleComponent(n).get("type"));return void 0!==i?(i%360+360)%360:n===er&&ee([Ft,zt],r.type)?270:void 0}(r,t,n,i);switch(e){case"scale":return r.scaleName(n);case"gridScale":return function(e,t){var n="x"===t?"y":"x";if(e.getScaleComponent(n))return e.scaleName(n)}(r,n);case"format":return of(i,t.format,r.config);case"grid":if(ei(r.fieldDef(n).bin))return!1;var a=r.getScaleComponent(n).get("type");return Oe(t.grid,function(e,t){return!bi(e)&&!$r(t.bin)}(a,i));case"labelAlign":return Oe(t.labelAlign,function(e,t){if(void 0!==e)return e=(e%360+360)%360,"top"===t||"bottom"===t?e%180==0?"center":0<e&&e<180?"top"===t?"right":"left":"top"===t?"left":"right":(e+90)%180==0?"center":90<=e&&e<270?"left"===t?"left":"right":"left"===t?"right":"left"}(o,_d(n)));case"labelAngle":return o;case"labelBaseline":return Oe(t.labelBaseline,function(e,t){if(void 0!==e)return"top"===t||"bottom"===t?e<=45||315<=e?"top"===t?"bottom":"top":135<=e&&e<=225?"top"===t?"top":"bottom":"middle":e<=45||315<=e||135<=e&&e<=225?"middle":45<=e&&e<=135?"left"===t?"top":"bottom":"left"===t?"bottom":"top"}(o,_d(n)));case"labelFlush":return function(e,t,n){return void 0!==n.labelFlush?n.labelFlush:!("x"!==t||!ee(["quantitative","temporal"],e.type))||void 0}(i,n,t);case"labelOverlap":var a=r.getScaleComponent(n).get("type");return function(e,t,n,r){return void 0!==t.labelOverlap?t.labelOverlap:"nominal"!==e.type?"log"!==r||"greedy":void 0}(i,t,0,a);case"orient":return Oe(t.orient,_d(n));case"tickCount":var a=r.getScaleComponent(n).get("type"),u=r.scaleName(n),s="x"===n?"width":"y"===n?"height":void 0,c=s?r.getSizeSignalRef(s):void 0;return Oe(t.tickCount,function(e,t,n,r,i,o){if(!bi(n)&&"log"!==n&&!ee(["month","hours","day","quarter"],t.timeUnit))return o.tickStep?{signal:"(domain('"+i+"')[1] - domain('"+i+"')[0]) / "+o.tickStep+" + 1"}:$r(t.bin)?{signal:"ceil("+r.signal+"/20)"}:{signal:"ceil("+r.signal+"/40)"}}(0,i,a,c,u,t));case"title":var l="x"===n?"x2":"y2",f=r.fieldDef(l);return Oe(t.title,Fd(r,n),ff([qt(i)],f?[qt(f)]:[]));case"values":return function(e,t,n,r){var i=e.values;if(i)return wn(n,i);if(n.type===Rt){if($r(n.bin)){var o=t.scaleDomain(r);if(o&&"unaggregated"!==o&&!Oi(o))return i;var a=t.getName(Zr(n.bin)+"_"+n.field+"_bins");return{signal:"sequence("+a+".start, "+a+".stop + "+a+".step, "+a+".step)"}}if(e.tickStep){var u=t.scaleName(r),s=e.tickStep;return{signal:"sequence(domain('"+u+"')[0], domain('"+u+"')[1] + "+s+", "+s+")"}}}}(t,r,i,n)}return Be(e)?t[e]:void 0}(i,n,e,t);if(void 0!==o){var a=function(e,t,n,r,i){switch(t){case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(e===Fd(r,i))return!0}return e===n[t]}(o,i,n,t,e),u=Td(i,t.config,e,r.get("orient"),t.getScaleComponent(e).get("type"));a||void 0===u?r.set(i,o,a):"grid"===i&&u&&r.set(i,u,!1)}});var i=n.encoding||{},o=Me.reduce(function(n,o){if(!r.hasAxisPart(o))return n;var a=mf(i[o]||{},t),u="labels"===o?function(e,t,n,r){var i=e.fieldDef(t)||("x"===t?e.fieldDef("x2"):"y"===t?e.fieldDef("y2"):void 0),o=e.axis(t),a=e.config,u={};if(Sn(i)){var s=e.getScaleComponent(t).get("type")===ri.UTC,c=cf("datum.value",i.timeUnit,o.format,a.axis.shortTimeLabels,null,s);c&&(u.text={signal:c})}return u=S({},u,n),0===de(u).length?void 0:u}(t,e,a,r.get("orient")):a;return void 0!==u&&de(u).length>0&&(n[o]={update:u}),n},{});de(o).length>0&&r.set("encode",o,!!n.encoding||void 0!==n.labelAngle);return r}(n,e)]),t},{})}var Rd={bottom:"top",top:"bottom",left:"right",right:"left"};function zd(e,t){if(!e)return t.map(function(e){return e.clone()});if(e.length===t.length){for(var n=e.length,r=0;r<n;r++){var i=e[r],o=t[r];if(!!i!=!!o)return;if(i&&o){var a=i.getWithExplicit("orient"),u=o.getWithExplicit("orient");if(a.explicit&&u.explicit&&a.value!==u.value)return;e[r]=Id(i,o)}}return e}}function Id(e,t){for(var n=function(n){var r=as(e.getWithExplicit(n),t.getWithExplicit(n),n,"axis",function(e,t){switch(n){case"title":return pf(e,t);case"gridScale":return{explicit:e.explicit,value:Oe(e.value,t.value)}}return os(e,t,n,"axis")});e.setWithExplicit(n,r)},r=0,i=Ve;r<i.length;r++){n(i[r])}return e}function Fd(e,t){var n="x"===t?"x2":"y2",r=e.fieldDef(t),i=e.fieldDef(n),o=r?r.title:void 0,a=i?i.title:void 0;return o&&a?df(o,a):o||(a||(void 0!==o?o:void 0!==a?a:void 0))}function Ld(e,t,n){var r=qn(e)?S({},e):{type:e},i=r.orient||tf("orient",r,n);return r.orient=function(e,t,n){switch(e){case Tn:case Ln:case jn:case _n:case zn:return}var r=t.x,i=t.y,o=t.x2,a=t.y2;switch(e){case Nn:if(Yt(r)&&ei(r.bin))return"vertical";if(Yt(i)&&ei(i.bin))return"horizontal";if(a||o){if(n)return n;if(!o&&Yt(r)&&r.type===Rt&&!$r(r.bin))return"horizontal";if(!a&&Yt(i)&&i.type===Rt&&!$r(i.bin))return"vertical"}case In:if(o&&a)return;case On:if(a)return Yt(i)&&ei(i.bin)?"horizontal":"vertical";if(o)return Yt(r)&&ei(r.bin)?"vertical":"horizontal";if(e===In){if(t.x&&!t.y)return"vertical";if(t.y&&!t.x)return"horizontal"}case An:case Dn:var u=Yt(t.x)&&en(t.x),s=Yt(t.y)&&en(t.y);if(u&&!s)return"tick"!==e?"horizontal":"vertical";if(!u&&s)return"tick"!==e?"vertical":"horizontal";if(u&&s){var c=t.x,l=t.y,f=c.type===It,d=l.type===It;return f&&!d?"tick"!==e?"vertical":"horizontal":!f&&d?"tick"!==e?"horizontal":"vertical":!c.aggregate&&l.aggregate?"tick"!==e?"vertical":"horizontal":c.aggregate&&!l.aggregate?"tick"!==e?"horizontal":"vertical":n||"vertical"}return n||void 0}return"vertical"}(r.type,t,i),void 0!==i&&i!==r.orient&&Ze(Ge.orientOverridden(r.orient,i)),void 0===Oe(r.opacity,tf("opacity",r,n))&&(r.opacity=function(e,t){if(ee([Tn,Dn,Ln,jn],e)&&!vf(t))return.7;return}(r.type,t)),void 0===r.filled&&(r.filled=function(e,t){var n=tf("filled",e,t),r=e.type;return Oe(n,r!==Tn&&r!==An&&r!==In)}(r,n)),void 0===(r.cursor||tf("cursor",r,n))&&(r.cursor=function(e,t,n){if(t.href||e.href||tf("href",e,n))return"pointer";return e.cursor}(r,t,n)),r}var jd=function(e){function t(t,n,r,i,o,a,u){void 0===i&&(i={});var s=e.call(this,t,n,r,a,o,void 0)||this;s.fit=u,s.type="unit",s.specifiedScales={},s.specifiedAxes={},s.specifiedLegends={},s.specifiedProjection={},s.selection={},s.children=[],s.initSize(S({},i,t.width?{width:t.width}:{},t.height?{height:t.height}:{}));var c=qn(t.mark)?t.mark.type:t.mark,l=s.encoding=bf(function(e,t){return Sd(e,t)}(t.encoding||{},o),c);return s.markDef=Ld(t.mark,l,a),s.stack=ao(c,l,s.config.stack),s.specifiedScales=s.initScales(c,l),s.specifiedAxes=s.initAxes(l),s.specifiedLegends=s.initLegend(l),s.specifiedProjection=t.projection,s.selection=t.selection,s}return x(t,e),Object.defineProperty(t.prototype,"hasProjection",{get:function(){var e=this.encoding,t=this.mark===Fn,n=e&&_r.some(function(t){return Yt(e[t])});return t||n},enumerable:!0,configurable:!0}),t.prototype.scaleDomain=function(e){var t=this.specifiedScales[e];return t?t.domain:void 0},t.prototype.axis=function(e){return this.specifiedAxes[e]},t.prototype.legend=function(e){return this.specifiedLegends[e]},t.prototype.initScales=function(e,t){return Gr.reduce(function(e,n){var r,i,o=t[n];return Yt(o)?(r=o,i=o.scale):Wt(o)?(r=o.condition,i=o.condition.scale):"x"===n?r=hn(t.x2):"y"===n&&(r=hn(t.y2)),r&&(e[n]=i||{}),e},{})},t.prototype.initAxes=function(e){return[er,tr].reduce(function(t,n){var r=e[n];if(Yt(r)||n===er&&Yt(e.x2)||n===tr&&Yt(e.y2)){var i=Yt(r)?r.axis:null;null!==i&&(t[n]=S({},i))}return t},{})},t.prototype.initLegend=function(e){return Wr.reduce(function(t,n){var r=e[n];if(r){var i=Yt(r)?r.legend:Wt(r)?r.condition.legend:null;null!==i&&!1!==i&&(t[n]=S({},i))}return t},{})},t.prototype.parseData=function(){this.component.data=Cd(this)},t.prototype.parseLayoutSize=function(){!function(e){var t=e.component.layoutSize;if(!t.explicit.width){var n=vd(e,"width");t.set("width",n,!1)}if(!t.explicit.height){var r=vd(e,"height");t.set("height",r,!1)}}(this)},t.prototype.parseSelection=function(){this.component.selection=function(e,t){var n={},r=e.config.selection;t&&(t=me(t));var i=function(i){if(!t.hasOwnProperty(i))return"continue";var o=t[i],u=r[o.type];for(var s in u)"encodings"===s&&o.fields||"fields"===s&&o.encodings||("mark"===s&&(o[s]=S({},u[s],o[s])),void 0!==o[s]&&!0!==o[s]||(o[s]=u[s]||o[s]));i=ve(i);var c=n[i]=S({},o,{name:i,events:a(o.on)?ji(o.on,"scope"):o.on});il(c,function(t){t.parse&&t.parse(e,o,c)})};for(var o in t)i(o);return n}(this,this.selection)},t.prototype.parseMarkGroup=function(){this.component.mark=id(this)},t.prototype.parseAxisAndHeader=function(){this.component.axes=Dd(this)},t.prototype.assembleSelectionTopLevelSignals=function(e){return n=e,r=!1,dl(t=this,function(e,i){var o=e.name,a=u(o+ol);n.filter(function(e){return e.name===o}).length||n.push({name:e.name,update:cl+"("+a+("global"===e.resolve?")":", "+u(e.resolve)+")")}),r=!0,i.topLevelSignals&&(n=i.topLevelSignals(t,e,n)),il(e,function(r){r.topLevelSignals&&(n=r.topLevelSignals(t,e,n))})}),r&&(n.filter(function(e){return"unit"===e.name}).length||n.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})),n;var t,n,r},t.prototype.assembleSelectionSignals=function(){return t=[],dl(e=this,function(n,r){var i=n.name,o=r.modifyExpr(e,n);t.push.apply(t,r.signals(e,n)),il(n,function(r){r.signals&&(t=r.signals(e,n,t)),r.modifyExpr&&(o=r.modifyExpr(e,n,o))}),t.push({name:i+ul,on:[{events:{signal:i+al},update:"modify("+u(n.name+ol)+", "+o+")"}]})}),t;var e,t},t.prototype.assembleSelectionData=function(e){return function(e,t){return dl(e,function(e){t.filter(function(t){return t.name===e.name+ol}).length||t.push({name:e.name+ol})}),t}(this,e)},t.prototype.assembleLayout=function(){return null},t.prototype.assembleLayoutSignals=function(){return Bu(this)},t.prototype.assembleMarks=function(){var e=this.component.mark||[];return this.parent&&Ic(this.parent)||(e=ll(this,e)),e.map(this.correctDataNames)},t.prototype.assembleLayoutSize=function(){return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},t.prototype.getMapping=function(){return this.encoding},t.prototype.toSpec=function(e,t){var n,r=me(this.encoding);return n={mark:this.markDef,encoding:r},e||(n.config=me(this.config)),t||(n.data=me(this.data)),n},Object.defineProperty(t.prototype,"mark",{get:function(){return this.markDef.type},enumerable:!0,configurable:!0}),t.prototype.channelHasField=function(e){return gf(this.encoding,e)},t.prototype.fieldDef=function(e){return hn(this.encoding[e])},t}(Lc),Ud=function(e){function t(n,r,i,o,a,u,s){var c=e.call(this,n,r,i,u,a,n.resolve)||this;c.type="layer";var l=S({},o,n.width?{width:n.width}:{},n.height?{height:n.height}:{});return c.initSize(l),c.children=n.layer.map(function(e,n){if(vo(e))return new t(e,c,c.getName("layer_"+n),l,a,u,s);if(go(e))return new jd(e,c,c.getName("layer_"+n),l,a,u,s);throw new Error(Ge.INVALID_SPEC)}),c}return x(t,e),t.prototype.parseData=function(){this.component.data=Cd(this);for(var e=0,t=this.children;e<t.length;e++){t[e].parseData()}},t.prototype.parseLayoutSize=function(){pd(this)},t.prototype.parseSelection=function(){var e=this;this.component.selection={};for(var t=function(t){t.parseSelection(),de(t.component.selection).forEach(function(n){e.component.selection[n]=t.component.selection[n]})},n=0,r=this.children;n<r.length;n++){t(r[n])}},t.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},t.prototype.parseAxisAndHeader=function(){!function(e){for(var t=e.component,n=t.axes,r=t.resolve,i={top:0,bottom:0,right:0,left:0},o=0,a=e.children;o<a.length;o++){(h=a[o]).parseAxisAndHeader();for(var u=0,s=de(h.component.axes);u<s.length;u++){var c=s[u];r.axis[c]=es(e.component.resolve,c),"shared"===r.axis[c]&&(n[c]=zd(n[c],h.component.axes[c]),n[c]||(r.axis[c]="independent",delete n[c]))}}for(var l=0,f=[er,tr];l<f.length;l++){c=f[l];for(var d=0,p=e.children;d<p.length;d++){var h;if((h=p[d]).component.axes[c]){if("independent"===r.axis[c]){n[c]=(n[c]||[]).concat(h.component.axes[c]);for(var m=0,g=h.component.axes[c];m<g.length;m++){var v=g[m],y=v.getWithExplicit("orient"),b=y.value,x=y.explicit;if(i[b]>0&&!x){var S=Rd[b];i[b]>i[S]&&v.set("orient",S,!1)}i[b]++}}delete h.component.axes[c]}}}}(this)},t.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},t.prototype.assembleSelectionSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleSelectionSignals())},[])},t.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Bu(this))},t.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},t.prototype.assembleTitle=function(){var t=e.prototype.assembleTitle.call(this);if(t)return t;for(var n=0,r=this.children;n<r.length;n++){if(t=r[n].assembleTitle())return t}},t.prototype.assembleLayout=function(){return null},t.prototype.assembleMarks=function(){return function(e,t){for(var n=0,r=e.children;n<r.length;n++){var i=r[n];_c(i)&&(t=ll(i,t))}return t}(this,ie(this.children.map(function(e){return e.assembleMarks()})))},t.prototype.assembleLegends=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLegends())},vs(this))},t}(Fc),Pd=function(e){function t(t,n,r,i,o){var a=e.call(this,t,n,r,o,i,t.resolve)||this;return a.type="repeat",t.resolve&&t.resolve.axis&&("shared"===t.resolve.axis.x||"shared"===t.resolve.axis.y)&&Ze(Ge.REPEAT_CANNOT_SHARE_AXIS),a.repeat=t.repeat,a.children=a._initChildren(t,a.repeat,i,o),a}return x(t,e),t.prototype._initChildren=function(e,t,n,r){for(var i=[],o=t.row||[n?n.row:null],a=t.column||[n?n.column:null],u=0,s=o;u<s.length;u++)for(var c=s[u],l=0,f=a;l<f.length;l++){var d=f[l],p=(c?"_"+c:"")+(d?"_"+d:""),h={row:c,column:d};i.push(Md(e.spec,this,this.getName("child"+p),void 0,h,r,!1))}return i},t.prototype.parseLayoutSize=function(){hd(this)},t.prototype.assembleDefaultLayout=function(){return{columns:this.repeat&&this.repeat.column?this.repeat.column.length:1,bounds:"full",align:"all"}},t}(Od);function Md(e,t,n,r,i,o,a){if(mo(e))return new wd(e,t,n,i,o);if(vo(e))return new Ud(e,t,n,r,i,o,a);if(go(e))return new jd(e,t,n,r,i,o,a);if(yo(e))return new Pd(e,t,n,i,o);if(bo(e))return new Nd(e,t,n,i,o);throw new Error(Ge.INVALID_SPEC)}function qd(e,t){if(mo(e)||yo(e))return function(e,t){var n=e.spec,r=E(e,["spec"]);return S({},r,{spec:qd(n,t)})}(e,t);if(vo(e))return function(e,t){var n=e.layer,r=E(e,["layer"]);return S({},r,{layer:n.map(function(e){return qd(e,t)})})}(e,t);if(go(e))return function(e,t){if(e.encoding){var n=e.encoding,r=e.transform,i=E(e,["encoding","transform"]),o=yf(n,t),a=o.bins,u=o.timeUnits,s=o.aggregate,c=o.groupby,l=o.encoding;return S({transform:(r||[]).concat(a,u,s.length?[{aggregate:s,groupby:c}]:[])},i,{encoding:l})}return e}(e,t);if(xo(e))return function(e,t){var n=e.vconcat,r=E(e,["vconcat"]);return S({},r,{vconcat:n.map(function(e){return qd(e,t)})})}(e,t);if(So(e))return function(e,t){var n=e.hconcat,r=E(e,["hconcat"]);return S({},r,{hconcat:n.map(function(e){return qd(e,t)})})}(e,t);throw new Error(Ge.INVALID_SPEC)}var Hd={text:["text"],line:["x","y"],trail:["x","y"],area:["x","y"]},Wd={bar:y(["row","column","x","y","size","color","fill","stroke","detail"]),line:y(["row","column","x","y","color","fill","stroke","color","detail"]),trail:y(["row","column","x","y","color","fill","stroke","color","detail","size"]),area:y(["row","column","x","y","color","fill","stroke","detail"]),tick:y(["row","column","x","y","color","fill","stroke","detail"]),circle:y(["row","column","x","y","color","fill","stroke","size","detail"]),square:y(["row","column","x","y","color","fill","stroke","size","detail"]),point:y(["row","column","x","y","color","fill","stroke","size","detail","shape"]),geoshape:y(["row","column","color","fill","stroke","detail","shape"]),text:y(["row","column","size","color","fill","stroke","text"])};var Bd=Object.freeze({DEFAULT_REQUIRED_CHANNEL_MAP:Hd,DEFAULT_SUPPORTED_CHANNEL_TYPE:Wd,getEncodingMappingError:function(e,t,n){void 0===t&&(t=Hd),void 0===n&&(n=Wd);var r=qn(e.mark)?e.mark.type:e.mark,i=e.encoding,o=t[r],a=n[r];for(var u in o)if(!(o[u]in i))return'Missing encoding channel "'+o[u]+'" for mark "'+r+'"';for(var s in i)if(!a[s])return'Encoding channel "'+s+'" is not supported by mark type "'+r+'"';return r!==Nn||i.x||i.y?null:"Missing both x and y for bar"}}),Yd="3.0.0-rc10";e.aggregate=Pe,e.axis=Ke,e.bin=ii,e.channel=Jr,e.compositeMark=Gf,e.config=yc,e.data=Cs,e.datetime=at,e.encoding=kf,e.facet=ct,e.fieldDef=Cn,e.header=$o,e.legend=$u,e.mark=$n,e.scale=Li,e.sort=ua,e.spec=ko,e.stack=uo,e.timeUnit=_t,e.transform=Wo,e.type=Ut,e.util=Te,e.validate=Bd,e.version=Yd,e.compile=function(e,t){var n;void 0===t&&(t={}),t.logger&&(n=t.logger,Je=n),t.fieldTitle&&un(t.fieldTitle);try{var r=dc(oe({},t.config,e.config)),i=so(e,r),o=function(e,t,n){void 0===n&&(n=!0);var r=S({type:"pad"},Oo(t),Oo(e));return"fit"===r.type&&(n||(Ze(Ge.FIT_NON_SINGLE),r.type="pad")),r}(e.autosize,r.autosize,vo(i)||go(i)),a=Md(i,null,"",void 0,void 0,r,"fit"===o.type);return a.parse(),function(e){Ts(e.sources);for(var t=0,n=0,r=0;r<Ks&&$s(e);r++)t++;for(e.sources.map(Bs),r=0;r<Ks&&$s(e);r++)n++;Ts(e.sources),Math.max(t,n)===Ks&&Ze("Maximum optimization runs("+Ks+") reached.")}(a.component.data),function(e,t,n,r){void 0===n&&(n={});var i=e.config?gc(e.config):void 0,o=[].concat(e.assembleSelectionData([]),function(e,t){var n=[],r=dd(n),i=0;e.sources.forEach(function(e){e.hasName()||(e.dataName="source_"+i++);var t=e.assemble();r(e,t)}),n.forEach(function(e){0===e.transform.length&&delete e.transform});for(var o=0,a=0;a<n.length;a++)0!==((h=n[a]).transform||[]).length||h.source||n.splice(o++,0,n.splice(a,1)[0]);for(var u=0,s=n;u<s.length;u++)for(var c=0,l=(h=s[u]).transform||[];c<l.length;c++){var f=l[c];"lookup"===f.type&&(f.from=e.outputNodes[f.from].getSource())}for(var d=0,p=n;d<p.length;d++){var h;(h=p[d]).name in t&&(h.values=t[h.name])}return n}(e.component.data,n)),a=e.assembleProjections(),u=e.assembleTitle(),s=e.assembleGroupStyle(),c=e.assembleLayoutSignals();return c=c.filter(function(e){return"width"!==e.name&&"height"!==e.name||void 0===e.value||(t[e.name]=+e.value,!1)}),{spec:S({$schema:"https://vega.github.io/schema/vega/v4.json"},e.description?{description:e.description}:{},t,u?{title:u}:{},s?{style:s}:{},{data:o},a.length>0?{projections:a}:{},e.assembleGroup(c.concat(e.assembleSelectionTopLevelSignals([]))),i?{config:i}:{},r?{usermeta:r}:{})}}(a,function(e,t,n){return S({autosize:1===de(n).length&&n.type?n.type:n},Ao(t),Ao(e))}(e,r,o),e.datasets,e.usermeta)}finally{t.logger&&(Je=Qe),t.fieldTitle&&sn()}},e.extractTransforms=qd,Object.defineProperty(e,"__esModule",{value:!0})});